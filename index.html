<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª â€“ Ø§Ù„Ù…ØµØ±ÙÙŠ Ù„Ù„Ù…Ø¹Ù„Ù…Ø© Ø³Ø§Ø±Ø© Ø­Ù‚ÙˆÙŠ</title>

<style>
:root{
  --navy:#00205B;--rajhi:#0055A4;--sky:#EAF3FB;--sky2:#CFE6F7;--beige:#FAF9F7;
  --green:#2e7d32;--red:#b00020;--text:#1b1f23;
}
.whatsapp-btn{
  background:#25D366 !important;
  color:#fff !important;
  font-weight:700;
}
.whatsapp-btn:hover{ background:#1ebe5d !important; }

*{box-sizing:border-box;font-family:Tahoma,Arial,sans-serif}
body{margin:0;background:var(--beige);color:var(--text)}
.hidden{display:none}

/* Header + Footer Ø«Ø§Ø¨ØªÙŠÙ† */
.topbar{
  position:sticky;top:0;z-index:2000;
  background:linear-gradient(90deg,var(--navy),var(--rajhi));
  color:#fff;padding:12px 14px;display:flex;align-items:center;gap:12px;
}
.topbar .titles{flex:1;text-align:center;line-height:1.35}
.topbar .t1{font-weight:800;font-size:16px}
.topbar .t2{font-size:12px;opacity:.95}
.logo{height:56px;width:auto;background:rgba(255,255,255,.78);border-radius:12px;padding:6px}
.footer{text-align:center;padding:14px 12px;color:var(--navy);font-weight:700}

.container{max-width:980px;margin:14px auto;padding:0 12px}
.card{background:#fff;border-radius:14px;padding:14px;margin:10px 0;box-shadow:0 8px 18px rgba(0,0,0,.06)}
.card.soft{background:var(--sky)}
.row{display:flex;gap:10px;flex-wrap:wrap}
.col{flex:1;min-width:160px}
input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #ccc;font-size:14px}
button{border:0;border-radius:10px;padding:10px 12px;cursor:pointer;font-size:14px}
.btn{background:var(--rajhi);color:#fff}
.btn2{background:var(--sky2);color:#003}
.btn3{background:#eef6fb;color:#003}
.btnRed{background:var(--red);color:#fff}

.tabs{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:10px 0}
.tab{background:#e9f4fb;color:#003;padding:8px 12px;border-radius:999px;cursor:pointer;font-size:14px}
.tab.active{background:var(--rajhi);color:#fff}

.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
@media(max-width:760px){.grid2{grid-template-columns:1fr}}

.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px}
.badge.on{background:#dff4e3;color:var(--green)}
.badge.off{background:#fde2e2;color:var(--red)}
.small{font-size:12px;color:#666}
hr{border:0;border-top:1px solid #eee;margin:10px 0}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:18px;z-index:9999}
.modalBox{background:#fff;border-radius:16px;max-width:680px;width:100%;padding:16px;text-align:center}
.modalBox h3{margin:0 0 8px 0;color:var(--navy)}
.modalBox p{margin:0 0 12px 0;font-size:15px;line-height:1.7;white-space:pre-line}
.modalActions{display:flex;gap:10px;flex-wrap:wrap}
.modalActions a,.modalActions button{flex:1;text-decoration:none}

/* Start overlay */
#startOverlay{position:fixed;inset:0;background:#0a2d66;display:flex;align-items:center;justify-content:center;padding:18px;z-index:9998}
.startBox{max-width:560px;width:100%;background:#fff;border-radius:18px;padding:18px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.pill{display:inline-block;background:#e9f4fb;color:#003;padding:6px 10px;border-radius:999px;font-size:12px;margin-bottom:10px}

/* Statement */
.tableWrap{overflow:auto;border-radius:12px;background:#f7fbff;border:1px solid #e6eef7}
table{width:100%;border-collapse:collapse;min-width:740px}
th,td{padding:10px;border-bottom:1px solid #e6eef7;text-align:center;font-size:13px;white-space:nowrap}
th{background:#eef6ff;color:#0b2a66}
tr:last-child td{border-bottom:none}

/* Stats */
.statsBox{
  display:flex; gap:10px; flex-wrap:wrap;
}
.statCard{
  flex:1; min-width:180px;
  background:#f7fbff;border:1px solid #e6eef7;border-radius:14px;padding:12px;
}
.statCard b{color:var(--navy)}
</style>
</head>

<body>

<div class="topbar">
  <img class="logo" src="school-logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©">
  <div class="titles">
    <div class="t1">Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª â€“ Ø§Ù„Ù…ØµØ±ÙÙŠ Ù„Ù„Ù…Ø¹Ù„Ù…Ø© Ø³Ø§Ø±Ø© Ø­Ù‚ÙˆÙŠ</div>
    <div class="t2">Ù…Ø¯Ø±Ø³Ø© Ø±ÙˆØ§Ø¯ Ø§Ù„Ø´Ø±Ù‚ Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</div>
  </div>
  <div style="width:56px"></div>
</div>

<audio id="welcomeMp3" preload="auto" src="welcome.mp3"></audio>
<audio id="welcomeM4a" preload="auto" src="welcome.m4a"></audio>

<div id="startOverlay">
  <div class="startBox">
    <div class="pill" id="connPill">...Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù†Ø¸Ø§Ù…...</div>
    <h3>Ù‡Ù„Ø§ ÙˆØ§Ù„Ù„Ù‡! ğŸ‘‹</h3>
    <p id="startP">Ø¬Ø§Ù‡Ø²ÙŠÙ† Ù†Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙ†Ø§ ÙÙŠ Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§ØªØŸ<br>Ø§Ø¶ØºØ· Ø²Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆÙ†Ù†Ø·Ù„Ù‚ ğŸš€</p>
    <button class="btn" onclick="startApp()">Ø§Ø¨Ø¯Ø£</button>
    <div class="small" id="connNote" style="margin-top:8px"></div>
  </div>
</div>

<div id="modal" class="modal">
  <div class="modalBox">
    <h3 id="mTitle"></h3>
    <p id="mBody"></p>
    <div class="modalActions" id="mActions">
      <button class="btn" onclick="closeModal()">Ù…ÙˆØ§ÙÙ‚</button>
    </div>
  </div>
</div>

<!-- ===== ØµÙØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù…Ø© ===== -->
<div id="teacherLoginPage" class="hidden">
  <div class="container">
    <div class="card">
      <h3 style="margin:0 0 10px 0;color:var(--navy)">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…Ø©</h3>
      <input id="tu" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
      <input id="tp" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
      <div class="row">
        <button class="btn col" onclick="teacherLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <button class="btn3 col" onclick="forgotTeacher()">Ù†Ø³ÙŠØª Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ</button>
      </div>
      <div class="small">Ø§Ù„Ø¯Ø®ÙˆÙ„: teacher / 12345</div>
    </div>
  </div>
</div>

<div id="classesPage" class="hidden">
  <div class="container">

    <!-- ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© ===== -->
    <div class="card soft">
      <h3 style="margin:0 0 8px 0;color:var(--navy)">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹ (WhatsApp Business)</h3>
      <div class="row">
        <label class="col small" style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" id="autoWA" checked>
          ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙˆØ±ÙŠ Ø¨Ù†Ù‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø© (ÙŠÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø²Ù†Ø³ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©)
        </label>

        <label class="col small" style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" id="copyToTeacher" checked>
          Ø¥Ø±Ø³Ø§Ù„ Ù†Ø³Ø®Ø© Ù„Ù„Ù…Ø¹Ù„Ù…Ø© (ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨)
        </label>
      </div>

      <div class="small" style="margin-top:6px">
        * Ø¨Ø¹Ø¯ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø³ÙŠÙØªØ­ WhatsApp Business ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø© Ø¬Ø§Ù‡Ø²Ø© â€” ÙÙ‚Ø· Ø§Ø¶ØºØ·ÙŠ Ø¥Ø±Ø³Ø§Ù„ âœ…
      </div>
    </div>

    <!-- ===== Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„Ù…Ø¹Ù„Ù…Ø© ===== -->
    <div class="card">
      <h3 style="margin:0 0 8px 0;color:var(--navy)">Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø¹Ø§Ù…Ø©</h3>
      <div class="statsBox">
        <div class="statCard"><b>Ø§Ù„ÙŠÙˆÙ…</b><div class="small" id="stToday">â€”</div></div>
        <div class="statCard"><b>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</b><div class="small" id="stWeek">â€”</div></div>
        <div class="statCard"><b>Ø§Ù„Ø´Ù‡Ø±</b><div class="small" id="stMonth">â€”</div></div>
        <div class="statCard"><b>Ø£Ø¹Ù„Ù‰ Ù…Ø¨Ù„Øº</b><div class="small" id="stTop">â€”</div></div>
      </div>
      <div class="small" style="margin-top:8px;color:#666">* ØªÙØ­Ø³Ø¨ Ù…Ù† Ø¢Ø®Ø± 500 Ø¹Ù…Ù„ÙŠØ©.</div>
      <button class="btn2" style="margin-top:10px" onclick="refreshTeacherStats()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª</button>
    </div>

    <!-- Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© -->
    <div class="card soft" id="dailyOpsCard">
      <h3 style="margin:0 0 8px 0;color:var(--navy)">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>

      <div class="row">
        <div class="col">
          <div class="small">Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
          <input id="dailyDate" type="date">
        </div>

        <div class="col" style="align-self:flex-end">
          <button class="btn2" onclick="loadDailyOps()">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
        </div>

        <div class="col" style="align-self:flex-end">
          <button class="btn whatsapp-btn" onclick="sendDailyOpsWhats()">ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø£Ù…Ù‡Ø§Øª</button>
        </div>
      </div>

      <div class="small" style="margin-top:8px">
        * Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ© ØªÙØ³Ø¬ÙÙ‘Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (Ø·Ø§Ù„Ø¨/Ù…Ø¹Ù„Ù…Ø©) ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®.
      </div>

      <div id="dailyOpsList" style="margin-top:10px"></div>
    </div>

    <div class="card soft">
      <div class="row">
        <div class="col">
          <div class="small">Ø¥Ø¶Ø§ÙØ© ÙØµÙ„</div>
          <input id="newClassName" placeholder="Ù…Ø«Ø§Ù„: Ø®Ø§Ù…Ø³ Ø¨Ù†Ø§Øª">
        </div>
        <div class="col" style="align-self:flex-end">
          <button class="btn2" onclick="addClass()">Ø¥Ø¶Ø§ÙØ© ÙØµÙ„</button>
        </div>
      </div>
      <hr>
      <div class="row">
        <button class="btn2 col" onclick="renameClass()">ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„ÙØµÙ„</button>
        <button class="btnRed col" onclick="deleteClassMove()">Ø­Ø°Ù ÙØµÙ„ + Ù†Ù‚Ù„ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
        <button class="btn3 col" onclick="syncStudentsToClasses()">ØªØ«Ø¨ÙŠØª Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
        <button class="btn3 col" onclick="toggleForgotPinForAll()">ØªØ¹Ø·ÙŠÙ„/ØªÙØ¹ÙŠÙ„ Ù†Ø³ÙŠØª Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ</button>
      </div>
      <div class="small">Ø¥Ø°Ø§ ÙƒØ«Ø±Øª Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø§Ø³ØªØ¶Ø§ÙØ© ÙˆØªØ®Ø±Ø¨Ø·Øª Ø§Ù„ÙØµÙˆÙ„ØŒ Ø²Ø± "ØªØ«Ø¨ÙŠØª Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨" ÙŠØ±Ø¬Ø¹ ÙƒÙ„ Ø·Ø§Ù„Ø¨ Ù„ÙØµÙ„Ù‡ Ø§Ù„ØµØ­ÙŠØ­.</div>
    </div>

    <div class="tabs" id="classTabs"></div>

    <div class="card">
      <button class="btn2" onclick="openClassPage()">Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙØµÙ„</button>
      <button class="btn3" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

  </div>
</div>

<div id="classPage" class="hidden">
  <div class="container">

    <div class="card soft">
      <div class="row">
        <div class="col">
          <div class="small">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</div>
          <input id="newStudentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨/Ø§Ù„Ø·Ø§Ù„Ø¨Ø©">
        </div>
        <div class="col" style="align-self:flex-end">
          <button class="btn2" onclick="addStudent()">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
        </div>
      </div>

      <hr>

      <div class="row">
        <div class="col">
          <div class="small">Ù…Ø¨Ù„Øº Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ù„Ù„ÙƒÙ„</div>
          <input id="bulkAmount" type="number" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 10">
        </div>
        <div class="col" style="align-self:flex-end">
          <button class="btn" onclick="depositAll()">Ø¥ÙŠØ¯Ø§Ø¹ Ù„Ù„ÙƒÙ„</button>
        </div>

        <div class="col">
          <div class="small">Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„ÙƒÙ„</div>
          <input id="bulkWithdrawAmount" type="number" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 5">
        </div>
        <div class="col" style="align-self:flex-end">
          <button class="btnRed" onclick="withdrawAll()">Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„ÙƒÙ„</button>
        </div>
      </div>

      <hr>

      <div class="row">
        <div class="col">
          <div class="small">Ø·Ø§Ù„Ø¨ Ù…Ø­Ø¯Ø¯</div>
          <select id="pickStudent"></select>
        </div>
        <div class="col">
          <div class="small">Ø§Ù„Ù…Ø¨Ù„Øº</div>
          <input id="pickAmount" type="number" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 5">
        </div>
        <div class="col" style="align-self:flex-end">
          <button class="btn2" onclick="depositToStudent()">Ø¥ÙŠØ¯Ø§Ø¹ Ù„Ø·Ø§Ù„Ø¨</button>
        </div>
        <div class="col" style="align-self:flex-end">
          <button class="btnRed" onclick="withdrawFromStudent()">Ø³Ø­Ø¨ Ù…Ù† Ø·Ø§Ù„Ø¨</button>
        </div>
      </div>

      <hr>

      <div class="row">
        <div class="col">
          <div class="small">Ø³Ø¨Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</div>
          <select id="reasonTeacher"></select>
          <input id="reasonOtherTeacher" class="hidden" placeholder="Ø£Ø®Ø±Ù‰: Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¨Ø¨ Ù‡Ù†Ø§..." style="margin-top:8px">
        </div>
      </div>

    </div>

    <div id="studentsGrid" class="grid2"></div>

    <div class="card">
      <button class="btn3" onclick="backToClasses()">Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙØµÙˆÙ„</button>
    </div>

  </div>
</div>

<!-- ===== ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ (ÙˆØ¶Ø¹ Ø§Ù„Ø·Ù„Ø§Ø¨) ===== -->
<div id="studentLoginPage" class="hidden">
  <div class="container">
    <div class="card">
      <h3 style="margin:0 0 10px 0;color:var(--navy)" id="stuLoginTitle">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
      <div id="stuLocked" class="small hidden" style="color:var(--red);font-weight:700"></div>

      <input id="stuName" readonly>
      <input id="stuPin" type="password" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ (PIN)">

      <div class="small" style="margin:8px 0;">
        <a href="javascript:void(0)" onclick="forgotStudentPin()" style="color:#0055A4;font-weight:700">Ù†Ø³ÙŠØª Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠØŸ</a>
      </div>

      <button class="btn" onclick="studentLogin()">Ø¯Ø®ÙˆÙ„</button>
      <button class="btn3" onclick="backToClass()">Ø±Ø¬ÙˆØ¹</button>
    </div>
  </div>
</div>

<div id="studentAccountPage" class="hidden">
  <div class="container">
    <div class="card soft">

      <!-- Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ -->
      <div class="card" style="margin:0 0 10px 0">
        <h3 style="margin:0 0 8px 0;color:var(--navy)">Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
        <div class="statsBox">
          <div class="statCard"><b>Ø§Ù„ÙŠÙˆÙ…</b><div class="small" id="stuToday">â€”</div></div>
          <div class="statCard"><b>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</b><div class="small" id="stuWeek">â€”</div></div>
          <div class="statCard"><b>Ø§Ù„Ø´Ù‡Ø±</b><div class="small" id="stuMonth">â€”</div></div>
          <div class="statCard"><b>Ø£Ø¹Ù„Ù‰ Ù…Ø¨Ù„Øº</b><div class="small" id="stuTop">â€”</div></div>
        </div>
      </div>

      <h3 style="margin:0 0 10px 0;color:var(--navy)" id="studentHeader"></h3>
      <div class="row">
        <div class="col"><div class="small">Ø§Ù„Ø­Ø§Ù„Ø©</div><div id="statusBadge" class="badge"></div></div>
        <div class="col"><div class="small">Ø§Ù„Ø±ØµÙŠØ¯</div><div style="font-size:26px;font-weight:800;color:var(--navy)"><span id="studentBalance">0</span> Ø±.Ø³</div></div>
        <div class="col"><div class="small">ØªØ§Ø±ÙŠØ® ÙØªØ­ Ø§Ù„Ø­Ø³Ø§Ø¨</div><div id="openedAt" class="small">â€”</div></div>
      </div>

      <hr>

      <div class="row">
        <div class="col"><div class="small">Ù…Ù† ØªØ§Ø±ÙŠØ®</div><input id="fromDate" type="date"></div>
        <div class="col"><div class="small">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</div><input id="toDate" type="date"></div>
        <div class="col" style="align-self:flex-end"><button class="btn2" onclick="showStatement()">Ø¹Ø±Ø¶ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨</button></div>
      </div>

      <div class="tableWrap" style="margin-top:10px">
        <table>
          <thead><tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th><th>Ø§Ù„Ø³Ø¨Ø¨</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th></tr></thead>
          <tbody id="stmtRows"></tbody>
        </table>
      </div>

      <hr>

      <div class="row">
        <div class="col">
          <div class="small">Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</div>
          <select id="op">
            <option value="deposit">Ø¥ÙŠØ¯Ø§Ø¹</option>
            <option value="withdraw">Ø³Ø­Ø¨</option>
            <option value="transfer">ØªØ­ÙˆÙŠÙ„</option>
          </select>
        </div>

        <div class="col">
          <div class="small">Ø§Ù„Ø³Ø¨Ø¨</div>
          <select id="reasonStudent"></select>
          <input id="reasonOtherStudent" class="hidden" placeholder="Ø£Ø®Ø±Ù‰: Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¨Ø¨ Ù‡Ù†Ø§..." style="margin-top:8px">
        </div>

        <div class="col"><div class="small">Ø§Ù„Ù…Ø¨Ù„Øº</div><input id="amt" type="number" step="0.01"></div>
        <div class="col"><div class="small">ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰</div><select id="transferTo"></select></div>
      </div>

      <div class="row">
        <button class="btn col" onclick="executeOp()">ØªÙ†ÙÙŠØ°</button>
        <button class="btn3 col" onclick="backToClass()">Ø±Ø¬ÙˆØ¹</button>
      </div>

    </div>
  </div>
</div>

<div class="footer">Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù„ØºØ© Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡ âœ¨</div>

<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

<script>
// ================== (Ø§Ø­ØªØ±Ø§ÙÙŠ) Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„: Ù…Ø¹Ù„Ù…Ø© / Ø·Ø§Ù„Ø¨ ==================
const urlParams = new URLSearchParams(window.location.search);
const APP_MODE = (urlParams.get("mode") || "teacher").toLowerCase(); // teacher | student
const IS_STUDENT_ENTRY = (APP_MODE === "student");

// ================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ø±Ø³Ù…ÙŠØ© + ØªØ­Ø°ÙŠØ± + ØªÙ„Ù‚Ø§Ø¦ÙŠØ©) ==================
const TEACHER_BANK_TITLE = "Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª â€“ Ø§Ù„Ù…ØµØ±ÙÙŠ";
const SIGNATURE = "Ø§Ù„Ù…Ø¹Ù„Ù…Ø©: Ø³Ø§Ø±Ø© Ø­Ù‚ÙˆÙŠ";
const CONTACT_PRIMARY = "966502234335"; // Ø²Ø±/Ø±Ø§Ø¨Ø· ØªÙˆØ§ØµÙ„ (Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)
const WHATSAPP_BUSINESS_FROM = "966556891201"; // Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø²Ù†Ø³ (0556891201)

function contactLink(){
  return "https://wa.me/" + CONTACT_PRIMARY;
}
function normalizePhoneToWA(phone){
  let p = String(phone||"").replace(/[^0-9]/g,"");
  if(!p) return "";
  if(p.startsWith("00")) p = p.slice(2);
  if(p.startsWith("0")) p = "966" + p.slice(1);
  return p;
}

// Ø±Ø³Ø§Ù„Ø© Ø±Ø³Ù…ÙŠØ© Ù…ÙˆØ­Ø¯Ø©
function buildOfficialMessage(type, student, amount, reason){
  const warn = "âš ï¸ Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©";
  const a = (amount===null || amount===undefined) ? "" : String(amount);
  return (
`${warn}
${TEACHER_BANK_TITLE}

ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨/Ù€Ø©:
${student}

Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${type}
Ø§Ù„Ù…Ø¨Ù„Øº: ${a} Ø±ÙŠØ§Ù„
Ø§Ù„Ø³Ø¨Ø¨: ${reason || "â€”"}

Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù…Ø©:
${contactLink()}

${SIGNATURE}`
  );
}

// ================== ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø²Ù†Ø³ Ø¨Ø³Ø±Ø¹Ø© (Ø¨Ø¯ÙˆÙ† ØµÙØ­Ø© Ø¨ÙŠØ¶Ø§Ø¡) ==================
function openWABusinessFast(toPhone, messageText){
  const phone = normalizePhoneToWA(toPhone);
  const msg = encodeURIComponent(messageText || "");
  if(!phone) return;

  // Ù†Ø­Ø§ÙˆÙ„ Ù†Ø¬Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø²Ù†Ø³
  const scheme = "whatsapp-business://send?phone=" + phone + "&text=" + msg;
  const waweb  = "https://wa.me/" + phone + "?text=" + msg;

  // Ø¹Ù„Ù‰ iOS Ø§Ù„Ø£ÙØ¶Ù„ location.href Ù„Ø£Ù†Ù‡ ÙŠØ¹ØªØ¨Ø± â€œÙ†Ù‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø©â€ Ù…Ù† Ù†ÙØ³ Ø²Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
  try{
    window.location.href = scheme;
    // Ùallback Ù„Ùˆ Ù…Ø§ ÙØªØ­ Ø¨Ø²Ù†Ø³
    setTimeout(()=>{ window.location.href = waweb; }, 700);
  }catch(e){
    window.location.href = waweb;
  }
}

// ================== Firebase ==================
const firebaseConfig = {
  apiKey: "AIzaSyDP-pi0tbFQ9bNRihrLz_kUs-JBoa9Cw4Y",
  authDomain: "sara-haywire.firebaseapp.com",
  projectId: "sara-haywire",
  storageBucket: "sara-haywire.firebasestorage.app",
  messagingSenderId: "333467940977",
  appId: "1:333467940977:web:97d056d5dbff2debbf43d0",
  measurementId: "G-7RPQX9ER93"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ================== Ø«ÙˆØ§Ø¨Øª ==================
const TEACHER_EMAIL="as-soso-as2011@hotmail.com";

// ================== Helpers UI ==================
function $(id){return document.getElementById(id);}

function openModal(title, bodyHtml, actionsHtml){
  $("mTitle").textContent=title;
  $("mBody").innerHTML=bodyHtml;
  $("mActions").innerHTML=actionsHtml||'<button class="btn" onclick="closeModal()">Ù…ÙˆØ§ÙÙ‚</button>';
  $("modal").style.display="flex";
}
function closeModal(){ $("modal").style.display="none"; }
function warn(msg){ openModal("ØªÙ†Ø¨ÙŠÙ‡", msg); }
function logout(){location.reload();}

function go(page){
  ["teacherLoginPage","classesPage","classPage","studentLoginPage","studentAccountPage"].forEach(id=>$(id).classList.add("hidden"));
  $(page).classList.remove("hidden");
}
function backToClasses(){ go("classesPage"); renderTabs(); refreshTeacherStats(); }
function openClassPage(){ go("classPage"); renderStudents(); }
function backToClass(){
  if(IS_STUDENT_ENTRY){ go("studentLoginPage"); return; }
  go("classPage"); renderStudents();
}
function fmt(x){ return (Math.round((Number(x||0)+Number.EPSILON)*100)/100).toFixed(2); }

// ===== ØµÙˆØª Ø§Ù„ØªØ±Ø­ÙŠØ¨ =====
async function playWelcome(){
  const m4a = document.getElementById("welcomeM4a");
  const mp3 = document.getElementById("welcomeMp3");
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type="triangle"; o.frequency.value=740; g.gain.value=0.10;
    o.connect(g); g.connect(ctx.destination); o.start();
    setTimeout(()=>{o.stop(); ctx.close();}, 220);
  }catch(e){}
  try{ if(m4a){ m4a.currentTime=0; await m4a.play(); return; } }catch(e){}
  try{ if(mp3){ mp3.currentTime=0; await mp3.play(); return; } }catch(e){}
}

// ================== Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ==================
const REASONS = {
  deposit: [
    "Ø§Ù„ØªÙØ§Ø¹Ù„ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©",
    "Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„ØµÙÙŠØ©",
    "Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ§Ù„Ø­ØµØ©",
    "ØªÙ…ÙŠØ² ÙÙŠ Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ",
    "ØªØ­Ø³Ù† Ù…Ù„Ø­ÙˆØ¸ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø£Ùˆ Ø§Ù„Ø³Ù„ÙˆÙƒ",
    "Ø£Ø®Ø±Ù‰"
  ],
  withdraw: [
    "Ø¹Ø¯Ù… Ø­Ù„ Ø§Ù„ÙˆØ§Ø¬Ø¨ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ",
    "ÙƒØ«Ø±Ø© Ø§Ù„ÙƒÙ„Ø§Ù… ÙˆØ§Ù„Ø­Ø±ÙƒØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­ØµØ©",
    "Ø§Ù„Ù†ÙˆÙ… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ØµØ©",
    "Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ù„Ø§Ø¦Ù‚ Ù…Ø¹ Ø§Ù„Ø²Ù…Ù„Ø§Ø¡",
    "Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ù„Ø§Ø¦Ù‚ Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù…Ø©",
    "Ø§Ù„ØªØ£Ø®Ø± Ø¹Ù† Ø­ØµØ© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø¯ÙˆÙ† Ø¹Ø°Ø±",
    "Ù†Ø³ÙŠØ§Ù† ÙƒØªØ§Ø¨ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª",
    "Ù†Ø³ÙŠØ§Ù† Ø§Ù„Ø¯ÙØªØ±",
    "Ù†Ø³ÙŠØ§Ù† Ø§Ù„Ù…Ø°ÙƒØ±Ø©",
    "Ø¹Ø¯Ù… Ø¥Ø­Ø¶Ø§Ø± Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª",
    "Ø£Ø®Ø±Ù‰"
  ],
  transfer: [
    "Ø³Ø¨Ø¨ ØªØ­ÙˆÙŠÙ„ÙŠ/ØªØ­ÙˆÙŠÙ„ Ø±ØµÙŠØ¯",
    "ØªØ³Ø¯ÙŠØ¯/Ø¥Ø±Ø¬Ø§Ø¹ Ø±ØµÙŠØ¯",
    "Ù…Ø³Ø§Ø¹Ø¯Ø© Ø²Ù…ÙŠÙ„/Ù€Ø©",
    "Ø£Ø®Ø±Ù‰"
  ]
};

let currentAccess = "teacher"; // teacher | student

function fillReasonSelect(selectEl, items){
  if(!selectEl) return;
  selectEl.innerHTML = "";
  items.forEach(r=>{
    const o = document.createElement("option");
    o.value = r;
    o.textContent = r;
    selectEl.appendChild(o);
  });
}

function setupReasonUI(mode, selectId, otherId){
  const sel = document.getElementById(selectId);
  const other = document.getElementById(otherId);
  if(!sel || !other) return;

  // âœ… ØªØ´ÙÙŠØ±/ØªÙ‚ÙŠÙŠØ¯ Ø³Ø¨Ø¨ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø·Ø§Ù„Ø¨: ÙÙ‚Ø· â€œØ£Ø®Ø±Ù‰â€ + Ù…Ø±Ø¨Ø¹ Ù†Øµ
  if(mode === "transfer" && currentAccess === "student"){
    sel.classList.add("hidden");
    other.classList.remove("hidden");
    other.placeholder = "Ø³Ø¨Ø¨ Ø§Ù„ØªØ­ÙˆÙŠÙ„ (Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„ØªÙ†ÙÙŠØ° Ù‡Ù†Ø§...)";
    if(!other.value) other.value = "";
    return;
  }

  // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª (Ù…Ø¹Ù„Ù…Ø© Ø£Ùˆ Ø¹Ù…Ù„ÙŠØ§Øª ØºÙŠØ± Ø§Ù„ØªØ­ÙˆÙŠÙ„)
  sel.classList.remove("hidden");
  fillReasonSelect(sel, REASONS[mode] || ["Ø£Ø®Ø±Ù‰"]);

  const toggleOther = ()=>{
    if(sel.value === "Ø£Ø®Ø±Ù‰"){
      other.classList.remove("hidden");
      other.placeholder = "Ø£Ø®Ø±Ù‰: Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¨Ø¨ Ù‡Ù†Ø§...";
    }else{
      other.classList.add("hidden");
      other.value = "";
    }
  };
  sel.onchange = toggleOther;
  toggleOther();
}

function getReason(selectId, otherId){
  const sel = document.getElementById(selectId);
  const other = document.getElementById(otherId);

  // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø·Ø§Ù„Ø¨: Ø§Ù„Ø³Ø¨Ø¨ Ù…Ù† Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù†Øµ
  if(sel && sel.classList.contains("hidden")){
    const t = (other?.value || "").trim();
    return t || "ØªØ­ÙˆÙŠÙ„";
  }

  if(!sel) return "";
  if(sel.value === "Ø£Ø®Ø±Ù‰"){
    const t = (other?.value || "").trim();
    return t || "Ø£Ø®Ø±Ù‰";
  }
  return sel.value || "";
}

// ================== Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡ ==================
async function startApp(){
  $("connPill").textContent = "Ø¬Ø§Ù‡Ø² âœ…";
  $("connPill").style.background = "#dff4e3";
  $("connPill").style.color = "#2e7d32";
  try{ await playWelcome(); }catch(e){}
  $("startOverlay").style.display = "none";

  // ÙˆØ¶Ø¹ Ø§Ù„Ø·Ù„Ø§Ø¨: ÙŠÙØªØ­ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø©
  if(IS_STUDENT_ENTRY){
    go("studentLoginPage");
    $("stuLoginTitle").textContent = "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨";
    $("stuName").readOnly = false;
    $("stuName").value = "";
    $("stuName").placeholder = "Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ ÙƒÙ…Ø§ Ù‡Ùˆ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…";
    $("stuPin").value = "";
    currentAccess = "student";
    setupReasonUI('deposit','reasonStudent','reasonOtherStudent');
    return;
  }

  // ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù…Ø©
  go("teacherLoginPage");
  currentAccess = "teacher";
}

// ================== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…Ø© ==================
function teacherLogin(){
  if($("tu").value.trim()==="teacher" && $("tp").value.trim()==="12345"){
    currentAccess = "teacher";
    go("classesPage"); renderTabs(); refreshTeacherStats();
  } else warn("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
}
function forgotTeacher(){
  const subject=encodeURIComponent("Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø®ÙˆÙ„ Ù…ØµØ±Ù Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª");
  const body=encodeURIComponent("Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…ØŒ\nØ£Ø±ØºØ¨ Ø¨Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù…ØµØ±Ù Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª.\nØ´ÙƒØ±Ø§Ù‹.");
  window.location.href=`mailto:${TEACHER_EMAIL}?subject=${subject}&body=${body}`;
}

// ================== Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø§Ù…Ø© ==================
let classes=[], currentClassId=null, currentStudentId=null;

// ================== Seed (ÙƒÙ…Ø§ Ø¹Ù†Ø¯Ùƒ) ==================
const DEFAULT_STUDENTS = {
  "Ø³Ø§Ø¯Ø³ Ø¨Ù†ÙŠÙ†": ["Ø·Ù„Ø§Ù„ Ø§Ù„Ø±Ø­ÙŠÙ„ÙŠ","Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ±Ù…ÙŠ","Ø¹Ù…Ø± ØµÙˆØ§Ù","Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹Ù†Ø²ÙŠ","Ø³Ø§Ù„Ù… Ø¢Ù„ Ù…Ø®Ù„Øµ","Ø¹Ø¨Ø¯Ø§Ù„Ù…Ù„Ùƒ Ø§Ù„Ø¬Ù†Ø§Ø¹ÙŠ","ÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø§Ù„ÙƒÙŠ","Ø³Ù„Ù…Ø§Ù† Ø§Ù„Ø¬ÙˆÙ‡Ø±","Ø±Ø§ÙƒØ§Ù† Ù…Ø¨Ø§Ø±ÙƒÙŠ","ÙÙŠØµÙ„ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ","Ø±ÙŠØ§Ù† Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ","Ù…Ø­Ù…Ø¯ Ø£Ø¨Ùˆ ØµØ§Ù„Ø­","Ù†Ø§ÙŠÙ Ø§Ù„Ø¹ØµÙŠÙ…ÙŠ"],
  "Ø³Ø§Ø¯Ø³ Ø¨Ù†Ø§Øª": ["Ø±Ù‡Ù Ø§Ù„Ø«Ø¨ÙŠØªÙŠ","Ø¬Ø§Ø¯Ù„ Ø§Ù„Ø¯ÙˆØ³Ø±ÙŠ","Ø¯Ø§Ù†Ø© Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ","ØªØ§Ù„ÙŠÙ† Ù…ØªÙˆÙ„ÙŠ","Ø¯ÙŠÙ…Ø§ Ø§Ù„Ø­Ù…Ø§Ø¯ÙŠ","Ø±Ù‡Ù Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ","ÙƒØ§Ø¯ÙŠ Ø§Ù„Ø¹ØªÙŠØ¨ÙŠ","Ø±ÙˆØ¯ÙŠÙ†Ø§ ØºØ±ÙŠØ¨","Ø§Ù„Ø¬ÙˆÙ‡Ø±Ø© Ø¢Ù„ Ù…Ø®Ù„Øµ","Ø±ÙŠÙ… Ø¢Ù„ Ù…Ø´Ø±Ù"],
  "Ø£ÙˆÙ„ Ù…ØªÙˆØ³Ø·": ["Ø§ÙŠÙ…Ø§Ù† Ø¨Ø§ØºØ±ÙŠØ¨","Ø¯ÙŠÙ…Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠ","Ù†Ø¬Ù„Ø§ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ","Ø¯ÙŠÙ… Ø§Ù„ØºØ§Ù…Ø¯ÙŠ","Ù…ÙŠØ³ Ø§Ù„Ø³Ù†Ø§Ù…Ø©","Ù„Ø§Ø±ÙŠÙ† Ø§Ù„ØªÙ„","Ù„ÙŠØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø±ÙÙŠ","Ø³Ø§Ø±Ø© Ø§Ù„ØºØ§Ù…Ø¯ÙŠ"]
};

const PARENTS_PHONE = {
  "Ø³Ø§Ù„Ù… Ø¢Ù„ Ù…Ø®Ù„Øµ": "0502402111",
  "Ø§Ù„Ø¬ÙˆÙ‡Ø±Ø© Ø¢Ù„ Ù…Ø®Ù„Øµ": "0502402111",
  "ØªØ§Ù„ÙŠÙ† Ù…ØªÙˆÙ„ÙŠ": "0505220540",
  "Ø¬Ø§Ø¯Ù„ Ø§Ù„Ø¯ÙˆØ³Ø±ÙŠ": "0538118080",
  "Ø¯Ø§Ù†Ø© Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ": "0555952003",
  "Ø±Ù‡Ù Ø§Ù„Ø¹ØªÙŠØ¨ÙŠ": "0543339829",
  "ÙƒØ§Ø¯ÙŠ Ø§Ù„Ø¹ØªÙŠØ¨ÙŠ": "0532340737",
  "Ø±Ù‡Ù Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ": "0562580555",
  "Ø±ÙŠÙ… Ø¢Ù„ Ù…Ø´Ø±Ù": "054565589",
  "Ø¯ÙŠÙ… Ø§Ù„Ø­Ù…Ø§Ø¯ÙŠ": "0501222335",
  "Ø±ÙˆØ¯ÙŠÙ†Ø§ Ø§Ù„ØºØ±ÙŠØ¨": "0506925919",
  "Ø±Ø§ÙƒØ§Ù† Ù…Ø¨Ø§Ø±ÙƒÙŠ": "0559591061",
  "Ø³Ù„Ù…Ø§Ù† Ø§Ù„Ø¬ÙˆÙ‡Ø±": "053827904",
  "Ø·Ù„Ø§Ù„ Ø§Ù„Ø±Ø­ÙŠÙ„ÙŠ": "0598801283",
  "Ù…Ø­Ù…Ø¯ Ø¨ÙˆØµØ§Ù„Ø­": "0500125335",
  "Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹Ù†Ø²ÙŠ": "0533264929",
  "Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ±Ù…ÙŠ": "0563882235",
  "ÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø§Ù„ÙƒÙŠ": "0552582145",
  "Ù†Ø§ÙŠÙ Ø§Ù„Ø¹ØµÙŠÙ…ÙŠ": "0509799783",
  "Ø¹Ø¨Ø¯Ø§Ù„Ù…Ù„Ùƒ Ø§Ù„Ø¬Ù†Ø§Ø¹ÙŠ": "0568027600",
  "ÙÙŠØµÙ„ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ": "0507993660",
  "Ø±ÙŠØ§Ù† Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ": "0555078508",
  "Ø¹Ù…Ø± ØµÙˆØ§Ù": "0599831191",
  "Ø¯ÙŠÙ…Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠ": "0567509173",
  "Ù„Ø§Ø±ÙŠÙ† Ø§Ù„ØªÙ„": "0580662141",
  "Ù†Ø¬Ù„Ø§ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ": "0535952876",
  "Ø§ÙŠÙ…Ø§Ù† Ø¨Ø§ØºØ±ÙŠØ¨": "0542678280",
  "Ø¯ÙŠÙ… Ø§Ù„ØºØ§Ù…Ø¯ÙŠ": "0535912049",
  "Ù„ÙŠØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø±ÙÙŠ": "0568135644",
  "Ù…ÙŠØ³ Ø§Ù„Ø³Ù†Ø§Ù…Ø©": "0580443424",
  "Ø³Ø§Ø±Ø© Ø§Ù„ØºØ§Ù…Ø¯ÙŠ": "0542743881"
};

async function ensureSeed(){
  const c = await db.collection("classes").orderBy("order").get();
  if(c.empty){
    await db.collection("classes").add({name:"Ø§Ù„ØµÙ Ø³Ø§Ø¯Ø³ Ø¨Ù†ÙŠÙ†",order:1});
    await db.collection("classes").add({name:"Ø§Ù„ØµÙ Ø³Ø§Ø¯Ø³ Ø¨Ù†Ø§Øª",order:2});
    await db.collection("classes").add({name:"Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø·",order:3});
  }

  const c2 = await db.collection("classes").orderBy("order").get();
  const by = {};
  c2.forEach(d=>by[d.data().name]=d.id);

  const all = await db.collection("students").get();
  const existing = new Set();
  all.forEach(d=>{ const s=d.data(); if(s?.name) existing.add(String(s.name).trim()); });

  for(const clsName of Object.keys(DEFAULT_STUDENTS)){
    const classId = by[clsName];
    if(!classId) continue;
    for(const n0 of DEFAULT_STUDENTS[clsName]){
      const n = String(n0).trim();
      if(existing.has(n)) continue;
      const pin=String(Math.floor(1000+Math.random()*9000));
      await db.collection("students").add({
        name:n,classId,active:true,balance:0,pin,openedAt:null,
        guardianWhats:(PARENTS_PHONE[n]||"")
      });
      existing.add(n);
    }
  }
}

// ================== ÙØµÙˆÙ„ ==================
async function loadClasses(){
  const snap = await db.collection("classes").orderBy("order").get();
  classes=[]; snap.forEach(d=>classes.push({id:d.id,...d.data()}));
  if(!currentClassId) currentClassId = classes[0]?.id;
}
async function renderTabs(){
  await loadClasses();
  const tabs=$("classTabs"); if(!tabs) return;
  tabs.innerHTML="";
  classes.forEach(c=>{
    const t=document.createElement("div");
    t.className="tab"+(c.id===currentClassId?" active":"");
    t.textContent=c.name;
    t.onclick=()=>{ currentClassId=c.id; renderTabs(); };
    tabs.appendChild(t);
  });
}

// ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØµÙˆÙ„ (ÙƒÙ…Ø§ Ø¹Ù†Ø¯Ùƒ) =====
async function addClass(){
  const n=$("newClassName").value.trim();
  if(!n) return warn("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙØµÙ„");
  const last=await db.collection("classes").orderBy("order","desc").limit(1).get();
  const max= last.empty?0:(last.docs[0].data().order||0);
  await db.collection("classes").add({name:n,order:max+1});
  $("newClassName").value="";
  await renderTabs();
}
async function renameClass(){
  const c=classes.find(x=>x.id===currentClassId); if(!c) return;
  const nn=prompt("Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„ÙØµÙ„:", c.name); if(!nn) return;
  await db.collection("classes").doc(currentClassId).update({name: nn.trim()});
  await renderTabs();
}
async function deleteClassMove(){
  if(classes.length<=1) return warn("Ù…Ø§ Ù†Ù‚Ø¯Ø± Ù†Ø­Ø°Ù Ø¢Ø®Ø± ÙØµÙ„");
  const others=classes.filter(c=>c.id!==currentClassId);
  const destName=prompt("Ù†Ù†Ù‚Ù„ Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„ Ù„Ø£ÙŠ ÙØµÙ„ØŸ\n"+others.map(c=>c.name).join(" / "), others[0].name);
  if(!destName) return;
  const dest=classes.find(c=>c.name===destName); if(!dest) return warn("Ø§Ø³Ù… Ø§Ù„ÙØµÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
  const studs=await db.collection("students").where("classId","==",currentClassId).get();
  const batch=db.batch();
  studs.forEach(d=>batch.update(db.collection("students").doc(d.id), {classId: dest.id}));
  batch.delete(db.collection("classes").doc(currentClassId));
  await batch.commit();
  currentClassId=null;
  await renderTabs();
}
async function syncStudentsToClasses(){
  await ensureSeed();
  openModal("ØªÙ… âœ…","ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø§Ù‚Øµ).");
  await renderTabs();
}

// ================== Ø¥Ø¹Ø¯Ø§Ø¯ â€œÙ†Ø³ÙŠØª Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠâ€ (ÙƒÙ…Ø§ Ø¹Ù†Ø¯Ùƒ) ==================
let forgotPinEnabled = true;
async function loadForgotSetting(){
  try{
    const doc = await db.collection("settings").doc("security").get();
    if(doc.exists){
      const d = doc.data() || {};
      if(typeof d.forgotPinEnabled === "boolean") forgotPinEnabled = d.forgotPinEnabled;
    }else{
      await db.collection("settings").doc("security").set({forgotPinEnabled:true});
      forgotPinEnabled = true;
    }
  }catch(e){
    forgotPinEnabled = true;
  }
  const link = document.querySelector('a[onclick="forgotStudentPin()"]');
  if(link) link.style.display = forgotPinEnabled ? "inline" : "none";
}
async function toggleForgotPinForAll(){
  try{
    forgotPinEnabled = !forgotPinEnabled;
    await db.collection("settings").doc("security").set({forgotPinEnabled}, {merge:true});
    openModal("ØªÙ… âœ…", forgotPinEnabled ? "ØªÙ… ØªÙØ¹ÙŠÙ„ (Ù†Ø³ÙŠØª Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ) Ù„Ù„Ø¬Ù…ÙŠØ¹." : "ØªÙ… ØªØ¹Ø·ÙŠÙ„ (Ù†Ø³ÙŠØª Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ) Ù„Ù„Ø¬Ù…ÙŠØ¹.");
  }catch(e){
    openModal("ØªÙ†Ø¨ÙŠÙ‡", "ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¢Ù†.");
  }
  await loadForgotSetting();
}
function isForgotEnabled(){ return forgotPinEnabled === true; }

async function ensureGuardianPhone(studentId, studentName){
  const ref = db.collection("students").doc(studentId);
  const doc = await ref.get();
  if(!doc.exists) return "";
  const s = doc.data() || {};
  if(s.guardianWhats && String(s.guardianWhats).trim()) return String(s.guardianWhats).trim();
  const guess = PARENTS_PHONE[studentName] || "";
  if(guess){
    await ref.update({guardianWhats: guess});
    return guess;
  }
  return "";
}

async function sendPinToParent(studentId){
  const ref = db.collection("students").doc(studentId);
  const doc = await ref.get();
  if(!doc.exists) return;
  const s = doc.data() || {};
  const parent = await ensureGuardianPhone(studentId, s.name||"");
  const wa = normalizePhoneToWA(parent);
  if(!wa){
    openModal("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø£Ù…Ø± Ù…Ø³Ø¬Ù„. Ø§Ø¶ØºØ·/ÙŠ (Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±) Ù„Ø¥Ø¶Ø§ÙØªÙ‡.");
    return;
  }
  const msg = encodeURIComponent(
    "Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡\n\n" +
    "Ø±Ù‚Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ (PIN) Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù„Ù„Ø·Ø§Ù„Ø¨/Ù€Ø©: " + (s.name||"") + "\n" +
    "PIN: " + (s.pin||"") + "\n\n" +
    "Ø´Ø§ÙƒØ±ÙŠÙ† ØªØ¹Ø§ÙˆÙ†ÙƒÙ… ğŸ¤"
  );
  // Ø³Ø±ÙŠØ¹ (ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø²Ù†Ø³)
  openWABusinessFast(wa, decodeURIComponent(msg));
}

// ================== logTxn (Ù…Ø¹ createdAtClient) ==================
async function logTxn(ref, type, reason, amount, balanceAfter, studentName, guardianWhats){
  await ref.collection("txns").add({
    type,
    reason: reason || "",
    amount,
    balanceAfter,
    studentName: studentName || "",
    guardianWhats: guardianWhats || "",
    createdAtClient: Date.now(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
}

// ================== Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù…Ø© ==================
async function addStudent(){
  const n=$("newStudentName").value.trim();
  if(!n) return warn("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨");
  const pin=String(Math.floor(1000+Math.random()*9000));
  await db.collection("students").add({
    name:n,classId:currentClassId,active:true,balance:0,pin,openedAt:null,
    guardianWhats:(PARENTS_PHONE[n]||"")
  });
  $("newStudentName").value="";
  await renderStudents();
}

async function deleteStudent(studentId, studentName){
  if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨: " + studentName + " ØŸ")) return;
  try{
    const sref = db.collection("students").doc(studentId);
    const tx = await sref.collection("txns").limit(300).get();
    const batch = db.batch();
    tx.forEach(d=>batch.delete(d.ref));
    batch.delete(sref);
    await batch.commit();
  }catch(e){
    try{ await db.collection("students").doc(studentId).delete(); }catch(_){}
  }
  await renderStudents();
}

async function editGuardianPhone(studentId, studentName){
  const ref = db.collection("students").doc(studentId);
  const doc = await ref.get();
  if(!doc.exists) return;
  const s = doc.data() || {};
  const current = (s.guardianWhats || PARENTS_PHONE[studentName] || "").toString();
  const nn = prompt("Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ù…Ø«Ø§Ù„: 05xxxxxxxx):", current);
  if(nn===null) return;
  await ref.update({guardianWhats: nn.trim()});
  openModal("ØªÙ… âœ…", "ØªÙ… Ø­ÙØ¸ Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±.");
  await renderStudents();
}

async function renderStudents(){
  const snap = await db.collection("students").where("classId","==",currentClassId).get();
  const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
  arr.sort((a,b)=>(a.name||"").localeCompare(b.name||"","ar"));

  const pick=$("pickStudent"); pick.innerHTML="";
  arr.forEach(s=>{ const o=document.createElement("option"); o.value=s.id; o.textContent=s.name; pick.appendChild(o); });

  const grid=$("studentsGrid"); grid.innerHTML="";
  arr.forEach(s=>{
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <strong>${s.name}</strong>
      <div class="small">Ø§Ù„Ø±ØµÙŠØ¯: ${fmt(s.balance)} Ø±.Ø³</div>
      <div class="small">PIN: <b>${s.pin||""}</b></div>
      <span class="badge ${s.active?'on':'off'}">${s.active?'ğŸŸ¢ Ù…ÙØ¹Ù„':'ğŸ”´ Ù…Ù‚ÙÙ„'}</span>
      <div class="row" style="margin-top:8px">
        <button class="btn2 col js-open">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
        <button class="btn3 col js-toggle">${s.active?'Ø¥Ù‚ÙØ§Ù„':'ØªÙØ¹ÙŠÙ„'}</button>
        <button class="btn3 col js-edit">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…</button>
        <button class="btn3 col js-parent">Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</button>
        <button class="btn whatsapp-btn col js-sendpin">Ø¥Ø±Ø³Ø§Ù„ PIN</button>
        <button class="btnRed col js-del">Ø­Ø°Ù</button>
      </div>
    `;
    card.querySelector(".js-open").onclick=()=>{ currentStudentId=s.id; showStudentLogin(s); };
    card.querySelector(".js-toggle").onclick=async()=>{ await db.collection("students").doc(s.id).update({active:!s.active}); await renderStudents(); };
    card.querySelector(".js-edit").onclick=async()=>{ const nn=prompt("Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:", s.name); if(nn) await db.collection("students").doc(s.id).update({name:nn.trim()}); await renderStudents(); };
    card.querySelector(".js-parent").onclick=()=> editGuardianPhone(s.id, s.name);
    card.querySelector(".js-sendpin").onclick=()=> sendPinToParent(s.id);
    card.querySelector(".js-del").onclick=()=> deleteStudent(s.id, s.name);
    grid.appendChild(card);
  });
}

// ================== Ø¥Ø±Ø³Ø§Ù„ ÙÙˆØ±ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ø§Ø­ØªØ±Ø§ÙÙŠ) ==================
function isAutoWAEnabled(){
  return !!document.getElementById("autoWA")?.checked;
}
function isCopyEnabled(){
  return !!document.getElementById("copyToTeacher")?.checked;
}

async function smartAutoSendWhats({type, studentName, amount, reason, guardianWhats}){
  if(!isAutoWAEnabled()) return;

  const parent = normalizePhoneToWA(guardianWhats || "");
  if(!parent){
    // Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠÙ‡ Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø£Ù…Ø±
    openModal("ØªÙ†Ø¨ÙŠÙ‡","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø£Ù…Ø± Ù…Ø³Ø¬Ù„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.");
    return;
  }

  const msg = buildOfficialMessage(type, studentName, amount, reason);

  // 1) ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø²Ù†Ø³ Ø¹Ù„Ù‰ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
  openWABusinessFast(parent, msg);

  // 2) Ù†Ø³Ø®Ø© Ù„Ù„Ù…Ø¹Ù„Ù…Ø© (Ù†ÙØ³ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø²Ù†Ø³) â€” ØªÙÙØªØ­ Ø¨Ø¹Ø¯ Ø«ÙˆØ§Ù†ÙŠ (Ø¥Ø°Ø§ Ø³Ù…Ø­Øª Ø§Ù„Ø¬ÙˆØ§Ù„)
  if(isCopyEnabled()){
    setTimeout(()=>{
      openWABusinessFast(CONTACT_PRIMARY, "Ù†Ø³Ø®Ø© Ù„Ù„Ù…Ø¹Ù„Ù…Ø© âœ…\n\n" + msg);
    }, 1200);
  }
}

// ================== Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù…Ø© (Ù…Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙˆØ±ÙŠ) ==================
async function depositAll(){
  const a=parseFloat($("bulkAmount").value);
  if(isNaN(a)||a<=0) return warn("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ù„Ù„ÙƒÙ„");
  const studs=await db.collection("students").where("classId","==",currentClassId).get();

  const batch=db.batch();
  for(const d of studs.docs){
    const s=d.data(); if(!s.active) continue;
    batch.update(db.collection("students").doc(d.id), {balance:Number(s.balance||0)+a});
  }
  await batch.commit();

  for(const d of studs.docs){
    const s=d.data(); if(!s.active) continue;
    const reason = getReason("reasonTeacher","reasonOtherTeacher");
    await logTxn(db.collection("students").doc(d.id),"Ø¥ÙŠØ¯Ø§Ø¹ Ø¬Ù…Ø§Ø¹ÙŠ",reason,a,Number(s.balance||0)+a,s.name,s.guardianWhats||"");

    await smartAutoSendWhats({
      type:"Ø¥ÙŠØ¯Ø§Ø¹ (Ù…Ø¹Ù„Ù…Ø©)","studentName":s.name,amount:a,reason,guardianWhats:(s.guardianWhats||"")
    });
  }
  $("bulkAmount").value="";
  await renderStudents();
  refreshTeacherStats();
}

async function withdrawAll(){
  const a=parseFloat($("bulkWithdrawAmount").value);
  // âœ… Ù‡Ù†Ø§ Ù„Ùˆ ØªØ¨ÙŠÙ† ØªØ³Ù…Ø­ÙŠÙ† 0 Ù„Ù„ÙƒÙ„ØŸ Ù†Ø®Ù„ÙŠÙ‡ >=0
  if(isNaN(a)||a<0) return warn("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„ÙƒÙ„");
  const studs=await db.collection("students").where("classId","==",currentClassId).get();

  for(const d of studs.docs){
    const s=d.data(); if(!s.active) continue;
    if(Number(s.balance||0) < a) return warn("ÙÙŠ Ø·Ø§Ù„Ø¨ Ø±ØµÙŠØ¯Ù‡ Ù…Ø§ ÙŠÙƒÙÙŠâ€¦ Ù‚Ù„Ù„ Ø§Ù„Ù…Ø¨Ù„Øº");
  }

  const batch=db.batch();
  for(const d of studs.docs){
    const s=d.data(); if(!s.active) continue;
    batch.update(db.collection("students").doc(d.id), {balance:Number(s.balance||0)-a});
  }
  await batch.commit();

  for(const d of studs.docs){
    const s=d.data(); if(!s.active) continue;
    const reason = getReason("reasonTeacher","reasonOtherTeacher");
    await logTxn(db.collection("students").doc(d.id),"Ø³Ø­Ø¨ Ø¬Ù…Ø§Ø¹ÙŠ (Ù…Ø¹Ù„Ù…Ø©)",reason,a,Number(s.balance||0)-a,s.name,s.guardianWhats||"");

    await smartAutoSendWhats({
      type:"Ø³Ø­Ø¨ (Ù…Ø¹Ù„Ù…Ø©)","studentName":s.name,amount:a,reason,guardianWhats:(s.guardianWhats||"")
    });
  }
  $("bulkWithdrawAmount").value="";
  await renderStudents();
  refreshTeacherStats();
}

async function depositToStudent(){
  const sid = $("pickStudent").value;
  const a = parseFloat($("pickAmount").value);
  if(!sid) return warn("Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨");
  if(isNaN(a) || a<=0) return warn("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº");

  const ref = db.collection("students").doc(sid);
  const doc = await ref.get();
  const s = doc.data();
  if(!s.active) return warn("Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù‚ÙÙ„");

  const nb = Number(s.balance||0) + a;
  const reason = getReason("reasonTeacher","reasonOtherTeacher");
  await ref.update({balance: nb});
  await logTxn(ref,"Ø¥ÙŠØ¯Ø§Ø¹ (Ù…Ø¹Ù„Ù…Ø©)",reason,a,nb,s.name,s.guardianWhats||"");

  await smartAutoSendWhats({
    type:"Ø¥ÙŠØ¯Ø§Ø¹ (Ù…Ø¹Ù„Ù…Ø©)","studentName":s.name,amount:a,reason,guardianWhats:(s.guardianWhats||"")
  });

  $("pickAmount").value = "";
  await renderStudents();
  refreshTeacherStats();
}

async function withdrawFromStudent(){
  const sid = $("pickStudent").value;
  const a = parseFloat($("pickAmount").value);
  if(!sid) return warn("Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨");
  // âœ… Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø³Ø­Ø¨ ØµÙØ±
  if(isNaN(a) || a<0) return warn("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº");

  const ref = db.collection("students").doc(sid);
  const doc = await ref.get();
  const s = doc.data();
  if(!s.active) return warn("Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù‚ÙÙ„");
  if(Number(s.balance||0) < a) return warn("Ø±ØµÙŠØ¯Ù‡ Ù…Ø§ ÙŠÙƒÙÙŠ");

  const nb = Number(s.balance||0) - a;
  const reason = getReason("reasonTeacher","reasonOtherTeacher");
  await ref.update({balance: nb});
  await logTxn(ref,"Ø³Ø­Ø¨ (Ù…Ø¹Ù„Ù…Ø©)",reason,a,nb,s.name,s.guardianWhats||"");

  await smartAutoSendWhats({
    type:"Ø³Ø­Ø¨ (Ù…Ø¹Ù„Ù…Ø©)","studentName":s.name,amount:a,reason,guardianWhats:(s.guardianWhats||"")
  });

  $("pickAmount").value = "";
  await renderStudents();
  refreshTeacherStats();
}

// ================== Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù…Ø© ==================
function showStudentLogin(s){
  currentAccess = "teacher";
  go("studentLoginPage");
  $("stuLoginTitle").textContent="Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ â€“ " + (classes.find(c=>c.id===currentClassId)?.name || "");
  $("stuName").value=s.name;
  $("stuName").readOnly = true;
  $("stuPin").value="";
  $("stuLocked").classList.add("hidden");
  if(!s.active) $("stuLocked").classList.remove("hidden");
}

// ================== Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ (ÙˆØ¶Ø¹ Ø§Ù„Ø·Ù„Ø§Ø¨) ==================
async function studentLogin(){
  try{
    if(IS_STUDENT_ENTRY){
      currentAccess = "student";
      const name = ($("stuName")?.value || "").trim();
      const pin  = ($("stuPin")?.value || "").trim();
      if(!name || !pin) return warn("Ø§ÙƒØªØ¨/ÙŠ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ");

      const snap = await db.collection("students").where("name","==",name).limit(1).get();
      if(snap.empty) return warn("Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…");

      const doc = snap.docs[0];
      currentStudentId = doc.id;
      const s = doc.data() || {};

      if(!s.active) return warn("Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù‚ÙÙ„");
      if(String(pin) !== String(s.pin||"")) return warn("Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ ØºÙ„Ø·");

      if(!s.openedAt) await db.collection("students").doc(currentStudentId)
        .update({openedAt: firebase.firestore.FieldValue.serverTimestamp()});

      await playWelcome();
      go("studentAccountPage");
      $("studentHeader").textContent=s.name;
      $("statusBadge").className="badge "+(s.active?"on":"off");
      $("statusBadge").textContent=s.active?"ğŸŸ¢ Ù†Ø´Ø·":"ğŸ”´ Ù…Ù‚ÙÙ„";
      $("studentBalance").textContent=fmt(s.balance);

      await renderOpenedAt();
      await buildTransferList();
      await showStatement();
      await refreshStudentStats();
      setupReasonUI($("op").value,'reasonStudent','reasonOtherStudent');
      return;
    }

    // ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù…Ø© Ø¯Ø§Ø®Ù„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨
    currentAccess = "teacher";
    const ref=db.collection("students").doc(currentStudentId);
    const doc=await ref.get();
    const s=doc.data();

    if(!s.active) return warn("Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù‚ÙÙ„");
    if($("stuPin").value.trim()!==String(s.pin||"")) return warn("Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ ØºÙ„Ø·");

    if(!s.openedAt) await ref.update({openedAt: firebase.firestore.FieldValue.serverTimestamp()});

    await playWelcome();

    go("studentAccountPage");
    $("studentHeader").textContent=s.name;
    $("statusBadge").className="badge "+(s.active?"on":"off");
    $("statusBadge").textContent=s.active?"ğŸŸ¢ Ù†Ø´Ø·":"ğŸ”´ Ù…Ù‚ÙÙ„";
    $("studentBalance").textContent=fmt(s.balance);

    await renderOpenedAt();
    await buildTransferList();
    await showStatement();
    await refreshStudentStats();
    setupReasonUI($("op").value,'reasonStudent','reasonOtherStudent');

  }catch(e){
    console.log(e);
    warn("ØµØ§Ø± Ø®Ø·Ø£â€¦ Ø¬Ø±Ù‘Ø¨/ÙŠ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©");
  }
}

async function renderOpenedAt(){
  const doc=await db.collection("students").doc(currentStudentId).get();
  const s=doc.data();
  $("openedAt").textContent = (s.openedAt && s.openedAt.toDate) ? s.openedAt.toDate().toLocaleString("ar-SA") : "â€”";
}

async function buildTransferList(){
  const snap=await db.collection("students").get();
  const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
  arr.sort((a,b)=>(a.name||"").localeCompare(b.name||"","ar"));
  $("transferTo").innerHTML="";
  arr.forEach(s=>{ if(s.id===currentStudentId) return; const o=document.createElement("option"); o.value=s.id; o.textContent=s.name; $("transferTo").appendChild(o); });
}

// ================== ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ==================
async function showStatement(){
  const from=$("fromDate").value;
  const to=$("toDate").value;

  let q = db.collection("students").doc(currentStudentId).collection("txns")
    .orderBy("createdAt","desc").limit(50);

  if(from && to){
    const fromD=new Date(from+"T00:00:00");
    const toD=new Date(to+"T23:59:59");
    q = db.collection("students").doc(currentStudentId).collection("txns")
      .where("createdAt", ">=", fromD)
      .where("createdAt", "<=", toD)
      .orderBy("createdAt","desc")
      .limit(100);
  }

  const snap=await q.get();
  const rows=$("stmtRows"); rows.innerHTML="";
  if(snap.empty){
    rows.innerHTML='<tr><td colspan="5" class="small">Ù…Ø§ ÙÙŠÙ‡ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ù‡Ø§Ù„ÙØªØ±Ø©â€¦</td></tr>';
    return;
  }
  snap.forEach(d=>{
    const x=d.data();
    const t=x.createdAt?.toDate?x.createdAt.toDate().toLocaleString("ar-SA"):"";
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${t}</td><td>${x.type||""}</td><td>${x.reason||""}</td><td>${fmt(x.amount)}</td><td>${fmt(x.balanceAfter)}</td>`;
    rows.appendChild(tr);
  });
}

// ================== Ø¹Ù…Ù„ÙŠØ§Øª Ø¯Ø§Ø®Ù„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨ ==================
async function executeOp(){
  const ref=db.collection("students").doc(currentStudentId);
  const doc=await ref.get();
  const s=doc.data();
  const op=$("op").value;
  const amt=parseFloat($("amt").value);

  // âœ… Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø³Ø­Ø¨ ØµÙØ±
  if(isNaN(amt) || (op==="withdraw" ? amt<0 : amt<=0)) return warn("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");

  const reason = getReason("reasonStudent","reasonOtherStudent");

  if(op==="deposit"){
    const nb=Number(s.balance||0)+amt;
    await ref.update({balance:nb});
    await logTxn(ref, "Ø¥ÙŠØ¯Ø§Ø¹", reason, amt, nb, s.name, s.guardianWhats||"");
  }else if(op==="withdraw"){
    if(Number(s.balance||0) < amt) return warn("Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ø§ ÙŠÙƒÙÙŠ");
    const nb=Number(s.balance||0)-amt;
    await ref.update({balance:nb});
    await logTxn(ref, "Ø³Ø­Ø¨", reason, amt, nb, s.name, s.guardianWhats||"");
  }else if(op==="transfer"){
    if(Number(s.balance||0) < amt) return warn("Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ø§ ÙŠÙƒÙÙŠ Ù„Ù„ØªØ­ÙˆÙŠÙ„");
    const toId=$("transferTo").value;
    const toRef=db.collection("students").doc(toId);
    const toDoc=await toRef.get();
    if(!toDoc.exists) return warn("Ø§Ù„Ù…Ø³ØªÙ„Ù… Ù…Ùˆ Ù…ÙˆØ¬ÙˆØ¯");
    const to=toDoc.data();

    const batch=db.batch();
    batch.update(ref, {balance:Number(s.balance||0)-amt});
    batch.update(toRef, {balance:Number(to.balance||0)+amt});
    await batch.commit();

    await logTxn(ref, "ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ "+to.name, reason, amt, Number(s.balance||0)-amt, s.name, s.guardianWhats||"");
    await logTxn(toRef, "ØªØ­ÙˆÙŠÙ„ Ù…Ù† "+(doc.data().name||"Ø·Ø§Ù„Ø¨"), reason, amt, Number(to.balance||0)+amt, to.name, to.guardianWhats||"");
  }

  $("amt").value="";
  const updated=await ref.get();
  $("studentBalance").textContent=fmt(updated.data().balance);
  await showStatement();
  await refreshStudentStats();
  refreshTeacherStats();
}

// ================== Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (ÙƒÙ…Ø§ Ø¹Ù†Ø¯Ùƒ) ==================
let dailyOpsCache = [];

async function loadDailyOps(){
  const inp = document.getElementById("dailyDate");
  const chosenStr = inp.value ? inp.value : new Date().toISOString().slice(0,10);
  if(!inp.value) inp.value = chosenStr;

  const snap = await db.collectionGroup("txns")
    .orderBy("createdAtClient","desc")
    .limit(300)
    .get();

  dailyOpsCache = [];
  snap.forEach(doc => dailyOpsCache.push(doc.data() || {}));

  // ÙÙ„ØªØ±Ø© Ø¨ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø®ØªØ§Ø± Ù…Ù† createdAtClient
  dailyOpsCache = dailyOpsCache.filter(x=>{
    const d = new Date(x.createdAtClient || 0);
    const key = d.toISOString().slice(0,10);
    return key === chosenStr;
  });

  renderDailyOps();
}

function renderDailyOps(){
  const box = document.getElementById("dailyOpsList");
  if(!dailyOpsCache.length){
    box.innerHTML = '<div class="small">Ù…Ø§ ÙÙŠÙ‡ Ø¹Ù…Ù„ÙŠØ§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®.</div>';
    return;
  }

  box.innerHTML = dailyOpsCache.map(x=>{
    const t = x.createdAtClient ? new Date(x.createdAtClient).toLocaleString("ar-SA") : "";
    return `
      <div class="card" style="margin:8px 0">
        <div><b>${x.studentName || "â€”"}</b></div>
        <div class="small">Ø§Ù„ÙˆÙ‚Øª: ${t}</div>
        <div class="small">Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${x.type || "â€”"}</div>
        <div class="small">Ø§Ù„Ù…Ø¨Ù„Øº: ${x.amount ?? ""} Ø±.Ø³</div>
        <div class="small">Ø§Ù„Ø³Ø¨Ø¨: ${x.reason || "â€”"}</div>
      </div>
    `;
  }).join("");
}

function sendDailyOpsWhats(){
  if(!dailyOpsCache.length){
    openModal("ØªÙ†Ø¨ÙŠÙ‡","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ù„Ø¥Ø±Ø³Ø§Ù„. Ø§Ø¶ØºØ·ÙŠ (Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª) Ø£ÙˆÙ„Ù‹Ø§.");
    return;
  }
  // ÙŠÙØªØ­ Ø£ÙˆÙ„ Ø¹Ù…Ù„ÙŠØ© ÙÙ‚Ø· Ù„ØªØ¬Ù†Ø¨ Ø­Ø¸Ø± Ø§Ù„Ù…ØªØµÙØ­
  const op = dailyOpsCache[0];
  const phone = normalizePhoneToWA(op.guardianWhats || "");
  if(!phone){ openModal("ØªÙ†Ø¨ÙŠÙ‡","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø£Ù…Ø± Ù…Ø³Ø¬Ù„."); return; }

  const msg = buildOfficialMessage(op.type||"Ø¹Ù…Ù„ÙŠØ©", op.studentName||"â€”", op.amount, op.reason);
  openWABusinessFast(phone, msg);
}

// ================== Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…Ø© (Ø¢Ø®Ø± 500 Ø¹Ù…Ù„ÙŠØ©) ==================
function dayKey(ms){
  const d = new Date(ms);
  return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0')+"-"+String(d.getDate()).padStart(2,'0');
}
function startOfWeek(d){
  const x = new Date(d);
  const day = x.getDay(); // 0 Sun
  const diff = (day===6?0:day+1); // Ø¶Ø¨Ø· ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø³Ø¨Øª ÙƒØ¨Ø¯Ø§ÙŠØ©
  x.setDate(x.getDate()-diff);
  x.setHours(0,0,0,0);
  return x;
}

async function refreshTeacherStats(){
  try{
    const stToday = $("stToday"), stWeek=$("stWeek"), stMonth=$("stMonth"), stTop=$("stTop");
    if(!stToday) return;

    const snap = await db.collectionGroup("txns")
      .orderBy("createdAtClient","desc").limit(500).get();

    const now = new Date();
    const todayKey = dayKey(Date.now());
    const wkStart = startOfWeek(now).getTime();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime();

    let sumToday=0,sumWeek=0,sumMonth=0, top=0, topLabel="â€”";
    snap.forEach(doc=>{
      const x = doc.data()||{};
      const ms = Number(x.createdAtClient||0);
      const amt = Math.abs(Number(x.amount||0));
      if(amt>top){ top=amt; topLabel=(x.studentName||"â€”")+" â€¢ "+(x.type||""); }
      if(dayKey(ms)===todayKey) sumToday += amt;
      if(ms>=wkStart) sumWeek += amt;
      if(ms>=monthStart) sumMonth += amt;
    });

    stToday.textContent = fmt(sumToday)+" Ø±.Ø³";
    stWeek.textContent  = fmt(sumWeek)+" Ø±.Ø³";
    stMonth.textContent = fmt(sumMonth)+" Ø±.Ø³";
    stTop.textContent   = (top? (fmt(top)+" Ø±.Ø³ â€” "+topLabel) : "â€”");
  }catch(e){
    console.log(e);
  }
}

// ================== Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ==================
async function refreshStudentStats(){
  try{
    const a=$("stuToday"), b=$("stuWeek"), c=$("stuMonth"), d=$("stuTop");
    if(!a) return;

    const snap = await db.collection("students").doc(currentStudentId).collection("txns")
      .orderBy("createdAtClient","desc").limit(300).get();

    const now = new Date();
    const todayKey = dayKey(Date.now());
    const wkStart = startOfWeek(now).getTime();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime();

    let sumToday=0,sumWeek=0,sumMonth=0, top=0, topLabel="â€”";
    snap.forEach(doc=>{
      const x = doc.data()||{};
      const ms = Number(x.createdAtClient||0);
      const amt = Math.abs(Number(x.amount||0));
      if(amt>top){ top=amt; topLabel=(x.type||""); }
      if(dayKey(ms)===todayKey) sumToday += amt;
      if(ms>=wkStart) sumWeek += amt;
      if(ms>=monthStart) sumMonth += amt;
    });

    a.textContent = fmt(sumToday)+" Ø±.Ø³";
    b.textContent = fmt(sumWeek)+" Ø±.Ø³";
    c.textContent = fmt(sumMonth)+" Ø±.Ø³";
    d.textContent = (top? (fmt(top)+" Ø±.Ø³ â€” "+topLabel) : "â€”");
  }catch(e){ console.log(e); }
}

// ================== ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ==================
document.addEventListener("DOMContentLoaded", () => {
  const opSel = document.getElementById('op');
  if(opSel){
    setupReasonUI(opSel.value, 'reasonStudent', 'reasonOtherStudent');
    opSel.addEventListener('change', ()=> setupReasonUI(opSel.value, 'reasonStudent', 'reasonOtherStudent'));
  }

  // âœ… Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù…Ø© ØªØ¸Ù‡Ø± Ù„Ù„Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„ ÙˆØ§Ù„Ø³Ø­Ø¨ (Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø­Ø³Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¹Ù„Ù…Ø©)
  // Ù‡Ù†Ø§ Ù†Ø®Ù„ÙŠÙ‡Ø§ ØªØ¨Ø¯Ø£ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø¨ (Ù…Ø«Ù„ Ù†Ø¸Ø§Ù…Ùƒ)ØŒ Ù„ÙƒÙ† Ø§Ù„Ù…Ø¹Ù„Ù…Ø© ØªÙ‚Ø¯Ø± ØªÙƒØªØ¨ â€œØ£Ø®Ø±Ù‰â€ Ø¨Ø£ÙŠ ÙˆÙ‚Øª
  setupReasonUI('withdraw', 'reasonTeacher', 'reasonOtherTeacher');

  loadForgotSetting();

  if(IS_STUDENT_ENTRY){
    $("startP").innerHTML = "Ø¬Ø§Ù‡Ø²ÙŠÙ† Ù†Ø¨Ø¯Ø£ Ø±Ø­Ù„Ø© Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù„Ù„Ø·Ù„Ø§Ø¨ØŸ<br>Ø§Ø¶ØºØ· Ø²Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆÙ†Ù†Ø·Ù„Ù‚ ğŸš€";
  }
});

// ===== ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ =====
(async()=>{
  try{
    await ensureSeed();
    await renderTabs();
    $("connPill").textContent="Ø¬Ø§Ù‡Ø² âœ…";
    $("connPill").style.background="#dff4e3";
    $("connPill").style.color="#2e7d32";
    if(!IS_STUDENT_ENTRY) refreshTeacherStats();
  }catch(e){
    $("connPill").textContent="Ø¬Ø§Ù‡Ø² âœ…";
  }
})();
</script>

</body>
</html>
