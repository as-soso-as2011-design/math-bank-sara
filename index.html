<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ุจูู ุงูุฑูุงุถูุงุช โ ุงููุตุฑูู ูููุนููุฉ ุณุงุฑุฉ ุญููู</title>

<style>
:root{
  --navy:#00205B;--rajhi:#0055A4;--sky:#EAF3FB;--sky2:#CFE6F7;--beige:#FAF9F7;
  --green:#2e7d32;--red:#b00020;--text:#1b1f23;
}
.whatsapp-btn{
  background:#25D366 !important;
  color:#fff !important;
  font-weight:700;
}
.whatsapp-btn:hover{ background:#1ebe5d !important; }

*{box-sizing:border-box;font-family:Tahoma,Arial,sans-serif}
body{margin:0;background:var(--beige);color:var(--text)}
.hidden{display:none}

/* Header + Footer ุซุงุจุชูู */
.topbar{
  position:sticky;top:0;z-index:2000;
  background:linear-gradient(90deg,var(--navy),var(--rajhi));
  color:#fff;padding:12px 14px;display:flex;align-items:center;gap:12px;
}
.topbar .titles{flex:1;text-align:center;line-height:1.35}
.topbar .t1{font-weight:800;font-size:16px}
.topbar .t2{font-size:12px;opacity:.95}
.logo{height:56px;width:auto;background:rgba(255,255,255,.78);border-radius:12px;padding:6px}
.footer{text-align:center;padding:14px 12px;color:var(--navy);font-weight:700}

.container{max-width:980px;margin:14px auto;padding:0 12px}
.card{background:#fff;border-radius:14px;padding:14px;margin:10px 0;box-shadow:0 8px 18px rgba(0,0,0,.06)}
.card.soft{background:var(--sky)}
.row{display:flex;gap:10px;flex-wrap:wrap}
.col{flex:1;min-width:160px}
input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #ccc;font-size:14px}
button{border:0;border-radius:10px;padding:10px 12px;cursor:pointer;font-size:14px}
.btn{background:var(--rajhi);color:#fff}
.btn2{background:var(--sky2);color:#003}
.btn3{background:#eef6fb;color:#003}
.btnRed{background:var(--red);color:#fff}

.tabs{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:10px 0}
.tab{background:#e9f4fb;color:#003;padding:8px 12px;border-radius:999px;cursor:pointer;font-size:14px}
.tab.active{background:var(--rajhi);color:#fff}

.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
@media(max-width:760px){.grid2{grid-template-columns:1fr}}

.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px}
.badge.on{background:#dff4e3;color:var(--green)}
.badge.off{background:#fde2e2;color:var(--red)}
.small{font-size:12px;color:#666}
hr{border:0;border-top:1px solid #eee;margin:10px 0}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:18px;z-index:9999}
.modalBox{background:#fff;border-radius:16px;max-width:680px;width:100%;padding:16px;text-align:center}
.modalBox h3{margin:0 0 8px 0;color:var(--navy)}
.modalBox p{margin:0 0 12px 0;font-size:15px;line-height:1.7;white-space:pre-line}
.modalActions{display:flex;gap:10px;flex-wrap:wrap}
.modalActions a,.modalActions button{flex:1;text-decoration:none}

/* Start overlay */
#startOverlay{position:fixed;inset:0;background:#0a2d66;display:flex;align-items:center;justify-content:center;padding:18px;z-index:9998}
.startBox{max-width:560px;width:100%;background:#fff;border-radius:18px;padding:18px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.pill{display:inline-block;background:#e9f4fb;color:#003;padding:6px 10px;border-radius:999px;font-size:12px;margin-bottom:10px}

/* Statement */
.tableWrap{overflow:auto;border-radius:12px;background:#f7fbff;border:1px solid #e6eef7}
table{width:100%;border-collapse:collapse;min-width:740px}
th,td{padding:10px;border-bottom:1px solid #e6eef7;text-align:center;font-size:13px;white-space:nowrap}
th{background:#eef6ff;color:#0b2a66}
tr:last-child td{border-bottom:none}
</style>
</head>

<body>

<div class="topbar">
  <img class="logo" src="school-logo.png" alt="ุดุนุงุฑ ุงููุฏุฑุณุฉ">
  <div class="titles">
    <div class="t1">ุจูู ุงูุฑูุงุถูุงุช โ ุงููุตุฑูู ูููุนููุฉ ุณุงุฑุฉ ุญููู</div>
    <div class="t2">ูุฏุฑุณุฉ ุฑูุงุฏ ุงูุดุฑู ุงูุฃูููุฉ</div>
  </div>
  <div style="width:56px"></div>
</div>

<audio id="welcomeMp3" preload="auto" src="welcome.mp3"></audio>
<audio id="welcomeM4a" preload="auto" src="welcome.m4a"></audio>

<div id="startOverlay">
  <div class="startBox">
    <div class="pill" id="connPill">...ุฌุงุฑู ุชุฌููุฒ ุงููุธุงู...</div>
    <h3>ููุง ูุงููู! ๐</h3>
    <p id="startText">ุฌุงูุฒูู ูุจุฏุฃ ุฑุญูุชูุง ูู ุจูู ุงูุฑูุงุถูุงุชุ<br>ุงุถุบุท ุฒุฑ ุงูุจุฏุงูุฉ ูููุทูู ๐</p>
    <button class="btn" onclick="startApp()">ุงุจุฏุฃ</button>
    <div class="small" id="connNote" style="margin-top:8px"></div>
  </div>
</div>

<div id="modal" class="modal">
  <div class="modalBox">
    <h3 id="mTitle"></h3>
    <p id="mBody"></p>
    <div class="modalActions" id="mActions">
      <button class="btn" onclick="closeModal()">ููุงูู</button>
    </div>
  </div>
</div>

<div id="teacherLoginPage" class="hidden">
  <div class="container">
    <div class="card">
      <h3 style="margin:0 0 10px 0;color:var(--navy)">ุชุณุฌูู ุฏุฎูู ุงููุนููุฉ</h3>
      <input id="tu" placeholder="ุงุณู ุงููุณุชุฎุฏู">
      <input id="tp" type="password" placeholder="ูููุฉ ุงููุฑูุฑ">
      <div class="row">
        <button class="btn col" onclick="teacherLogin()">ุชุณุฌูู ุงูุฏุฎูู</button>
        <button class="btn3 col" onclick="forgotTeacher()">ูุณูุช ุงุณู ุงููุณุชุฎุฏูุ</button>
      </div>
      <div class="small">ุงูุฏุฎูู: teacher / 12345</div>
    </div>
  </div>
</div>

<div id="classesPage" class="hidden">
  <div class="container">

    <!-- ุงูุนูููุงุช ุงูููููุฉ -->
    <div class="card soft" id="dailyOpsCard">
      <h3 style="margin:0 0 8px 0;color:var(--navy)">ุงูุนูููุงุช ุงูููููุฉ</h3>

      <div class="row">
        <div class="col">
          <div class="small">ุงุฎุชุฑ ุงูุชุงุฑูุฎ</div>
          <input id="dailyDate" type="date">
        </div>

        <div class="col" style="align-self:flex-end">
          <button class="btn2" onclick="loadDailyOps()">ุนุฑุถ ุงูุนูููุงุช</button>
        </div>

        <div class="col" style="align-self:flex-end">
          <button class="btn whatsapp-btn" onclick="sendDailyOpsWhats()">ูุชุญ ูุงุชุณุงุจ ููุฃููุงุช</button>
        </div>
      </div>

      <div class="small" style="margin-top:8px">
        * ุฃู ุนูููุฉ ุชูุณุฌููู ุชููุงุฆููุง (ุทุงูุจ/ูุนููุฉ) ุชุธูุฑ ููุง ุญุณุจ ุงูุชุงุฑูุฎ.
      </div>

      <div id="dailyOpsList" style="margin-top:10px"></div>
    </div>

    <div class="card soft">
      <div class="row">
        <div class="col">
          <div class="small">ุฅุถุงูุฉ ูุตู</div>
          <input id="newClassName" placeholder="ูุซุงู: ุฎุงูุณ ุจูุงุช">
        </div>
        <div class="col" style="align-self:flex-end">
          <button class="btn2" onclick="addClass()">ุฅุถุงูุฉ ูุตู</button>
        </div>
      </div>
      <hr>
      <div class="row">
        <button class="btn2 col" onclick="renameClass()">ุชุนุฏูู ุงุณู ุงููุตู</button>
        <button class="btnRed col" onclick="deleteClassMove()">ุญุฐู ูุตู + ููู ุงูุทูุงุจ</button>
        <button class="btn3 col" onclick="syncStudentsToClasses()">ุชุซุจูุช ุฃุณูุงุก ุงูุทูุงุจ</button>
        <button class="btn3 col" onclick="toggleForgotPinForAll()">ุชุนุทูู/ุชูุนูู ูุณูุช ุงูุฑูู ุงูุณุฑู</button>
      </div>
      <div class="small">ุฅุฐุง ูุซุฑุช ููุงูุน ุงูุงุณุชุถุงูุฉ ูุชุฎุฑุจุทุช ุงููุตููุ ุฒุฑ "ุชุซุจูุช ุฃุณูุงุก ุงูุทูุงุจ" ูุฑุฌุน ูู ุทุงูุจ ููุตูู ุงูุตุญูุญ.</div>
    </div>

    <div class="tabs" id="classTabs"></div>

    <div class="card">
      <button class="btn2" onclick="openClassPage()">ุฏุฎูู ุงููุตู</button>
      <button class="btn3" onclick="logout()">ุชุณุฌูู ุฎุฑูุฌ</button>
    </div>

  </div>
</div>

<div id="classPage" class="hidden">
  <div class="container">

    <div class="card soft">
      <div class="row">
        <div class="col">
          <div class="small">ุฅุถุงูุฉ ุทุงูุจ</div>
          <input id="newStudentName" placeholder="ุงุณู ุงูุทุงูุจ/ุงูุทุงูุจุฉ">
        </div>
        <div class="col" style="align-self:flex-end">
          <button class="btn2" onclick="addStudent()">ุฅุถุงูุฉ ุทุงูุจ</button>
        </div>
      </div>

      <hr>

      <div class="row">
        <div class="col">
          <div class="small">ูุจูุบ ุงูุฅูุฏุงุน ูููู</div>
          <input id="bulkAmount" type="number" step="0.01" placeholder="ูุซุงู: 10">
        </div>
        <div class="col" style="align-self:flex-end">
          <button class="btn" onclick="depositAll()">ุฅูุฏุงุน ูููู</button>
        </div>

        <div class="col">
          <div class="small">ูุจูุบ ุงูุณุญุจ ูู ุงููู</div>
          <input id="bulkWithdrawAmount" type="number" step="0.01" placeholder="ูุซุงู: 5">
        </div>
        <div class="col" style="align-self:flex-end">
          <button class="btnRed" onclick="withdrawAll()">ุณุญุจ ูู ุงููู</button>
        </div>
      </div>

      <hr>

      <div class="row">
        <div class="col">
          <div class="small">ุทุงูุจ ูุญุฏุฏ</div>
          <select id="pickStudent"></select>
        </div>
        <div class="col">
          <div class="small">ุงููุจูุบ</div>
          <input id="pickAmount" type="number" step="0.01" placeholder="ูุซุงู: 5">
        </div>
        <div class="col" style="align-self:flex-end">
          <button class="btn2" onclick="depositToStudent()">ุฅูุฏุงุน ูุทุงูุจ</button>
        </div>
        <div class="col" style="align-self:flex-end">
          <button class="btnRed" onclick="withdrawFromStudent()">ุณุญุจ ูู ุทุงูุจ</button>
        </div>
      </div>

      <hr>

      <div class="row">
        <div class="col">
          <div class="small">ุณุจุจ ุงูุนูููุฉ</div>
          <select id="reasonTeacher"></select>
          <input id="reasonOtherTeacher" class="hidden" placeholder="ุฃุฎุฑู: ุงูุชุจ ุงูุณุจุจ ููุง..." style="margin-top:8px">
        </div>
      </div>

    </div>

    <div id="studentsGrid" class="grid2"></div>

    <div class="card">
      <button class="btn3" onclick="backToClasses()">ุฑุฌูุน ูููุตูู</button>
    </div>

  </div>
</div>

<div id="studentLoginPage" class="hidden">
  <div class="container">
    <div class="card">
      <h3 style="margin:0 0 10px 0;color:var(--navy)" id="stuLoginTitle">ุฏุฎูู ุงูุทุงูุจ</h3>
      <div id="stuLocked" class="small hidden" style="color:var(--red);font-weight:700"></div>
      <input id="stuName" readonly>
      <input id="stuPin" type="password" placeholder="ุงูุฑูู ุงูุณุฑู (PIN)">
      <div class="small" style="margin:8px 0;">
        <a href="javascript:void(0)" onclick="forgotStudentPin()" style="color:#0055A4;font-weight:700">ูุณูุช ุงูุฑูู ุงูุณุฑูุ</a>
      </div>
      <button class="btn" onclick="studentLogin()">ุฏุฎูู</button>
      <button class="btn3" onclick="backToClass()">ุฑุฌูุน</button>
    </div>
  </div>
</div>

<div id="studentAccountPage" class="hidden">
  <div class="container">
    <div class="card soft">
      <h3 style="margin:0 0 10px 0;color:var(--navy)" id="studentHeader"></h3>
      <div class="row">
        <div class="col"><div class="small">ุงูุญุงูุฉ</div><div id="statusBadge" class="badge"></div></div>
        <div class="col"><div class="small">ุงูุฑุตูุฏ</div><div style="font-size:26px;font-weight:800;color:var(--navy)"><span id="studentBalance">0</span> ุฑ.ุณ</div></div>
        <div class="col"><div class="small">ุชุงุฑูุฎ ูุชุญ ุงูุญุณุงุจ</div><div id="openedAt" class="small">โ</div></div>
      </div>

      <hr>

      <div class="row">
        <div class="col"><div class="small">ูู ุชุงุฑูุฎ</div><input id="fromDate" type="date"></div>
        <div class="col"><div class="small">ุฅูู ุชุงุฑูุฎ</div><input id="toDate" type="date"></div>
        <div class="col" style="align-self:flex-end"><button class="btn2" onclick="showStatement()">ุนุฑุถ ูุดู ุงูุญุณุงุจ</button></div>
      </div>

      <div class="tableWrap" style="margin-top:10px">
        <table>
          <thead><tr><th>ุงูููุช</th><th>ุงูุนูููุฉ</th><th>ุงูุณุจุจ</th><th>ุงููุจูุบ</th><th>ุงูุฑุตูุฏ ุจุนุฏ ุงูุนูููุฉ</th></tr></thead>
          <tbody id="stmtRows"></tbody>
        </table>
      </div>

      <hr>

      <div class="row">
        <div class="col">
          <div class="small">ุงูุนูููุฉ</div>
          <select id="op">
            <option value="deposit">ุฅูุฏุงุน</option>
            <option value="withdraw">ุณุญุจ</option>
            <option value="transfer">ุชุญููู</option>
          </select>
        </div>

        <div class="col">
          <div class="small">ุงูุณุจุจ</div>
          <select id="reasonStudent"></select>
          <input id="reasonOtherStudent" class="hidden" placeholder="ุฃุฎุฑู: ุงูุชุจ ุงูุณุจุจ ููุง..." style="margin-top:8px">
        </div>

        <div class="col"><div class="small">ุงููุจูุบ</div><input id="amt" type="number" step="0.01"></div>
        <div class="col"><div class="small">ุชุญููู ุฅูู</div><select id="transferTo"></select></div>
      </div>

      <div class="row">
        <button class="btn col" onclick="executeOp()">ุชูููุฐ</button>
        <button class="btn3 col" onclick="backToClass()">ุฑุฌูุน</button>
      </div>

    </div>
  </div>
</div>

<div class="footer">ุงูุฑูุงุถูุงุช ูุบุฉ ุงูุฃุฐููุงุก โจ</div>

<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

<script>
// ================== ูุถุน ุงูุฑุงุจุท (โ ููุท ุฅุถุงูุฉ ุจุฏูู ุชุบููุฑ ุชุตููู) ==================
const __params = new URLSearchParams(window.location.search);
const APP_MODE = (__params.get("mode") || "teacher").toLowerCase(); // teacher | student
const IS_STUDENT_MODE = (APP_MODE === "student");
const STUDENT_SID = (__params.get("sid") || "").trim();
const STUDENT_NAME_Q = (__params.get("name") || "").trim();

// ================== ุฅุนุฏุงุฏุงุช ูุงุจูุฉ ููุชุนุฏูู ููุฑุณุงุฆู ุงูููููุฉ ==================
const TEACHER_BANK_TITLE = "ุฅุฏุงุฑุฉ ุจูู ุงูุฑูุงุถูุงุช โ ุงููุนููุฉ ุณุงุฑุฉ ุญููู";

const TEMPLATE_DEPOSIT =
`๐ฟ ${TEACHER_BANK_TITLE}

ุชู ุฅูุฏุงุน (ุชุนุฒูุฒ) ูู ุญุณุงุจ ุงูุทุงูุจ/ูุฉ:
{student}

ุงููุจูุบ: {amount} ุฑูุงู
ุงูุณุจุจ: {reason}

ุดุงูุฑูู ุชุนุงูููู ๐ค`;

const TEMPLATE_WITHDRAW =
`โ๏ธ ${TEACHER_BANK_TITLE}

ุชู ุณุญุจ (ุชูุจูู) ูู ุญุณุงุจ ุงูุทุงูุจ/ูุฉ:
{student}

ุงููุจูุบ: {amount} ุฑูุงู
ุงูุณุจุจ: {reason}

ููุชูุจูู ูุงููุชุงุจุนุฉ ๐ฟ`;

const TEMPLATE_TRANSFER =
`๐ ${TEACHER_BANK_TITLE}

ุชู ุชุญููู ูู ุญุณุงุจ ุงูุทุงูุจ/ูุฉ:
{student}

ุงููุจูุบ: {amount} ุฑูุงู
ุงูุณุจุจ: {reason}

ุดุงูุฑูู ุชุนุงูููู ๐ค`;

// ================== Firebase ==================
const firebaseConfig = {
  apiKey: "AIzaSyDP-pi0tbFQ9bNRihrLz_kUs-JBoa9Cw4Y",
  authDomain: "sara-haywire.firebaseapp.com",
  projectId: "sara-haywire",
  storageBucket: "sara-haywire.firebasestorage.app",
  messagingSenderId: "333467940977",
  appId: "1:333467940977:web:97d056d5dbff2debbf43d0",
  measurementId: "G-7RPQX9ER93"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ================== ุซูุงุจุช ==================
const TEACHER_EMAIL="as-soso-as2011@hotmail.com";
const WHATSAPP_NUMBER = "966502234335";

// ================== ุฃุณูุงุก ุงูุทูุงุจ ุงูุงูุชุฑุงุถูุฉ ==================
const DEFAULT_STUDENTS = {
  "ุณุงุฏุณ ุจููู": ["ุทูุงู ุงูุฑุญููู","ุนูู ุงูููุฑูู","ุนูุฑ ุตูุงู","ูุญูุฏ ุงูุนูุฒู","ุณุงูู ุขู ูุฎูุต","ุนุจุฏุงูููู ุงูุฌูุงุนู","ูููุฏ ุงููุงููู","ุณููุงู ุงูุฌููุฑ","ุฑุงูุงู ูุจุงุฑูู","ููุตู ุงููุญุทุงูู","ุฑูุงู ุงููุญุทุงูู","ูุญูุฏ ุฃุจู ุตุงูุญ","ูุงูู ุงูุนุตููู"],
  "ุณุงุฏุณ ุจูุงุช": ["ุฑูู ุงูุซุจูุชู","ุฌุงุฏู ุงูุฏูุณุฑู","ุฏุงูุฉ ุงููุญุทุงูู","ุชุงููู ูุชููู","ุฏููุง ุงูุญูุงุฏู","ุฑูู ุงูุฒูุฑุงูู","ูุงุฏู ุงูุนุชูุจู","ุฑูุฏููุง ุบุฑูุจ","ุงูุฌููุฑุฉ ุขู ูุฎูุต","ุฑูู ุขู ูุดุฑู"],
  "ุฃูู ูุชูุณุท": ["ุงููุงู ุจุงุบุฑูุจ","ุฏููุฉ ุงูุดูุฑู","ูุฌูุง ุงููุญุทุงูู","ุฏูู ุงูุบุงูุฏู","ููุณ ุงูุณูุงูุฉ","ูุงุฑูู ุงูุชู","ููุงู ุงููุญุงุฑูู","ุณุงุฑุฉ ุงูุบุงูุฏู"]
};

const PARENTS_PHONE = {
  "ุณุงูู ุขู ูุฎูุต": "0502402111",
  "ุงูุฌููุฑุฉ ุขู ูุฎูุต": "0502402111",
  "ุชุงููู ูุชููู": "0505220540",
  "ุฌุงุฏู ุงูุฏูุณุฑู": "0538118080",
  "ุฏุงูุฉ ุงููุญุทุงูู": "0555952003",
  "ุฑูู ุงูุนุชูุจู": "0543339829",
  "ูุงุฏู ุงูุนุชูุจู": "0532340737",
  "ุฑูู ุงูุฒูุฑุงูู": "0562580555",
  "ุฑูู ุขู ูุดุฑู": "054565589",
  "ุฏูู ุงูุญูุงุฏู": "0501222335",
  "ุฑูุฏููุง ุงูุบุฑูุจ": "0506925919",
  "ุฑุงูุงู ูุจุงุฑูู": "0559591061",
  "ุณููุงู ุงูุฌููุฑ": "053827904",
  "ุทูุงู ุงูุฑุญููู": "0598801283",
  "ูุญูุฏ ุจูุตุงูุญ": "0500125335",
  "ูุญูุฏ ุงูุนูุฒู": "0533264929",
  "ุนูู ุงูููุฑูู": "0563882235",
  "ูููุฏ ุงููุงููู": "0552582145",
  "ูุงูู ุงูุนุตููู": "0509799783",
  "ุนุจุฏุงูููู ุงูุฌูุงุนู": "0568027600",
  "ููุตู ุงููุญุทุงูู": "0507993660",
  "ุฑูุงู ุงููุญุทุงูู": "0555078508",
  "ุนูุฑ ุตูุงู": "0599831191",
  "ุฏููุฉ ุงูุดูุฑู": "0567509173",
  "ูุงุฑูู ุงูุชู": "0580662141",
  "ูุฌูุง ุงููุญุทุงูู": "0535952876",
  "ุงููุงู ุจุงุบุฑูุจ": "0542678280",
  "ุฏูู ุงูุบุงูุฏู": "0535912049",
  "ููุงู ุงููุญุงุฑูู": "0568135644",
  "ููุณ ุงูุณูุงูุฉ": "0580443424",
  "ุณุงุฑุฉ ุงูุบุงูุฏู": "0542743881"
};

// ================== ุฃุณุจุงุจ ุงูุนูููุงุช (ููุชุฑุฉ) ==================
const REASONS = {
  deposit: [
    "ุงูุชูุงุนู ูุงููุดุงุฑูุฉ ุงูุฅูุฌุงุจูุฉ",
    "ุงูุงูุชุฒุงู ุจุงูููุงููู ุงูุตููุฉ",
    "ุงูุงูุชุฒุงู ุจูุชุทูุจุงุช ุงููุงุฏุฉ ูุงูุญุตุฉ",
    "ุชููุฒ ูู ุงูุฃุฏุงุก ูุงูุณููู",
    "ุชุญุณู ููุญูุธ ูู ุงููุณุชูู ุฃู ุงูุณููู",
    "ุฃุฎุฑู"
  ],
  withdraw: [
    "ุนุฏู ุญู ุงููุงุฌุจ ุงูุฏุฑุงุณู",
    "ูุซุฑุฉ ุงูููุงู ูุงูุญุฑูุฉ ุฏุงุฎู ุงูุญุตุฉ",
    "ุงูููู ุฃุซูุงุก ุงูุญุตุฉ",
    "ุนุฏู ุงูุงูุชุฒุงู ุจุงูุฃุณููุจ ุงููุงุฆู ูุน ุงูุฒููุงุก",
    "ุนุฏู ุงูุงูุชุฒุงู ุจุงูุฃุณููุจ ุงููุงุฆู ูุน ุงููุนููุฉ",
    "ุงูุชุฃุฎุฑ ุนู ุญุตุฉ ุงูุฑูุงุถูุงุช ุฏูู ุนุฐุฑ",
    "ูุณูุงู ูุชุงุจ ุงูุฑูุงุถูุงุช",
    "ูุณูุงู ุงูุฏูุชุฑ",
    "ูุณูุงู ุงููุฐูุฑุฉ",
    "ุนุฏู ุฅุญุถุงุฑ ุฃุฏูุงุช ุงูุฑูุงุถูุงุช",
    "ุฃุฎุฑู"
  ],
  transfer: [
    "ุณุจุจ ุชุญูููู/ุชุญููู ุฑุตูุฏ",
    "ุชุณุฏูุฏ/ุฅุฑุฌุงุน ุฑุตูุฏ",
    "ูุณุงุนุฏุฉ ุฒููู/ูุฉ",
    "ุฃุฎุฑู"
  ]
};

function $(id){return document.getElementById(id);}

function openModal(title, bodyHtml, actionsHtml){
  $("mTitle").textContent=title;
  $("mBody").innerHTML=bodyHtml;
  $("mActions").innerHTML=actionsHtml||'<button class="btn" onclick="closeModal()">ููุงูู</button>';
  $("modal").style.display="flex";
}
function closeModal(){ $("modal").style.display="none"; }

function warn(msg){
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type="sine"; o.frequency.value=880; g.gain.value=0.12;
    o.connect(g); g.connect(ctx.destination); o.start();
    setTimeout(()=>{o.stop(); ctx.close();}, 140);
  }catch(e){}
  openModal("ุชูุจูู", msg);
}

function logout(){location.reload();}

function go(page){
  ["teacherLoginPage","classesPage","classPage","studentLoginPage","studentAccountPage"].forEach(id=>$(id)?.classList.add("hidden"));
  $(page)?.classList.remove("hidden");
}
function backToClasses(){ go("classesPage"); renderTabs(); }
function openClassPage(){ go("classPage"); renderStudents(); }
function backToClass(){
  // โ ูู ุฑุงุจุท ุงูุทูุงุจ: ุงูุฑุฌูุน ูุฑุฌุน ูุตูุญุฉ ุฏุฎูู ุงูุทุงูุจ
  if(IS_STUDENT_MODE){
    go("studentLoginPage");
    return;
  }
  go("classPage"); renderStudents();
}

function fmt(x){ return (Math.round((Number(x||0)+Number.EPSILON)*100)/100).toFixed(2); }

// ===== ุตูุช ุงูุชุฑุญูุจ =====
async function playWelcome(){
  const m4a = document.getElementById("welcomeM4a");
  const mp3 = document.getElementById("welcomeMp3");
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type="triangle"; o.frequency.value=740; g.gain.value=0.10;
    o.connect(g); g.connect(ctx.destination); o.start();
    setTimeout(()=>{o.stop(); ctx.close();}, 220);
  }catch(e){}
  try{ if(m4a){ m4a.currentTime=0; await m4a.play(); return; } }catch(e){}
  try{ if(mp3){ mp3.currentTime=0; await mp3.play(); return; } }catch(e){}
}

// ===== ุจุฏุก (โ ุชุนุฏูู ุจุณูุท ููุท) =====
async function startApp(){
  $("connPill").textContent = "ุฌุงูุฒ โ";
  $("connPill").style.background = "#dff4e3";
  $("connPill").style.color = "#2e7d32";
  playWelcome();
  $("startOverlay").style.display = "none";

  // โ ุฑุงุจุท ุงูุทูุงุจ
  if(IS_STUDENT_MODE){
    go("studentLoginPage");

    // ุชุฌููุฒ ุญูู ุงูุงุณู ุญุณุจ ุงูุฑุงุจุท
    const nameInput = $("stuName");
    if(nameInput){
      if(STUDENT_SID){
        nameInput.readOnly = true;
        nameInput.value = "ุฌุงุฑู ุชุญููู ุงูุงุณู...";
      }else{
        nameInput.readOnly = false;
        nameInput.value = STUDENT_NAME_Q ? decodeURIComponent(STUDENT_NAME_Q) : "";
        nameInput.placeholder = "ุงูุชุจ/ู ุงุณูู ููุง ูู ูุณุฌู";
      }
    }
    $("stuPin").value = "";
    $("stuLocked").classList.add("hidden");

    // ุฅุฐุง sid ููุฌูุฏ: ูุฌูุจ ุงูุทุงูุจ ูุจุงุดุฑุฉ
    if(STUDENT_SID){
      try{
        const doc = await db.collection("students").doc(STUDENT_SID).get();
        if(doc.exists){
          const s = doc.data() || {};
          currentStudentId = doc.id;
          if(nameInput){
            nameInput.value = s.name || "";
            nameInput.readOnly = true;
          }
        }else{
          if(nameInput){
            nameInput.value = "";
            nameInput.readOnly = false;
            nameInput.placeholder = "ุงูุชุจ/ู ุงุณูู ููุง ูู ูุณุฌู";
          }
        }
      }catch(e){
        if(nameInput){
          nameInput.value = "";
          nameInput.readOnly = false;
          nameInput.placeholder = "ุงูุชุจ/ู ุงุณูู ููุง ูู ูุณุฌู";
        }
      }
    }
    return;
  }

  // โ ุฑุงุจุท ุงููุนููุฉ
  go("teacherLoginPage");
}

// ===== ุชุณุฌูู ุงููุนููุฉ =====
function teacherLogin(){
  if($("tu").value.trim()==="teacher" && $("tp").value.trim()==="12345"){
    go("classesPage"); renderTabs();
  } else warn("ุจูุงูุงุช ุงูุฏุฎูู ุบูุฑ ุตุญูุญุฉ");
}
function forgotTeacher(){
  const subject=encodeURIComponent("ุงุณุชุฑุฌุงุน ุจูุงูุงุช ุฏุฎูู ูุตุฑู ุงูุฑูุงุถูุงุช");
  const body=encodeURIComponent("ุงูุณูุงู ุนููููุ\nุฃุฑุบุจ ุจุงุณุชุฑุฌุงุน ุจูุงูุงุช ุงูุฏุฎูู ููุตุฑู ุงูุฑูุงุถูุงุช.\nุดูุฑุงู.");
  window.location.href=`mailto:${TEACHER_EMAIL}?subject=${subject}&body=${body}`;
}

// ===== ูุงุฌูุฉ ุงูุฃุณุจุงุจ =====
function fillReasonSelect(selectEl, items){
  if(!selectEl) return;
  selectEl.innerHTML = "";
  items.forEach(r=>{
    const o = document.createElement("option");
    o.value = r;
    o.textContent = r;
    selectEl.appendChild(o);
  });
}
function setupReasonUI(mode, selectId, otherId){
  const sel = document.getElementById(selectId);
  const other = document.getElementById(otherId);
  if(!sel || !other) return;
  fillReasonSelect(sel, REASONS[mode] || ["ุฃุฎุฑู"]);
  const toggleOther = ()=>{
    if(sel.value === "ุฃุฎุฑู"){
      other.classList.remove("hidden");
    }else{
      other.classList.add("hidden");
      other.value = "";
    }
  };
  sel.onchange = toggleOther;
  toggleOther();
}
function getReason(selectId, otherId){
  const sel = document.getElementById(selectId);
  const other = document.getElementById(otherId);
  if(!sel) return "";
  if(sel.value === "ุฃุฎุฑู"){
    const t = (other?.value || "").trim();
    return t || "ุฃุฎุฑู";
  }
  return sel.value || "";
}

// ===== ุงูุชุญูู ูู "ูุณูุช ุงูุฑูู ุงูุณุฑู" ููุฌููุน =====
let forgotPinEnabled = true;

async function loadForgotSetting(){
  try{
    const doc = await db.collection("settings").doc("security").get();
    if(doc.exists){
      const d = doc.data() || {};
      if(typeof d.forgotPinEnabled === "boolean") forgotPinEnabled = d.forgotPinEnabled;
    }else{
      await db.collection("settings").doc("security").set({forgotPinEnabled:true});
      forgotPinEnabled = true;
    }
  }catch(e){
    forgotPinEnabled = true;
  }
  const link = document.querySelector('a[onclick="forgotStudentPin()"]');
  if(link) link.style.display = forgotPinEnabled ? "inline" : "none";
}

async function toggleForgotPinForAll(){
  try{
    forgotPinEnabled = !forgotPinEnabled;
    await db.collection("settings").doc("security").set({forgotPinEnabled}, {merge:true});
    openModal("ุชู โ", forgotPinEnabled ? "ุชู ุชูุนูู (ูุณูุช ุงูุฑูู ุงูุณุฑู) ููุฌููุน." : "ุชู ุชุนุทูู (ูุณูุช ุงูุฑูู ุงูุณุฑู) ููุฌููุน.");
  }catch(e){
    openModal("ุชูุจูู", "ุชุนุฐุฑ ุชุญุฏูุซ ุงูุฅุนุฏุงุฏ ุงูุขู.");
  }
  await loadForgotSetting();
}
function isForgotEnabled(){ return forgotPinEnabled === true; }

// ===== ููู ุงูุฃูุฑ =====
function normalizePhoneToWA(phone){
  let p = String(phone||"").replace(/[^0-9]/g,"");
  if(!p) return "";
  if(p.startsWith("00")) p = p.slice(2);
  if(p.startsWith("0")) p = "966" + p.slice(1);
  return p;
}

async function ensureGuardianPhone(studentId, studentName){
  const ref = db.collection("students").doc(studentId);
  const doc = await ref.get();
  if(!doc.exists) return "";
  const s = doc.data() || {};
  if(s.guardianWhats && String(s.guardianWhats).trim()) return String(s.guardianWhats).trim();
  const guess = PARENTS_PHONE[studentName] || "";
  if(guess){
    await ref.update({guardianWhats: guess});
    return guess;
  }
  return "";
}

async function editGuardianPhone(studentId, studentName){
  const ref = db.collection("students").doc(studentId);
  const doc = await ref.get();
  if(!doc.exists) return;
  const s = doc.data() || {};
  const current = (s.guardianWhats || PARENTS_PHONE[studentName] || "").toString();
  const nn = prompt("ุฑูู ููู ุงูุฃูุฑ (ูุซุงู: 05xxxxxxxx):", current);
  if(nn===null) return;
  await ref.update({guardianWhats: nn.trim()});
  openModal("ุชู โ", "ุชู ุญูุธ ุฑูู ููู ุงูุฃูุฑ.");
  await renderStudents();
}

async function sendPinToParent(studentId){
  const ref = db.collection("students").doc(studentId);
  const doc = await ref.get();
  if(!doc.exists) return;
  const s = doc.data() || {};
  const parent = await ensureGuardianPhone(studentId, s.name||"");
  const wa = normalizePhoneToWA(parent);
  if(!wa){
    openModal("ุชูุจูู", "ูุง ููุฌุฏ ุฑูู ููู ุฃูุฑ ูุณุฌู. ุงุถุบุท/ู (ุฑูู ููู ุงูุฃูุฑ) ูุฅุถุงูุชู.");
    return;
  }
  const msg = encodeURIComponent(
    "ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู\n\n" +
    "ุฑูู ุงูุฏุฎูู (PIN) ูุจูู ุงูุฑูุงุถูุงุช ููุทุงูุจ/ูุฉ: " + (s.name||"") + "\n" +
    "PIN: " + (s.pin||"") + "\n\n" +
    "ุดุงูุฑูู ุชุนุงูููู ๐ค"
  );
  const link = "https://wa.me/" + wa + "?text=" + msg;
  window.open(link, "_blank");
}

async function forgotStudentPin(){
  if(!isForgotEnabled()){
    openModal("ุชูุจูู","ุฎุฏูุฉ ุงุณุชุฑุฌุงุน ุงูุฑูู ุงูุณุฑู ูููููุฉ ูุคูุชูุง. ุฑุงุฌุน/ู ุงููุนููุฉ ๐ฟ");
    return;
  }
  try{
    const sid = currentStudentId;
    if(!sid){
      openModal("ุชูุจูู", "ุงุฎุชุงุฑ/ู ุงูุทุงูุจ ุฃููุงู.");
      return;
    }
    const ref = db.collection("students").doc(sid);
    const doc = await ref.get();
    if(!doc.exists) return;
    const s = doc.data() || {};
    const parent = await ensureGuardianPhone(sid, s.name||"");
    const wa = normalizePhoneToWA(parent);
    if(!wa){
      openModal("ุชูุจูู", "ูุง ููุฌุฏ ุฑูู ููู ุฃูุฑ ูุณุฌู. ุฑุงุฌุน/ู ุงููุนููุฉ.");
      return;
    }
    const msg = encodeURIComponent(
      "ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู\n\n" +
      "ุฑูู ุงูุฏุฎูู (PIN) ูุจูู ุงูุฑูุงุถูุงุช ููุทุงูุจ/ูุฉ: " + (s.name||"") + "\n" +
      "PIN: " + (s.pin||"") + "\n\n" +
      "ุดุงูุฑูู ุชุนุงูููู ๐ค"
    );
    const link = "https://wa.me/" + wa + "?text=" + msg;
    window.open(link, "_blank");
  }catch(e){
    console.log(e);
  }
}

// ===== ุจูุงูุงุช ุนุงูุฉ =====
let classes=[], currentClassId=null, currentStudentId=null;

// ===== ุฅูุดุงุก ุจูุงูุงุช ุงูุชุฑุงุถูุฉ =====
async function ensureSeed(){
  const c = await db.collection("classes").orderBy("order").get();
  if(c.empty){
    await db.collection("classes").add({name:"ุงูุตู ุณุงุฏุณ ุจููู",order:1});
    await db.collection("classes").add({name:"ุงูุตู ุณุงุฏุณ ุจูุงุช",order:2});
    await db.collection("classes").add({name:"ุงูุตู ุงูุฃูู ุงููุชูุณุท",order:3});
  }

  const c2 = await db.collection("classes").orderBy("order").get();
  const by = {};
  c2.forEach(d=>by[d.data().name]=d.id);

  const all = await db.collection("students").get();
  const existing = new Set();
  all.forEach(d=>{ const s=d.data(); if(s?.name) existing.add(String(s.name).trim()); });

  for(const clsName of Object.keys(DEFAULT_STUDENTS)){
    const classId = by[clsName];
    if(!classId) continue;
    for(const n0 of DEFAULT_STUDENTS[clsName]){
      const n = String(n0).trim();
      if(existing.has(n)) continue;
      const pin=String(Math.floor(1000+Math.random()*9000));
      await db.collection("students").add({
        name:n,classId,active:true,balance:0,pin,openedAt:null,
        guardianWhats:(PARENTS_PHONE[n]||"")
      });
      existing.add(n);
    }
  }
}

// ===== ุชุญููู ุงููุตูู =====
async function loadClasses(){
  const snap = await db.collection("classes").orderBy("order").get();
  classes=[]; snap.forEach(d=>classes.push({id:d.id,...d.data()}));
  if(!currentClassId) currentClassId = classes[0]?.id;
}
async function renderTabs(){
  await loadClasses();
  const tabs=$("classTabs"); tabs.innerHTML="";
  classes.forEach(c=>{
    const t=document.createElement("div");
    t.className="tab"+(c.id===currentClassId?" active":"");
    t.textContent=c.name;
    t.onclick=()=>{ currentClassId=c.id; renderTabs(); };
    tabs.appendChild(t);
  });
}

// ===== ุฅุฏุงุฑุฉ ุงููุตูู =====
async function addClass(){
  const n=$("newClassName").value.trim();
  if(!n) return warn("ุงูุชุจ ุงุณู ุงููุตู");
  const last=await db.collection("classes").orderBy("order","desc").limit(1).get();
  const max= last.empty?0:(last.docs[0].data().order||0);
  await db.collection("classes").add({name:n,order:max+1});
  $("newClassName").value="";
  await renderTabs();
}
async function renameClass(){
  const c=classes.find(x=>x.id===currentClassId); if(!c) return;
  const nn=prompt("ุงูุงุณู ุงูุฌุฏูุฏ ูููุตู:", c.name); if(!nn) return;
  await db.collection("classes").doc(currentClassId).update({name: nn.trim()});
  await renderTabs();
}
async function deleteClassMove(){
  if(classes.length<=1) return warn("ูุง ููุฏุฑ ูุญุฐู ุขุฎุฑ ูุตู");
  const others=classes.filter(c=>c.id!==currentClassId);
  const destName=prompt("ูููู ุทูุงุจ ุงููุตู ูุฃู ูุตูุ\n"+others.map(c=>c.name).join(" / "), others[0].name);
  if(!destName) return;
  const dest=classes.find(c=>c.name===destName); if(!dest) return warn("ุงุณู ุงููุตู ุบูุฑ ููุฌูุฏ");
  const studs=await db.collection("students").where("classId","==",currentClassId).get();
  const batch=db.batch();
  studs.forEach(d=>batch.update(db.collection("students").doc(d.id), {classId: dest.id}));
  batch.delete(db.collection("classes").doc(currentClassId));
  await batch.commit();
  currentClassId=null;
  await renderTabs();
}
async function syncStudentsToClasses(){
  await ensureSeed();
  openModal("ุชู โ","ุชู ุชุซุจูุช ุงูุฃุณูุงุก (ุฃู ุฅุถุงูุฉ ุงููุงูุต).");
  await renderTabs();
}

// ===== ุฅุฏุงุฑุฉ ุงูุทูุงุจ =====
async function addStudent(){
  const n=$("newStudentName").value.trim();
  if(!n) return warn("ุงูุชุจ ุงุณู ุงูุทุงูุจ");
  const pin=String(Math.floor(1000+Math.random()*9000));
  await db.collection("students").add({
    name:n,classId:currentClassId,active:true,balance:0,pin,openedAt:null,
    guardianWhats:(PARENTS_PHONE[n]||"")
  });
  $("newStudentName").value="";
  await renderStudents();
}

async function deleteStudent(studentId, studentName){
  if(!confirm("ุชุฃููุฏ ุญุฐู ุงูุทุงูุจ: " + studentName + " ุ")) return;
  try{
    const sref = db.collection("students").doc(studentId);
    const tx = await sref.collection("txns").limit(300).get();
    const batch = db.batch();
    tx.forEach(d=>batch.delete(d.ref));
    batch.delete(sref);
    await batch.commit();
  }catch(e){
    try{ await db.collection("students").doc(studentId).delete(); }catch(_){}
  }
  await renderStudents();
}

// ===== logTxn (โ ุชู ุชุนุฏูููุง ูุถูุงู ุงูุนูููุงุช ุงูููููุฉ ููุฑูุง) =====
async function logTxn(ref, type, reason, amount, balanceAfter, studentName, guardianWhats){
  const dateKey = new Date().toISOString().slice(0,10); // YYYY-MM-DD
  const createdAtClient = Date.now(); // ุชุฑุชูุจ ููุฑู

  await ref.collection("txns").add({
    type,
    reason: reason || "",
    amount,
    balanceAfter,
    studentName: studentName || "",
    guardianWhats: guardianWhats || "",

    // โ ููู ุฌุฏูุง ููุนูููุงุช ุงูููููุฉ
    dateKey,
    createdAtClient,

    // ูุจูู ููุนุฑุถ ูุงุญููุง
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
}

async function renderStudents(){
  const snap = await db.collection("students").where("classId","==",currentClassId).get();
  const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
  arr.sort((a,b)=>(a.name||"").localeCompare(b.name||"","ar"));

  const pick=$("pickStudent"); pick.innerHTML="";
  arr.forEach(s=>{ const o=document.createElement("option"); o.value=s.id; o.textContent=s.name; pick.appendChild(o); });

  const grid=$("studentsGrid"); grid.innerHTML="";
  arr.forEach(s=>{
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <strong>${s.name}</strong>
      <div class="small">ุงูุฑุตูุฏ: ${fmt(s.balance)} ุฑ.ุณ</div>
      <div class="small">PIN: <b>${s.pin||""}</b></div>
      <span class="badge ${s.active?'on':'off'}">${s.active?'๐ข ููุนู':'๐ด ูููู'}</span>
      <div class="row" style="margin-top:8px">
        <button class="btn2 col js-open">ุฏุฎูู ุงูุทุงูุจ</button>
        <button class="btn3 col js-toggle">${s.active?'ุฅููุงู':'ุชูุนูู'}</button>
        <button class="btn3 col js-edit">ุชุนุฏูู ุงูุงุณู</button>
        <button class="btn3 col js-parent">ุฑูู ููู ุงูุฃูุฑ</button>
        <button class="btn whatsapp-btn col js-sendpin">ุฅุฑุณุงู PIN</button>
        <button class="btnRed col js-del">ุญุฐู</button>
      </div>
    `;
    card.querySelector(".js-open").onclick=()=>{ currentStudentId=s.id; showStudentLogin(s); };
    card.querySelector(".js-toggle").onclick=async()=>{ await db.collection("students").doc(s.id).update({active:!s.active}); await renderStudents(); };
    card.querySelector(".js-edit").onclick=async()=>{ const nn=prompt("ุงูุงุณู ุงูุฌุฏูุฏ:", s.name); if(nn) await db.collection("students").doc(s.id).update({name:nn.trim()}); await renderStudents(); };
    if(card.querySelector(".js-parent")) card.querySelector(".js-parent").onclick=()=> editGuardianPhone(s.id, s.name);
    if(card.querySelector(".js-sendpin")) card.querySelector(".js-sendpin").onclick=()=> sendPinToParent(s.id);
    card.querySelector(".js-del").onclick=()=> deleteStudent(s.id, s.name);
    grid.appendChild(card);
  });
}

// ===== ุนูููุงุช ุงููุนููุฉ =====
async function depositAll(){
  const a=parseFloat($("bulkAmount").value);
  if(isNaN(a)||a<=0) return warn("ุงูุชุจ ูุจูุบ ุงูุฅูุฏุงุน ูููู");
  const studs=await db.collection("students").where("classId","==",currentClassId).get();

  const batch=db.batch();
  for(const d of studs.docs){
    const s=d.data(); if(!s.active) continue;
    batch.update(db.collection("students").doc(d.id), {balance:Number(s.balance||0)+a});
  }
  await batch.commit();

  for(const d of studs.docs){
    const s=d.data(); if(!s.active) continue;
    await logTxn(
      db.collection("students").doc(d.id),
      "ุฅูุฏุงุน ุฌูุงุนู",
      getReason("reasonTeacher","reasonOtherTeacher"),
      a,
      Number(s.balance||0)+a,
      s.name,
      s.guardianWhats||""
    );
  }
  $("bulkAmount").value="";
  await renderStudents();
}

async function withdrawAll(){
  const a=parseFloat($("bulkWithdrawAmount").value);
  if(isNaN(a)||a<=0) return warn("ุงูุชุจ ูุจูุบ ุงูุณุญุจ ูู ุงููู");
  const studs=await db.collection("students").where("classId","==",currentClassId).get();

  for(const d of studs.docs){
    const s=d.data(); if(!s.active) continue;
    if(Number(s.balance||0) < a) return warn("ูู ุทุงูุจ ุฑุตูุฏู ูุง ููููโฆ ููู ุงููุจูุบ");
  }

  const batch=db.batch();
  for(const d of studs.docs){
    const s=d.data(); if(!s.active) continue;
    batch.update(db.collection("students").doc(d.id), {balance:Number(s.balance||0)-a});
  }
  await batch.commit();

  for(const d of studs.docs){
    const s=d.data(); if(!s.active) continue;
    await logTxn(
      db.collection("students").doc(d.id),
      "ุณุญุจ ุฌูุงุนู (ูุนููุฉ)",
      getReason("reasonTeacher","reasonOtherTeacher"),
      a,
      Number(s.balance||0)-a,
      s.name,
      s.guardianWhats||""
    );
  }
  $("bulkWithdrawAmount").value="";
  await renderStudents();
}

function lockedModal(studentName){
  studentName = studentName || "";
  const msg = encodeURIComponent(
    "ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู\n\n" +
    "ุฃูุง ุงูุทุงูุจุฉ/ุงูุทุงูุจ: " + studentName + "\n" +
    "ูุถูุงู ุฃุฑุฌู ุชูุนูู ุญุณุงุจู\n" +
    "ูุฃููู ุดุงูุฑุฉ ูู ๐ธ"
  );
  const waLink = "https://wa.me/" + WHATSAPP_NUMBER + "?text=" + msg;

  openModal(
    "ุชูุจูู",
    "ุญูุงู ุงููู ๐ค๐ค<br>ุญุณุงุจู ูููู ูุคูุชูุงุ ูุง ุชููู/ูู.<br><br>ููุชูุนูู ุชูุงุตู/ูู ูุน ุงููุนููุฉ ุนูู ุฏุฑุฏุดุฉ ุชุทุจูู WhatsApp ๐",
    '<a class="btn whatsapp-btn" href="' + waLink + '" target="_blank">๐ฑ ูุฑุงุณูุฉ WhatsApp</a>' +
    '<button class="btn3" onclick="closeModal()">ุฅุบูุงู</button>'
  );
}

async function depositToStudent(){
  const sid = $("pickStudent").value;
  const a = parseFloat($("pickAmount").value);
  if(!sid) return warn("ุงุฎุชุฑ ุทุงูุจ");
  if(isNaN(a) || a<=0) return warn("ุงูุชุจ ูุจูุบ");

  const ref = db.collection("students").doc(sid);
  const doc = await ref.get();
  const s = doc.data();

  if(!s.active){ playWelcome(); lockedModal(s.name); return; }

  const nb = Number(s.balance||0) + a;
  await ref.update({balance: nb});
  await logTxn(ref, "ุฅูุฏุงุน (ูุนููุฉ)", getReason("reasonTeacher","reasonOtherTeacher"), a, nb, s.name, s.guardianWhats||"");
  $("pickAmount").value = "";
  await renderStudents();
}

async function withdrawFromStudent(){
  const sid = $("pickStudent").value;
  const a = parseFloat($("pickAmount").value);
  if(!sid) return warn("ุงุฎุชุฑ ุทุงูุจ");
  if(isNaN(a) || a<=0) return warn("ุงูุชุจ ูุจูุบ");

  const ref = db.collection("students").doc(sid);
  const doc = await ref.get();
  const s = doc.data();

  if(!s.active){ playWelcome(); lockedModal(s.name); return; }
  if(Number(s.balance||0) < a) return warn("ุฑุตูุฏู ูุง ูููู");

  const nb = Number(s.balance||0) - a;
  await ref.update({balance: nb});
  await logTxn(ref, "ุณุญุจ (ูุนููุฉ)", getReason("reasonTeacher","reasonOtherTeacher"), a, nb, s.name, s.guardianWhats||"");
  $("pickAmount").value = "";
  await renderStudents();
}

// ===== ุฏุฎูู ุงูุทุงูุจ =====
function showStudentLogin(s){
  go("studentLoginPage");
  $("stuLoginTitle").textContent="ุฏุฎูู ุงูุทุงูุจ โ " + (classes.find(c=>c.id===currentClassId)?.name || "");
  $("stuName").value=s.name;
  $("stuName").readOnly = true;
  $("stuPin").value="";
  $("stuLocked").classList.add("hidden");

  if(!s.active){
    playWelcome();
    lockedModal(s.name);
  }
}

async function renderOpenedAt(){
  const doc=await db.collection("students").doc(currentStudentId).get();
  const s=doc.data();
  $("openedAt").textContent = (s.openedAt && s.openedAt.toDate) ? s.openedAt.toDate().toLocaleString("ar-SA") : "โ";
}

async function buildTransferList(){
  const snap=await db.collection("students").get();
  const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
  arr.sort((a,b)=>(a.name||"").localeCompare(b.name||"","ar"));
  $("transferTo").innerHTML="";
  arr.forEach(s=>{ if(s.id===currentStudentId) return; const o=document.createElement("option"); o.value=s.id; o.textContent=s.name; $("transferTo").appendChild(o); });
}

// ===== ุฏุฎูู ุงูุทุงูุจ (โ ูุฏุนู ุฑุงุจุท ุงูุทูุงุจ) =====
async function studentLogin(){
  try{
    // โ ุฅุฐุง ุฑุงุจุท ุงูุทูุงุจ: ูุญุฏุฏ ุงูุทุงูุจ ูู sid ุฃู ุงูุงุณู
    if(IS_STUDENT_MODE){
      let sid = currentStudentId;

      if(!sid){
        const name = ($("stuName").value || "").trim();
        if(!name) return warn("ุงูุชุจ/ู ุงุณูู");
        const snap = await db.collection("students").where("name","==",name).limit(1).get();
        if(snap.empty) return warn("ุงูุงุณู ุบูุฑ ูุณุฌู ุจุงููุธุงู");
        sid = snap.docs[0].id;
        currentStudentId = sid;
      }

      const ref = db.collection("students").doc(sid);
      const doc = await ref.get();
      if(!doc.exists) return warn("ุงูุญุณุงุจ ุบูุฑ ููุฌูุฏ");
      const s = doc.data() || {};

      if(!s.active){ lockedModal(s.name); return; }
      if($("stuPin").value.trim()!==String(s.pin||"")) return warn("ุงูุฑูู ุงูุณุฑู ุบูุท");
      if(!s.openedAt) await ref.update({openedAt: firebase.firestore.FieldValue.serverTimestamp()});

      playWelcome();

      go("studentAccountPage");
      $("studentHeader").textContent=s.name;
      $("statusBadge").className="badge "+(s.active?"on":"off");
      $("statusBadge").textContent=s.active?"๐ข ูุดุท":"๐ด ูููู";
      $("studentBalance").textContent=fmt(s.balance);

      await renderOpenedAt();
      await buildTransferList();
      await showStatement();
      return;
    }

    // โ ูุถุน ุงููุนููุฉ (ููุง ูุงู)
    const ref=db.collection("students").doc(currentStudentId);
    const doc=await ref.get();
    const s=doc.data();

    if(!s.active){ lockedModal(s.name); return; }
    if($("stuPin").value.trim()!==String(s.pin||"")) return warn("ุงูุฑูู ุงูุณุฑู ุบูุท");
    if(!s.openedAt) await ref.update({openedAt: firebase.firestore.FieldValue.serverTimestamp()});

    playWelcome();

    go("studentAccountPage");
    $("studentHeader").textContent=s.name;
    $("statusBadge").className="badge "+(s.active?"on":"off");
    $("statusBadge").textContent=s.active?"๐ข ูุดุท":"๐ด ูููู";
    $("studentBalance").textContent=fmt(s.balance);

    await renderOpenedAt();
    await buildTransferList();
    await showStatement();

  }catch(e){
    console.log(e);
    warn("ุตุงุฑ ุฎุทุฃโฆ ุฌุฑูุจู ูุฑุฉ ุซุงููุฉ");
  }
}

// ===== ูุดู ุงูุญุณุงุจ =====
async function showStatement(){
  const from=$("fromDate").value;
  const to=$("toDate").value;

  let q = db.collection("students").doc(currentStudentId).collection("txns")
    .orderBy("createdAt","desc").limit(50);

  if(from && to){
    const fromD=new Date(from+"T00:00:00");
    const toD=new Date(to+"T23:59:59");
    q = db.collection("students").doc(currentStudentId).collection("txns")
      .where("createdAt", ">=", fromD)
      .where("createdAt", "<=", toD)
      .orderBy("createdAt","desc")
      .limit(100);
  }

  const snap=await q.get();
  const rows=$("stmtRows"); rows.innerHTML="";
  if(snap.empty){
    rows.innerHTML='<tr><td colspan="5" class="small">ูุง ููู ุนูููุงุช ุจูุงููุชุฑุฉโฆ</td></tr>';
    return;
  }
  snap.forEach(d=>{
    const x=d.data();
    const t=x.createdAt?.toDate?x.createdAt.toDate().toLocaleString("ar-SA"):"";
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${t}</td><td>${x.type||""}</td><td>${x.reason||""}</td><td>${fmt(x.amount)}</td><td>${fmt(x.balanceAfter)}</td>`;
    rows.appendChild(tr);
  });
}

// ===== ุนูููุงุช ุฏุงุฎู ุญุณุงุจ ุงูุทุงูุจ =====
async function executeOp(){
  const ref=db.collection("students").doc(currentStudentId);
  const doc=await ref.get();
  const s=doc.data();
  const op=$("op").value;
  const amt=parseFloat($("amt").value);
  if(isNaN(amt)||amt<=0) return warn("ุงูุชุจ ูุจูุบ ุตุญูุญ");

  const reason = getReason("reasonStudent","reasonOtherStudent");

  if(op==="deposit"){
    const nb=Number(s.balance||0)+amt;
    await ref.update({balance:nb});
    await logTxn(ref, "ุฅูุฏุงุน", reason, amt, nb, s.name, s.guardianWhats||"");
  }else if(op==="withdraw"){
    if(Number(s.balance||0) < amt) return warn("ุงูุฑุตูุฏ ูุง ูููู");
    const nb=Number(s.balance||0)-amt;
    await ref.update({balance:nb});
    await logTxn(ref, "ุณุญุจ", reason, amt, nb, s.name, s.guardianWhats||"");
  }else if(op==="transfer"){
    if(Number(s.balance||0) < amt) return warn("ุงูุฑุตูุฏ ูุง ูููู ููุชุญููู");
    const toId=$("transferTo").value;
    const toRef=db.collection("students").doc(toId);
    const toDoc=await toRef.get();
    if(!toDoc.exists) return warn("ุงููุณุชูู ูู ููุฌูุฏ");
    const to=toDoc.data();

    const batch=db.batch();
    batch.update(ref, {balance:Number(s.balance||0)-amt});
    batch.update(toRef, {balance:Number(to.balance||0)+amt});
    await batch.commit();

    await logTxn(ref, "ุชุญููู ุฅูู "+to.name, reason, amt, Number(s.balance||0)-amt, s.name, s.guardianWhats||"");
    await logTxn(toRef, "ุชุญููู ูู "+(doc.data().name||"ุทุงูุจ"), reason, amt, Number(to.balance||0)+amt, to.name, to.guardianWhats||"");
  }

  $("amt").value="";
  const updated=await ref.get();
  $("studentBalance").textContent=fmt(updated.data().balance);
  await showStatement();
}

// ================== ุงูุนูููุงุช ุงูููููุฉ ==================
let dailyOpsCache = [];

async function loadDailyOps(){
  const inp = document.getElementById("dailyDate");
  const chosenStr = inp.value ? inp.value : new Date().toISOString().slice(0,10);
  if(!inp.value) inp.value = chosenStr;

  const snap = await db.collectionGroup("txns")
    .where("dateKey", "==", chosenStr)
    .orderBy("createdAtClient","desc")
    .limit(300)
    .get();

  dailyOpsCache = [];
  snap.forEach(doc => dailyOpsCache.push(doc.data() || {}));

  renderDailyOps();
}

function renderDailyOps(){
  const box = document.getElementById("dailyOpsList");
  if(!dailyOpsCache.length){
    box.innerHTML = '<div class="small">ูุง ููู ุนูููุงุช ูู ูุฐุง ุงูุชุงุฑูุฎ.</div>';
    return;
  }

  box.innerHTML = dailyOpsCache.map(x=>{
    const t = x.createdAt?.toDate
      ? x.createdAt.toDate().toLocaleString("ar-SA")
      : (x.createdAtClient ? new Date(x.createdAtClient).toLocaleString("ar-SA") : "");

    return `
      <div class="card" style="margin:8px 0">
        <div><b>${x.studentName || "โ"}</b></div>
        <div class="small">ุงูููุช: ${t}</div>
        <div class="small">ุงูุนูููุฉ: ${x.type || "โ"}</div>
        <div class="small">ุงููุจูุบ: ${x.amount ?? ""} ุฑ.ุณ</div>
        <div class="small">ุงูุณุจุจ: ${x.reason || "โ"}</div>
      </div>
    `;
  }).join("");
}

function formatTemplate(tpl, data){
  return tpl
    .replaceAll("{student}", data.student || "")
    .replaceAll("{amount}", String(data.amount ?? ""))
    .replaceAll("{reason}", data.reason || "โ");
}

function buildDailyMessage(op){
  const type = (op.type || "");
  const data = {student: op.studentName || "", amount: op.amount, reason: op.reason || "โ"};
  if(type.includes("ุฅูุฏุงุน")) return formatTemplate(TEMPLATE_DEPOSIT, data);
  if(type.includes("ุณุญุจ")) return formatTemplate(TEMPLATE_WITHDRAW, data);
  if(type.includes("ุชุญููู")) return formatTemplate(TEMPLATE_TRANSFER, data);
  return formatTemplate(TEMPLATE_TRANSFER, data);
}

function waLinkForOp(op){
  const phone = normalizePhoneToWA(op.guardianWhats || "");
  if(!phone) return "";
  const msg = buildDailyMessage(op);
  return "https://wa.me/" + phone + "?text=" + encodeURIComponent(msg);
}

function sendDailyOpsWhats(){
  if(!dailyOpsCache.length){
    openModal("ุชูุจูู","ูุง ุชูุฌุฏ ุนูููุงุช ููุฅุฑุณุงู.");
    return;
  }

  const links = dailyOpsCache.map(waLinkForOp).filter(Boolean);
  if(!links.length){
    openModal("ุชูุจูู","ูุง ุชูุฌุฏ ุฃุฑูุงู ุฃูููุงุก ุฃููุฑ ูุณุฌูุฉ ููุฐู ุงูุนูููุงุช.");
    return;
  }

  const maxOpen = 10;
  links.slice(0, maxOpen).forEach((l,i)=>{
    setTimeout(()=> window.open(l, "_blank"), i*450);
  });

  if(links.length > maxOpen){
    openModal("ููุงุญุธุฉ",
      `ุชู ูุชุญ ${maxOpen} ุฑุณุงุฆู ูุงุชุณุงุจ ุงูุขู.\nุงุถุบุท ุงูุฒุฑ ูุฑุฉ ุซุงููุฉ ูุฅููุงู ุงูุจุงูู.`,
      '<button class="btn" onclick="closeModal()">ููุงูู</button>'
    );
    dailyOpsCache = dailyOpsCache.slice(maxOpen);
    renderDailyOps();
  }
}

// ===== ุชููุฆุฉ ุนูุฏ ุงูุชุญููู =====
document.addEventListener("DOMContentLoaded", () => {
  // ุชุนุฏูู ูุต ุงูุจุฏุงูุฉ ููุท ูู ุฑุงุจุท ุงูุทูุงุจ (ุจุฏูู ุชุบููุฑ ุชุตููู)
  if(IS_STUDENT_MODE){
    const t = document.getElementById("startText");
    if(t) t.innerHTML = "ุฌุงูุฒูู ูุจุฏุฃ ุฑุญูุฉ ุจูู ุงูุฑูุงุถูุงุช ููุทูุงุจุ<br>ุงุถุบุท ุฒุฑ ุงูุจุฏุงูุฉ ูููุทูู ๐";
  }

  const opSel = document.getElementById('op');
  if(opSel){
    setupReasonUI(opSel.value, 'reasonStudent', 'reasonOtherStudent');
    opSel.addEventListener('change', ()=> setupReasonUI(opSel.value, 'reasonStudent', 'reasonOtherStudent'));
  }
  setupReasonUI('withdraw', 'reasonTeacher', 'reasonOtherTeacher');
  loadForgotSetting();
});

// ===== ุชุดุบูู ุฃููู =====
(async()=>{
  try{
    await ensureSeed();
    await renderTabs();
    $("connPill").textContent="ุฌุงูุฒ โ";
    $("connPill").style.background="#dff4e3";
    $("connPill").style.color="#2e7d32";
  }catch(e){
    $("connPill").textContent="ุฌุงูุฒ โ";
  }
})();
</script>

</body>
</html>
