<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª â€“ Ø§Ù„Ù…ØµØ±ÙÙŠ Ù„Ù„Ù…Ø¹Ù„Ù…Ø© Ø³Ø§Ø±Ø© Ø­Ù‚ÙˆÙŠ</title>

  <style>
    :root{
      --navy:#00205B; --rajhi:#0055A4; --sky:#EAF3FB; --sky2:#CFE6F7; --beige:#FAF9F7;
      --green:#2e7d32; --red:#b00020; --text:#1b1f23;
    }

    .whatsapp-btn{background:#25D366 !important;color:#fff !important;font-weight:700;}
    .whatsapp-btn:hover{ background:#1ebe5d !important; }

    *{box-sizing:border-box;font-family:Tahoma,Arial,sans-serif}
    body{margin:0;background:var(--beige);color:var(--text)}
    .hidden{display:none}

    .topbar{
      position:sticky;top:0;z-index:2000;
      background:linear-gradient(90deg,var(--navy),var(--rajhi));
      color:#fff;padding:12px 14px;display:flex;align-items:center;gap:12px;
    }
    .topbar .titles{flex:1;text-align:center;line-height:1.35}
    .topbar .t1{font-weight:800;font-size:16px}
    .topbar .t2{font-size:12px;opacity:.95}
    .logo{height:56px;width:auto;background:rgba(255,255,255,.78);border-radius:12px;padding:6px}

    .footer{
      text-align:center;
      padding:14px 12px;
      color:#fff;
      opacity:.95;
      font-weight:800;
      background:linear-gradient(90deg,var(--navy),var(--rajhi));
      margin-top:12px;
    }

    .container{max-width:980px;margin:14px auto;padding:0 12px}
    .card{background:#fff;border-radius:14px;padding:14px;margin:10px 0;box-shadow:0 8px 18px rgba(0,0,0,.06)}
    .card.soft{background:var(--sky)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1;min-width:160px}
    input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #ccc;font-size:14px}
    button{border:0;border-radius:10px;padding:10px 12px;cursor:pointer;font-size:14px}
    .btn{background:var(--rajhi);color:#fff}
    .btn2{background:var(--sky2);color:#003}
    .btn3{background:#eef6fb;color:#003}
    .btnRed{background:var(--red);color:#fff}

    .tabs{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:10px 0}
    .tab{background:#e9f4fb;color:#003;padding:8px 12px;border-radius:999px;cursor:pointer;font-size:14px}
    .tab.active{background:var(--rajhi);color:#fff}

    .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(max-width:760px){.grid2{grid-template-columns:1fr}}

    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px}
    .badge.on{background:#dff4e3;color:var(--green)}
    .badge.off{background:#fde2e2;color:var(--red)}
    .small{font-size:12px;color:#666}
    hr{border:0;border-top:1px solid #eee;margin:10px 0}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:18px;z-index:9999}
    .modalBox{background:#fff;border-radius:16px;max-width:680px;width:100%;padding:16px;text-align:center}
    .modalBox h3{margin:0 0 8px 0;color:var(--navy)}
    .modalBox p{margin:0 0 12px 0;font-size:15px;line-height:1.7;white-space:pre-line}
    .modalActions{display:flex;gap:10px;flex-wrap:wrap}
    .modalActions a,.modalActions button{flex:1;text-decoration:none}

    /* âœ… Splash Screen (ÙŠØ¸Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹) */
    #splashScreen{
      position:fixed;
      inset:0;
      z-index:10000;
      background:#061c45;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    #splashLogo{
      transform:translateX(120vw) scale(2);
      transition:all 1.2s cubic-bezier(.2,.9,.2,1);
    }
    #splashText{
      color:white;
      text-align:center;
      transform:translateX(-120vw);
      opacity:0;
      transition:all 1.2s cubic-bezier(.2,.9,.2,1);
    }

    /* Start overlay (ÙˆØ§Ø¬Ù‡Ø© Ø§Ø¨Ø¯Ø£) */
    #startOverlay{
      position:fixed;inset:0;
      background: radial-gradient(circle at top, #0b2a66 0%, #061a3d 55%, #04112a 100%);
      display:none;
      align-items:center;justify-content:center;padding:18px;z-index:9998
    }
    .startBox{
      max-width:560px;width:100%;
      background:rgba(255,255,255,.94);
      border:1px solid rgba(255,255,255,.18);
      border-radius:18px;padding:18px;text-align:center;
      box-shadow:0 10px 30px rgba(0,0,0,.25)
    }
    .pill{display:inline-block;background:#e9f4fb;color:#003;padding:6px 10px;border-radius:999px;font-size:12px;margin-bottom:10px}

    .splashWrap{display:flex;align-items:center;justify-content:center;gap:14px;margin:8px 0 2px 0;flex-wrap:wrap}
    .splashLogo{
      width:96px;height:96px;border-radius:50%;
      background:#fff;border:2px solid rgba(0,32,91,.12);
      box-shadow:0 12px 24px rgba(0,0,0,.18);
      overflow:hidden;display:flex;align-items:center;justify-content:center;
      transform: translateX(42px);opacity:0;
      animation: slideInR .7s ease-out forwards;
    }
    .splashLogo img{width:100%;height:100%;object-fit:cover}
    .splashText2{
      text-align:right;
      transform: translateX(-42px);opacity:0;
      animation: slideInL .7s ease-out forwards;
      animation-delay:.08s;
    }
    .splashText2 .ar{font-weight:900;color:#00205B;font-size:20px;line-height:1.2}
    .splashText2 .en{font-weight:800;color:#0055A4;font-size:14px;margin-top:2px}
    .splashText2 .name{font-weight:800;color:#1b1f23;font-size:13px;margin-top:4px}
    @keyframes slideInR{to{transform:translateX(0);opacity:1}}
    @keyframes slideInL{to{transform:translateX(0);opacity:1}}

    @media(max-width:520px){
      .startBox{padding:14px}
      button{padding:12px 12px;font-size:15px}
      input,select{padding:12px;font-size:15px}
    }

    /* Statement */
    .tableWrap{overflow:auto;border-radius:12px;background:#f7fbff;border:1px solid #e6eef7}
    table{width:100%;border-collapse:collapse;min-width:740px}
    th,td{padding:10px;border-bottom:1px solid #e6eef7;text-align:center;font-size:13px;white-space:nowrap}
    th{background:#eef6ff;color:#0b2a66}
    tr:last-child td{border-bottom:none}

    /* checkbox select students */
    .selRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .selTag{display:flex;gap:8px;align-items:center;background:#eef6ff;border:1px solid #dfeaff;border-radius:999px;padding:6px 10px;font-size:12px;color:#003}
    .selTag input{width:auto}

    /* âœ… Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…Ù„ÙŠØ© ÙŠÙˆÙ…ÙŠØ© */
    .opCard.selected{outline:2px solid var(--rajhi); background:#f3f9ff}
    .dailyPickRow{display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap}
    .dailyPickLeft{display:flex;align-items:center;gap:10px}
    .dailyPickLeft input{width:auto}
    .dailySelectedHint{color:var(--green);font-weight:800}

    /* ================== Onboarding (Ø¨Ø¹Ø¯ Ø§Ø¨Ø¯Ø£) ================== */
    #onboardOverlay{
      position:fixed; inset:0; z-index:9997;
      background: radial-gradient(circle at top, #0b2a66 0%, #061a3d 55%, #04112a 100%);
      display:none; align-items:center; justify-content:center; padding:18px;
    }
    .onbBox{
      width:min(640px, 100%);
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      box-shadow:0 14px 40px rgba(0,0,0,.35);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .onbTop{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 14px;
      background:rgba(0,0,0,.18);
      color:#fff;
      font-weight:900;
    }
    .onbSkip{
      background:rgba(255,255,255,.16);
      color:#fff;
      border-radius:999px;
      padding:6px 12px;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.18);
    }
    .onbBody{padding:14px}

    .onbViewport{
      overflow:hidden;
      width:100%;
      position:relative;
      direction:ltr;
      touch-action: pan-y; /* ÙŠÙ…Ù†Ø¹ Ø³Ø­Ø¨ Ø§Ù„ØµÙØ­Ø© ÙˆÙŠØ«Ø¨Øª Ø§Ù„Ø³Ù„Ø§ÙŠØ¯ */
      -webkit-user-select:none;
      user-select:none;
    }

    .onbTrack{
      display:flex;
      width:300%;
      transition:transform .35s ease;
      will-change: transform;
    }

    .onbSlide{
      flex:0 0 100%;
      min-height:260px;
      background:#061c45;
      color:#fff;
      border-radius:20px;
      padding:28px 20px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      direction:rtl;
      box-shadow:0 14px 34px rgba(0,0,0,.22);
    }

    .onbIcon{
      width:72px;height:72px;
      border-radius:18px;
      background:rgba(255,255,255,.12);
      display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,.12);
    }
    .onbIcon svg path{ stroke:#fff !important; } /* âœ… Ø¹Ø´Ø§Ù† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù…Ø§ ØªØ®ØªÙÙŠ */

    .onbTitle{
      font-size:18px;
      font-weight:900;
      color:#fff;
      margin-top:12px;
    }

    .onbText{
      font-size:14px;
      line-height:1.9;
      margin-top:8px;
      color:rgba(255,255,255,.92);
      max-width:520px;
    }

    .onbDots{
      display:flex;
      gap:6px;
      justify-content:center;
      margin-top:12px;
    }
    .onbDot{
      width:7px;height:7px;border-radius:999px;
      background:rgba(255,255,255,.35);
    }
    .onbDot.active{
      width:18px;
      background:#fff;
    }
  </style>
</head>

<body>
  <!-- âœ… Splash Screen -->
  <div id="splashScreen">
    <div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap;justify-content:center">
      <div id="splashLogo">
        <img src="logo.png" alt="logo" style="width:260px;height:260px;border-radius:50%;background:white;padding:14px">
      </div>
      <div id="splashText">
        <div style="font-size:34px;font-weight:900">Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</div>
        <div style="font-size:18px;margin-top:6px">Math Bank</div>
        <div style="font-size:16px;margin-top:6px">Ø£. Ø³Ø§Ø±Ø© Ø­Ù‚ÙˆÙŠ</div>
        <div style="font-size:13px;margin-top:14px;opacity:.85">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      </div>
    </div>
  </div>

  <div class="topbar">
    <img class="logo" src="school-logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©">
    <div class="titles">
      <div class="t1">Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª â€“ Ø§Ù„Ù…ØµØ±ÙÙŠ Ù„Ù„Ù…Ø¹Ù„Ù…Ø© Ø³Ø§Ø±Ø© Ø­Ù‚ÙˆÙŠ</div>
      <div class="t2">Ù…Ø¯Ø±Ø³Ø© Ø±ÙˆØ§Ø¯ Ø§Ù„Ø´Ø±Ù‚ Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</div>
    </div>
    <div style="width:56px"></div>
  </div>

  <audio id="welcomeMp3" preload="auto" src="welcome.mp3"></audio>
  <audio id="welcomeM4a" preload="auto" src="welcome.m4a"></audio>

  <div id="startOverlay">
    <div class="startBox">
      <div class="pill" id="connPill">...Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù†Ø¸Ø§Ù…...</div>

      <div class="splashWrap">
        <div class="splashLogo"><img src="logo.png" alt="Math Bank Logo"></div>
        <div class="splashText2">
          <div class="ar">Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</div>
          <div class="en">Math Bank</div>
          <div class="name">Ø£. Ø³Ø§Ø±Ø© Ø­Ù‚ÙˆÙŠ</div>
        </div>
      </div>

      <h3 style="margin:8px 0 6px 0;color:var(--navy)">Ù‡Ù„Ø§ ÙˆØ§Ù„Ù„Ù‡! ğŸ‘‹</h3>
      <p id="startP">Ø¬Ø§Ù‡Ø²ÙŠÙ† Ù†Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙ†Ø§ ÙÙŠ Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§ØªØŸ<br>Ø§Ø¶ØºØ· Ø²Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆÙ†Ù†Ø·Ù„Ù‚ ğŸš€</p>
      <button class="btn" onclick="startApp()">Ø§Ø¨Ø¯Ø£</button>
      <div class="small" id="connNote" style="margin-top:8px"></div>
    </div>
  </div>

  <div id="modal" class="modal">
    <div class="modalBox">
      <h3 id="mTitle"></h3>
      <p id="mBody"></p>
      <div class="modalActions" id="mActions">
        <button class="btn" onclick="closeModal()">Ù…ÙˆØ§ÙÙ‚</button>
      </div>
    </div>
  </div>

  <!-- âœ… Onboarding Ø¨Ø¹Ø¯ Ø§Ø¨Ø¯Ø£ (Ø³Ø­Ø¨ ÙŠÙ…ÙŠÙ†/ÙŠØ³Ø§Ø±) -->
  <div id="onboardOverlay" aria-hidden="true">
    <div class="onbBox">
      <div class="onbTop">
        <div class="t">ØªØ¹Ø±ÙŠÙ Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</div>
        <button class="onbSkip" onclick="finishOnboarding()">ØªØ®Ø·ÙŠ</button>
      </div>

      <div class="onbBody">
        <div class="onbViewport" id="onbViewport">
          <div class="onbTrack" id="onbTrack">
            <div class="onbSlide">
              <div class="onbIcon">
                <svg width="46" height="46" viewBox="0 0 24 24" fill="none">
                  <path d="M3 10.5L12 5l9 5.5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M5 10.5V19h14v-8.5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M8 19v-6M12 19v-6M16 19v-6" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </div>
              <div class="onbTitle">Ù…Ù†ØµØ© Ù…ØªØ§Ø¨Ø¹Ø© Ø³Ù„ÙˆÙƒÙŠØ© ÙˆØªØ¹Ù„ÙŠÙ…ÙŠØ©</div>
              <div class="onbText">
                Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù†Ø¸Ø§Ù… Ù…Ø¯Ø±Ø³ÙŠ Ø±Ø³Ù…ÙŠ Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ­ÙÙŠØ²ÙŠØ© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù„Ù„Ø·Ø§Ù„Ø¨/Ù€Ø© Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø¸Ù…ØŒ Ù…Ø¹ Ø±ØµØ¯ Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª.
              </div>
            </div>

            <div class="onbSlide">
              <div class="onbIcon">
                <svg width="46" height="46" viewBox="0 0 24 24" fill="none">
                  <path d="M7 3h7l3 3v15H7V3Z" stroke-width="2" stroke-linejoin="round"/>
                  <path d="M14 3v4h4" stroke-width="2" stroke-linejoin="round"/>
                  <path d="M9 12h6M9 16h6" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </div>
              <div class="onbTitle">ØªÙ‚Ø§Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© ÙˆØ´ÙØ§ÙÙŠØ© Ø¹Ø§Ù„ÙŠØ©</div>
              <div class="onbText">
                ÙŠØªÙŠØ­ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø®Ù„Ø§Ù„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ÙˆØ¥ØµØ¯Ø§Ø± ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ù†Ø¸Ù…Ø©ØŒ Ø¨Ù…Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¨ØµÙˆØ±Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©.
              </div>
            </div>

            <div class="onbSlide">
              <div class="onbIcon">
                <svg width="46" height="46" viewBox="0 0 24 24" fill="none">
                  <path d="M12 3l7 4v6c0 5-3 8-7 8s-7-3-7-8V7l7-4Z" stroke-width="2" stroke-linejoin="round"/>
                  <path d="M9.5 12l1.8 1.8L15 10" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
              <div class="onbTitle">Ø¶ÙˆØ§Ø¨Ø· Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ§Ø¶Ø­Ø©</div>
              <div class="onbText">
                Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø®ØµØµ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ ÙÙ‚Ø·. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨ØªØ§Ø±ÙŠØ®Ù‡Ø§ ÙˆØ³Ø¨Ø¨Ù‡Ø§ØŒ Ø¨Ù‡Ø¯Ù ØªØ¹Ø²ÙŠØ² Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· ÙˆØ§Ù„ØªØ­ÙÙŠØ² ÙˆÙÙ‚ Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©.
              </div>
            </div>
          </div>
        </div>

        <div class="onbDots" id="onbDots">
          <div class="onbDot active"></div>
          <div class="onbDot"></div>
          <div class="onbDot"></div>
        </div>
      </div>
    </div>
  </div>
  <!-- âœ… Ø§Ù†ØªÙ‡Øª Ø´Ø§Ø´Ø© Ø§Ù„ØªØ¹Ø±ÙŠÙ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (Ø¨Ø¯ÙˆÙ† ØªØ¯Ø§Ø®Ù„ ÙŠØ³Ø¨Ø¨ ØµÙØ­Ø© Ø¨ÙŠØ¶Ø§Ø¡) -->

  <!-- ===== ØµÙØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù…Ø© ===== -->
  <div id="teacherLoginPage" class="hidden">
    <div class="container">
      <div class="card">
        <h3 style="margin:0 0 10px 0;color:var(--navy)">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…Ø©</h3>
        <input id="tu" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input id="tp" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <div class="row">
          <button class="btn col" onclick="teacherLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
          <button class="btn3 col" onclick="forgotTeacher()">Ù†Ø³ÙŠØª Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ</button>
        </div>
        <div class="small">Ø§Ù„Ø¯Ø®ÙˆÙ„: teacher / 12345</div>
      </div>
    </div>
  </div>

  <div id="classesPage" class="hidden">
    <div class="container">

      <div class="card soft">
        <h3 style="margin:0 0 8px 0;color:var(--navy)">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹ (WhatsApp Business)</h3>
        <div class="row">
          <label class="col small" style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="autoWA" checked>
            ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙˆØ±ÙŠ Ø¨Ù†Ù‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø© (ÙŠÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø²Ù†Ø³ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©)
          </label>
          <label class="col small" style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="copyToTeacher" checked>
            Ø¥Ø±Ø³Ø§Ù„ Ù†Ø³Ø®Ø© Ù„Ù„Ù…Ø¹Ù„Ù…Ø© (ÙŠÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ù†Ø³Ø®Ø©)
          </label>
        </div>
        <div class="small" style="margin-top:6px">
          * ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ 100% Ø¨Ø¯ÙˆÙ† Ù†Ù‚Ø±Ø© (Send) ØºÙŠØ± Ù…Ù…ÙƒÙ† Ù…Ù† ÙˆØ§ØªØ³Ø§Ø¨ â€” Ù„Ø§Ø²Ù… â€œÙ†Ù‚Ø±Ø© Ø¥Ø±Ø³Ø§Ù„â€ Ø£Ø®ÙŠØ±Ø© âœ…
        </div>
      </div>

      <!-- âœ… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© -->
      <div class="card soft" id="dailyOpsCard">
        <h3 style="margin:0 0 8px 0;color:var(--navy)">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>

        <div class="row">
          <div class="col">
            <div class="small">Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
            <input id="dailyDate" type="date">
          </div>
          <div class="col" style="align-self:flex-end">
            <button class="btn2" onclick="loadDailyOps()">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
          </div>
          <div class="col" style="align-self:flex-end">
            <button class="btn whatsapp-btn" onclick="sendDailyOpsWhats()">ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</button>
          </div>
        </div>

        <div class="small" style="margin-top:8px">
          * Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ù† (â—‹) Ø«Ù… Ø§Ø¶ØºØ·ÙŠ Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨.
          <span id="dailyPickHint" class="dailySelectedHint"></span>
        </div>

        <div id="dailyOpsList" style="margin-top:10px"></div>
      </div>

      <div class="card soft">
        <div class="row">
          <div class="col">
            <div class="small">Ø¥Ø¶Ø§ÙØ© ÙØµÙ„</div>
            <input id="newClassName" placeholder="Ù…Ø«Ø§Ù„: Ø®Ø§Ù…Ø³ Ø¨Ù†Ø§Øª">
          </div>
          <div class="col" style="align-self:flex-end">
            <button class="btn2" onclick="addClass()">Ø¥Ø¶Ø§ÙØ© ÙØµÙ„</button>
          </div>
        </div>
        <hr>
        <div class="row">
          <button class="btn2 col" onclick="renameClass()">ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„ÙØµÙ„</button>
          <button class="btnRed col" onclick="deleteClassMove()">Ø­Ø°Ù ÙØµÙ„ + Ù†Ù‚Ù„ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
          <button class="btn3 col" onclick="syncStudentsToClasses()">ØªØ«Ø¨ÙŠØª Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
          <button class="btn3 col" onclick="toggleForgotPinForAll()">ØªØ¹Ø·ÙŠÙ„/ØªÙØ¹ÙŠÙ„ Ù†Ø³ÙŠØª Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ</button>
        </div>
        <div class="small">Ø²Ø± "ØªØ«Ø¨ÙŠØª Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨" ÙŠØ±Ø¬Ø¹ ÙƒÙ„ Ø·Ø§Ù„Ø¨ Ù„ÙØµÙ„Ù‡ Ø§Ù„ØµØ­ÙŠØ­ + ÙŠØ¶ÙŠÙ Ø§Ù„Ù†Ø§Ù‚Øµ.</div>
      </div>

      <div class="tabs" id="classTabs"></div>

      <div class="card">
        <button class="btn2" onclick="openClassPage()">Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙØµÙ„</button>
        <button class="btn3" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <div id="classPage" class="hidden">
    <div class="container">

      <div class="card soft">
        <div class="row">
          <div class="col">
            <div class="small">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</div>
            <input id="newStudentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨/Ø§Ù„Ø·Ø§Ù„Ø¨Ø©">
          </div>
          <div class="col" style="align-self:flex-end">
            <button class="btn2" onclick="addStudent()">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
          </div>
        </div>

        <hr>

        <div class="row">
          <div class="col">
            <div class="small">Ù…Ø¨Ù„Øº Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ù„Ù„ÙƒÙ„</div>
            <input id="bulkAmount" type="number" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 10">
          </div>
          <div class="col" style="align-self:flex-end">
            <button class="btn" onclick="depositAll()">Ø¥ÙŠØ¯Ø§Ø¹ Ù„Ù„ÙƒÙ„</button>
          </div>

          <div class="col">
            <div class="small">Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„ÙƒÙ„</div>
            <input id="bulkWithdrawAmount" type="number" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 5">
          </div>
          <div class="col" style="align-self:flex-end">
            <button class="btnRed" onclick="withdrawAll()">Ø³Ø­Ø¨ Ù„Ù„ÙƒÙ„</button>
          </div>
        </div>

        <hr>

        <div class="row">
          <div class="col">
            <div class="small">Ø·Ø§Ù„Ø¨ Ù…Ø­Ø¯Ø¯</div>
            <select id="pickStudent"></select>
          </div>
          <div class="col">
            <div class="small">Ø§Ù„Ù…Ø¨Ù„Øº</div>
            <input id="pickAmount" type="number" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 5">
          </div>
          <div class="col" style="align-self:flex-end">
            <button class="btn2" onclick="depositToStudent()">Ø¥ÙŠØ¯Ø§Ø¹ Ù„Ø·Ø§Ù„Ø¨</button>
          </div>
          <div class="col" style="align-self:flex-end">
            <button class="btnRed" onclick="withdrawFromStudent()">Ø³Ø­Ø¨ Ù…Ù† Ø·Ø§Ù„Ø¨</button>
          </div>
        </div>

        <hr>

        <div class="row">
          <div class="col">
            <div class="small">Ø³Ø¨Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</div>
            <select id="reasonTeacher"></select>
            <input id="reasonOtherTeacher" class="hidden" placeholder="Ø£Ø®Ø±Ù‰: Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¨Ø¨ Ù‡Ù†Ø§..." style="margin-top:8px">
          </div>
        </div>

        <hr>

        <div class="selRow">
          <span class="selTag"><input type="checkbox" id="selAll" onchange="toggleSelectAll()"> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</span>
          <button class="btn2" onclick="depositSelected()">Ø¥ÙŠØ¯Ø§Ø¹ Ù„Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†</button>
          <button class="btnRed" onclick="withdrawSelected()">Ø³Ø­Ø¨ Ù„Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†</button>
          <div class="small" id="selCount">Ø§Ù„Ù…Ø­Ø¯Ø¯: 0</div>
        </div>
      </div>

      <div id="studentsGrid" class="grid2"></div>

      <div class="card">
        <button class="btn3" onclick="backToClasses()">Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙØµÙˆÙ„</button>
      </div>
    </div>
  </div>

  <!-- ===== ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ===== -->
  <div id="studentLoginPage" class="hidden">
    <div class="container">
      <div class="card">
        <h3 style="margin:0 0 10px 0;color:var(--navy)" id="stuLoginTitle">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
        <div id="stuLocked" class="small hidden" style="color:var(--red);font-weight:700"></div>
        <input id="stuName" readonly>
        <input id="stuPin" type="password" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ (PIN)">
        <div class="small" style="margin:8px 0;">
          <a href="javascript:void(0)" id="forgotPinLink" style="color:#0055A4;font-weight:700">Ù†Ø³ÙŠØª Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠØŸ</a>
        </div>
        <button class="btn" onclick="studentLogin()">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn3" onclick="backToClass()">Ø±Ø¬ÙˆØ¹</button>
      </div>
    </div>
  </div>

  <div id="studentAccountPage" class="hidden">
    <div class="container">
      <div class="card soft">
        <h3 style="margin:0 0 10px 0;color:var(--navy)" id="studentHeader"></h3>
        <div class="row">
          <div class="col"><div class="small">Ø§Ù„Ø­Ø§Ù„Ø©</div><div id="statusBadge" class="badge"></div></div>
          <div class="col"><div class="small">Ø§Ù„Ø±ØµÙŠØ¯</div><div style="font-size:26px;font-weight:800;color:var(--navy)"><span id="studentBalance">0</span> Ø±.Ø³</div></div>
          <div class="col"><div class="small">ØªØ§Ø±ÙŠØ® ÙØªØ­ Ø§Ù„Ø­Ø³Ø§Ø¨</div><div id="openedAt" class="small">â€”</div></div>
        </div>

        <div class="card" style="margin:12px 0 0 0">
          <h3 style="margin:0 0 10px 0;color:var(--navy);font-size:15px">ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ©</h3>

          <div class="row">
            <div class="col">
              <div class="small">Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</div>
              <select id="op">
                <option value="deposit">Ø¥ÙŠØ¯Ø§Ø¹</option>
                <option value="withdraw">Ø³Ø­Ø¨</option>
                <option value="transfer">ØªØ­ÙˆÙŠÙ„</option>
              </select>
            </div>

            <div class="col">
              <div class="small">Ø§Ù„Ø³Ø¨Ø¨</div>
              <select id="reasonStudent"></select>
              <input id="reasonOtherStudent" class="hidden" placeholder="Ø£Ø®Ø±Ù‰: Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¨Ø¨ Ù‡Ù†Ø§..." style="margin-top:8px">
            </div>

            <div class="col"><div class="small">Ø§Ù„Ù…Ø¨Ù„Øº</div><input id="amt" type="number" step="0.01"></div>
            <div class="col"><div class="small">ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰</div><select id="transferTo"></select></div>
          </div>

          <div class="row">
            <button class="btn col" onclick="executeOp()">ØªÙ†ÙÙŠØ°</button>
            <button class="btn3 col" onclick="backToClass()">Ø±Ø¬ÙˆØ¹</button>
          </div>
        </div>

        <hr>

        <div class="row">
          <div class="col"><div class="small">Ù…Ù† ØªØ§Ø±ÙŠØ®</div><input id="fromDate" type="date"></div>
          <div class="col"><div class="small">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</div><input id="toDate" type="date"></div>
          <div class="col" style="align-self:flex-end"><button class="btn2" onclick="showStatement()">Ø¹Ø±Ø¶ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨</button></div>
        </div>

        <div class="tableWrap" style="margin-top:10px">
          <table>
            <thead><tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th><th>Ø§Ù„Ø³Ø¨Ø¨</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th></tr></thead>
            <tbody id="stmtRows"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù„ØºØ© Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡ âœ¨</div>

  <!-- libs -->
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    // ================== ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø®ÙˆÙ„: teacher / student ==================
    const urlParams = new URLSearchParams(window.location.search);
    const APP_MODE = (urlParams.get("mode") || "teacher").toLowerCase(); // teacher | student
    const IS_STUDENT_ENTRY = (APP_MODE === "student");

    // ================== Ø£Ø±Ù‚Ø§Ù… ÙˆØ§ØªØ³Ø§Ø¨ ==================
    const SIGNATURE = "Ø§Ù„Ù…Ø¹Ù„Ù…Ø©: Ø³Ø§Ø±Ø© Ø­Ù‚ÙˆÙŠ";
    const TEACHER_BANK_TITLE = "Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª â€“ Ø§Ù„Ù…ØµØ±ÙÙŠ";
    const CONTACT_PRIMARY = "0502234335";
    const WHATSAPP_BUSINESS = "0556891201";

    // ================== Firebase ==================
    const firebaseConfig = {
      apiKey: "AIzaSyDP-pi0tbFQ9bNRihrLz_kUs-JBoa9Cw4Y",
      authDomain: "sara-haywire.firebaseapp.com",
      projectId: "sara-haywire",
      storageBucket: "sara-haywire.firebasestorage.app",
      messagingSenderId: "333467940977",
      appId: "1:333467940977:web:97d056d5dbff2debbf43d0",
      measurementId: "G-7RPQX9ER93"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const TEACHER_EMAIL="as-soso-as2011@hotmail.com";
    function $(id){return document.getElementById(id);}

    // ================== Ø£Ø¯ÙˆØ§Øª ==================
    function openModal(title, bodyHtml, actionsHtml){
      $("mTitle").textContent=title;
      $("mBody").innerHTML=bodyHtml;
      $("mActions").innerHTML=actionsHtml||'<button class="btn" onclick="closeModal()">Ù…ÙˆØ§ÙÙ‚</button>';
      $("modal").style.display="flex";
    }
    function closeModal(){ $("modal").style.display="none"; }
    function warn(msg){ openModal("ØªÙ†Ø¨ÙŠÙ‡", msg); }
    function logout(){location.reload();}

    function go(page){
      ["teacherLoginPage","classesPage","classPage","studentLoginPage","studentAccountPage"].forEach(id=>$(id)?.classList.add("hidden"));
      $(page)?.classList.remove("hidden");
    }
    function fmt(x){ return (Math.round((Number(x||0)+Number.EPSILON)*100)/100).toFixed(2); }

    // ================== ØµÙˆØª Ø§Ù„ØªØ±Ø­ÙŠØ¨ ==================
    async function beep(){
      try{
        const ctx=new (window.AudioContext||window.webkitAudioContext)();
        const o=ctx.createOscillator(), g=ctx.createGain();
        o.type="triangle"; o.frequency.value=740; g.gain.value=0.12;
        o.connect(g); g.connect(ctx.destination); o.start();
        setTimeout(()=>{o.stop(); ctx.close();}, 220);
      }catch(e){}
    }
    async function playWelcome(){
      const m4a = document.getElementById("welcomeM4a");
      const mp3 = document.getElementById("welcomeMp3");
      await beep();
      try{ if(m4a){ m4a.currentTime=0; await m4a.play(); return; } }catch(e){}
      try{ if(mp3){ mp3.currentTime=0; await mp3.play(); return; } }catch(e){}
    }

    // ================== WhatsApp helpers ==================
    function normalizePhoneToWA(phone){
      let p = String(phone||"").replace(/[^0-9]/g,"");
      if(!p) return "";
      if(p.startsWith("00")) p = p.slice(2);
      if(p.startsWith("0")) p = "966" + p.slice(1);
      return p;
    }
    function contactLink(){ return "https://wa.me/" + normalizePhoneToWA(CONTACT_PRIMARY); }

    function buildOfficialMessage(type, student, amount, reason){
      const warnLine = "âš ï¸ Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©";
      return (
`${warnLine}
${TEACHER_BANK_TITLE}

ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨/Ù€Ø©:
${student}

Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${type}
Ø§Ù„Ù…Ø¨Ù„Øº: ${String(amount ?? "")} Ø±ÙŠØ§Ù„
Ø§Ù„Ø³Ø¨Ø¨: ${reason || "â€”"}

* Ù‡Ù†Ø§ Ù„Ø§ Ù†Ø³ØªØ·ÙŠØ¹ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„.
Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù…Ø© Ø§Ø¶ØºØ· Ø§Ù„Ø±Ø§Ø¨Ø·:
${contactLink()}

${SIGNATURE}`
      );
    }

    function openWABusinessFast(toPhone, messageText){
      const phone = normalizePhoneToWA(toPhone);
      if(!phone) return;

      const msg = (messageText || "");
      const enc = encodeURIComponent(msg);
      const businessScheme = "whatsapp-business://send?phone=" + phone + "&text=" + enc;

      window.location.href = businessScheme;

      setTimeout(()=>{
        const actions = `
          <button class="btn" onclick="tryOpenBusinessAgain('${phone}','${enc.replace(/'/g,"%27")}')">ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø²Ù†Ø³</button>
          <button class="btn3" onclick="copyTextToClipboard(decodeURIComponent('${enc.replace(/'/g,"%27")}'))">Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
          <button class="btn2" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        `;
        openModal(
          "ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø²Ù†Ø³",
          "Ø¥Ø°Ø§ Ù…Ø§ ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø²Ù†Ø³ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§:\\n1) Ø§Ø¶ØºØ·ÙŠ (ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø²Ù†Ø³)\\n2) Ø£Ùˆ (Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø©) Ø«Ù… Ø§ÙØªØ­ÙŠ ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø²Ù†Ø³ ÙˆØ§Ù„ØµÙ‚ÙŠÙ‡Ø§.",
          actions
        );
      }, 900);
    }
    function tryOpenBusinessAgain(phone, encMsg){
      window.location.href = "whatsapp-business://send?phone=" + phone + "&text=" + encMsg;
    }
    async function copyTextToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        openModal("ØªÙ… âœ…","ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø­Ø§ÙØ¸Ø©.");
      }catch(e){
        try{
          const ta=document.createElement("textarea");
          ta.value=text; document.body.appendChild(ta);
          ta.select(); document.execCommand("copy");
          document.body.removeChild(ta);
          openModal("ØªÙ… âœ…","ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø­Ø§ÙØ¸Ø©.");
        }catch(_){
          openModal("ØªÙ†Ø¨ÙŠÙ‡","ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®â€¦ Ø§Ù†Ø³Ø®ÙŠ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©.");
        }
      }
    }

    function isAutoWAEnabled(){ return !!document.getElementById("autoWA")?.checked; }
    function isCopyEnabled(){ return !!document.getElementById("copyToTeacher")?.checked; }

    // ================== Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ==================
    const REASONS = {
      deposit: [
        "Ø§Ù„ØªÙØ§Ø¹Ù„ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©",
        "Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„ØµÙÙŠØ©",
        "Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ§Ù„Ø­ØµØ©",
        "ØªÙ…ÙŠØ² ÙÙŠ Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ",
        "ØªØ­Ø³Ù† Ù…Ù„Ø­ÙˆØ¸ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø£Ùˆ Ø§Ù„Ø³Ù„ÙˆÙƒ",
        "Ø£Ø®Ø±Ù‰"
      ],
      withdraw: [
        "Ø¹Ø¯Ù… Ø­Ù„ Ø§Ù„ÙˆØ§Ø¬Ø¨ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ",
        "ÙƒØ«Ø±Ø© Ø§Ù„ÙƒÙ„Ø§Ù… ÙˆØ§Ù„Ø­Ø±ÙƒØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­ØµØ©",
        "Ø§Ù„Ù†ÙˆÙ… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ØµØ©",
        "Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ù„Ø§Ø¦Ù‚ Ù…Ø¹ Ø§Ù„Ø²Ù…Ù„Ø§Ø¡",
        "Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ù„Ø§Ø¦Ù‚ Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù…Ø©",
        "Ø§Ù„ØªØ£Ø®Ø± Ø¹Ù† Ø­ØµØ© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø¯ÙˆÙ† Ø¹Ø°Ø±",
        "Ù†Ø³ÙŠØ§Ù† ÙƒØªØ§Ø¨ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª",
        "Ù†Ø³ÙŠØ§Ù† Ø§Ù„Ø¯ÙØªØ±",
        "Ù†Ø³ÙŠØ§Ù† Ø§Ù„Ù…Ø°ÙƒØ±Ø©",
        "Ø¹Ø¯Ù… Ø¥Ø­Ø¶Ø§Ø± Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª",
        "Ø£Ø®Ø±Ù‰"
      ],
      transfer: [
        "ØªØ³Ø¯ÙŠØ¯/Ø¥Ø±Ø¬Ø§Ø¹ Ø±ØµÙŠØ¯",
        "Ù…Ø³Ø§Ø¹Ø¯Ø© Ø²Ù…ÙŠÙ„/Ù€Ø©",
        "Ø£Ø®Ø±Ù‰"
      ]
    };

    function fillReasonSelect(selectEl, items){
      if(!selectEl) return;
      selectEl.innerHTML = "";
      items.forEach(r=>{
        const o = document.createElement("option");
        o.value = r;
        o.textContent = r;
        selectEl.appendChild(o);
      });
    }

    let currentAccess = "teacher"; // teacher | student

    function setupReasonUI(mode, selectId, otherId){
      const sel = document.getElementById(selectId);
      const other = document.getElementById(otherId);
      if(!sel || !other) return;

      if(mode === "transfer" && currentAccess === "student"){
        sel.classList.add("hidden");
        sel.innerHTML = "";
        other.classList.remove("hidden");
        other.placeholder = "Ø³Ø¨Ø¨ Ø§Ù„ØªØ­ÙˆÙŠÙ„ (Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„ØªÙ†ÙÙŠØ° Ù‡Ù†Ø§...)";
        return;
      }

      sel.classList.remove("hidden");
      fillReasonSelect(sel, REASONS[mode] || ["Ø£Ø®Ø±Ù‰"]);

      const toggleOther = ()=>{
        if(sel.value === "Ø£Ø®Ø±Ù‰"){
          other.classList.remove("hidden");
          other.placeholder = "Ø£Ø®Ø±Ù‰: Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¨Ø¨ Ù‡Ù†Ø§...";
        }else{
          other.classList.add("hidden");
          other.value = "";
        }
      };
      sel.onchange = toggleOther;
      toggleOther();
    }

    function getReason(selectId, otherId){
      const sel = document.getElementById(selectId);
      const other = document.getElementById(otherId);

      if(sel && sel.classList.contains("hidden")){
        const t = (other?.value || "").trim();
        return t || "ØªØ­ÙˆÙŠÙ„";
      }

      if(!sel) return "";
      if(sel.value === "Ø£Ø®Ø±Ù‰"){
        const t = (other?.value || "").trim();
        return t || "Ø£Ø®Ø±Ù‰";
      }
      return sel.value || "";
    }

    function initTeacherReasonAlways(){
      const sel = $("reasonTeacher");
      if(!sel) return;
      const union = Array.from(new Set([
        ...REASONS.deposit, ...REASONS.withdraw, ...REASONS.transfer
      ]));
      fillReasonSelect(sel, union);
      const other = $("reasonOtherTeacher");
      const toggleOther = ()=>{
        if(sel.value === "Ø£Ø®Ø±Ù‰"){ other.classList.remove("hidden"); }
        else { other.classList.add("hidden"); other.value=""; }
      };
      sel.onchange = toggleOther;
      toggleOther();
    }

    // ================== Onboarding Logic (ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø²Ø± Ø§Ø¨Ø¯Ø£) ==================
    let onbIndex = 0;
    let onbAfterDone = null;
    let onbSwipeBound = false;

    function showOnboardingIfNeeded(afterDone){
      onbAfterDone = (typeof afterDone === "function") ? afterDone : null;

      onbIndex = 0;
      updateOnbUI();

      const ov = document.getElementById("onboardOverlay");
      if(ov){
        ov.style.display = "flex";
        ov.setAttribute("aria-hidden","false");
      }
      enableOnbSwipe();
    }

    function finishOnboarding(){
      const ov = document.getElementById("onboardOverlay");
      if(ov){
        ov.style.display = "none";
        ov.setAttribute("aria-hidden","true");
      }
      const cb = onbAfterDone;
      onbAfterDone = null;
      if(typeof cb === "function") cb();
    }

    function updateOnbUI(){
      const track = document.getElementById("onbTrack");
      const dotsWrap = document.getElementById("onbDots");

      if(track) track.style.transform = `translateX(-${onbIndex * 100}%)`;

      if(dotsWrap){
        const dots = dotsWrap.querySelectorAll(".onbDot");
        dots.forEach((d,i)=> d.classList.toggle("active", i===onbIndex));
      }
    }
    function onbNext(){
      if(onbIndex >= 2) return finishOnboarding();
      onbIndex++;
      updateOnbUI();
    }
    function onbPrev(){
      if(onbIndex <= 0) return;
      onbIndex--;
      updateOnbUI();
    }

    function enableOnbSwipe(){
      if(onbSwipeBound) return;
      const vp = document.getElementById("onbViewport");
      if(!vp) return;
      onbSwipeBound = true;

      let startX = 0, dx = 0, dragging=false;

      const down = (x)=>{ dragging=true; startX=x; dx=0; };
      const move = (x)=>{ if(!dragging) return; dx = x-startX; };
      const up = ()=>{
        if(!dragging) return;
        dragging=false;
        if(Math.abs(dx) > 45){
          // RTL UX: Ø³Ø­Ø¨ ÙŠÙ…ÙŠÙ† = Ø§Ù„Ø³Ø§Ø¨Ù‚ØŒ Ø³Ø­Ø¨ ÙŠØ³Ø§Ø± = Ø§Ù„ØªØ§Ù„ÙŠ
          if(dx > 0) onbPrev();
          else onbNext();
        }
        dx=0;
      };

      vp.addEventListener("touchstart", (e)=> down(e.touches[0].clientX), {passive:true});
      vp.addEventListener("touchmove",  (e)=>{ e.preventDefault(); move(e.touches[0].clientX); }, {passive:false});
      vp.addEventListener("touchend",   ()=> up(), {passive:true});

      vp.addEventListener("pointerdown", (e)=> down(e.clientX));
      vp.addEventListener("pointermove", (e)=> move(e.clientX));
      vp.addEventListener("pointerup",   ()=> up());
      vp.addEventListener("pointercancel",()=> up());
    }

    // ================== Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡ (âœ… Ù‡Ù†Ø§ Ù…ÙƒØ§Ù† showOnboarding Ø§Ù„ØµØ­ÙŠØ­) ==================
    async function startApp(){
      // Ù†Ø®ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ø¨Ø¯Ø£
      const st = document.getElementById("startOverlay");
      if(st) st.style.display = "none";

      // Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ø±ÙŠÙ Ø«Ù… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
      showOnboardingIfNeeded(()=>{
        if(IS_STUDENT_ENTRY){
          go("studentLoginPage");
          $("stuLoginTitle").textContent = "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨";
          $("stuName").readOnly = false;
          $("stuName").value = "";
          $("stuName").placeholder = "Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ ÙƒÙ…Ø§ Ù‡Ùˆ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…";
          currentAccess = "student";
          return;
        }
        go("teacherLoginPage");
        currentAccess = "teacher";
      });
    }

    // ================== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…Ø© ==================
    function teacherLogin(){
      if($("tu").value.trim()==="teacher" && $("tp").value.trim()==="12345"){
        currentAccess = "teacher";
        go("classesPage");
        renderTabs();
      } else warn("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
    }
    function forgotTeacher(){
      const subject=encodeURIComponent("Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø®ÙˆÙ„ Ù…ØµØ±Ù Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª");
      const body=encodeURIComponent("Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…ØŒ\nØ£Ø±ØºØ¨ Ø¨Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù…ØµØ±Ù Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª.\nØ´ÙƒØ±Ø§Ù‹.");
      window.location.href=`mailto:${TEACHER_EMAIL}?subject=${subject}&body=${body}`;
    }

    // ================== Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ â€œÙ†Ø³ÙŠØª Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠâ€ ==================
    let forgotPinEnabled = true;

    async function loadForgotSetting(){
      try{
        const doc = await db.collection("settings").doc("security").get();
        if(doc.exists){
          const d = doc.data() || {};
          if(typeof d.forgotPinEnabled === "boolean") forgotPinEnabled = d.forgotPinEnabled;
        }else{
          await db.collection("settings").doc("security").set({forgotPinEnabled:true});
          forgotPinEnabled = true;
        }
      }catch(e){
        forgotPinEnabled = true;
      }
      const link = $("forgotPinLink");
      if(link) link.style.display = forgotPinEnabled ? "inline" : "none";
    }

    async function toggleForgotPinForAll(){
      try{
        forgotPinEnabled = !forgotPinEnabled;
        await db.collection("settings").doc("security").set({forgotPinEnabled}, {merge:true});
        openModal("ØªÙ… âœ…", forgotPinEnabled ? "ØªÙ… ØªÙØ¹ÙŠÙ„ (Ù†Ø³ÙŠØª Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ) Ù„Ù„Ø¬Ù…ÙŠØ¹." : "ØªÙ… ØªØ¹Ø·ÙŠÙ„ (Ù†Ø³ÙŠØª Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ) Ù„Ù„Ø¬Ù…ÙŠØ¹.");
      }catch(e){
        openModal("ØªÙ†Ø¨ÙŠÙ‡", "ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¢Ù†.");
      }
      await loadForgotSetting();
    }
    function isForgotEnabled(){ return forgotPinEnabled === true; }

    // ================== Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø§Ù…Ø© ==================
    let classes=[], currentClassId=null, currentStudentId=null;
    let selectedIds = new Set();

    // ================== Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ==================
    const DEFAULT_STUDENTS = {
      "Ø³Ø§Ø¯Ø³ Ø¨Ù†ÙŠÙ†": ["Ø·Ù„Ø§Ù„ Ø§Ù„Ø±Ø­ÙŠÙ„ÙŠ","Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ±Ù…ÙŠ","Ø¹Ù…Ø± ØµÙˆØ§Ù","Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹Ù†Ø²ÙŠ","Ø³Ø§Ù„Ù… Ø¢Ù„ Ù…Ø®Ù„Øµ","Ø¹Ø¨Ø¯Ø§Ù„Ù…Ù„Ùƒ Ø§Ù„Ø¬Ù†Ø§Ø¹ÙŠ","ÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø§Ù„ÙƒÙŠ","Ø³Ù„Ù…Ø§Ù† Ø§Ù„Ø¬ÙˆÙ‡Ø±","Ø±Ø§ÙƒØ§Ù† Ù…Ø¨Ø§Ø±ÙƒÙŠ","ÙÙŠØµÙ„ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ","Ø±ÙŠØ§Ù† Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ","Ù…Ø­Ù…Ø¯ Ø£Ø¨Ùˆ ØµØ§Ù„Ø­","Ù†Ø§ÙŠÙ Ø§Ù„Ø¹ØµÙŠÙ…ÙŠ"],
      "Ø³Ø§Ø¯Ø³ Ø¨Ù†Ø§Øª": ["Ø±Ù‡Ù Ø§Ù„Ø«Ø¨ÙŠØªÙŠ","Ø¬Ø§Ø¯Ù„ Ø§Ù„Ø¯ÙˆØ³Ø±ÙŠ","Ø¯Ø§Ù†Ø© Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ","ØªØ§Ù„ÙŠÙ† Ù…ØªÙˆÙ„ÙŠ","Ø¯ÙŠÙ…Ø§ Ø§Ù„Ø­Ù…Ø§Ø¯ÙŠ","Ø±Ù‡Ù Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ","ÙƒØ§Ø¯ÙŠ Ø§Ù„Ø¹ØªÙŠØ¨ÙŠ","Ø±ÙˆØ¯ÙŠÙ†Ø§ ØºØ±ÙŠØ¨","Ø§Ù„Ø¬ÙˆÙ‡Ø±Ø© Ø¢Ù„ Ù…Ø®Ù„Øµ","Ø±ÙŠÙ… Ø¢Ù„ Ù…Ø´Ø±Ù"],
      "Ø£ÙˆÙ„ Ù…ØªÙˆØ³Ø·": ["Ø§ÙŠÙ…Ø§Ù† Ø¨Ø§ØºØ±ÙŠØ¨","Ø¯ÙŠÙ…Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠ","Ù†Ø¬Ù„Ø§ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ","Ø¯ÙŠÙ… Ø§Ù„ØºØ§Ù…Ø¯ÙŠ","Ù…ÙŠØ³ Ø§Ù„Ø³Ù†Ø§Ù…Ø©","Ù„Ø§Ø±ÙŠÙ† Ø§Ù„ØªÙ„","Ù„ÙŠØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø±ÙÙŠ","Ø³Ø§Ø±Ø© Ø§Ù„ØºØ§Ù…Ø¯ÙŠ"]
    };

    const PARENTS_PHONE = {
      "Ø³Ø§Ù„Ù… Ø¢Ù„ Ù…Ø®Ù„Øµ": "0502402111",
      "Ø§Ù„Ø¬ÙˆÙ‡Ø±Ø© Ø¢Ù„ Ù…Ø®Ù„Øµ": "0502402111",
      "ØªØ§Ù„ÙŠÙ† Ù…ØªÙˆÙ„ÙŠ": "0505220540",
      "Ø¬Ø§Ø¯Ù„ Ø§Ù„Ø¯ÙˆØ³Ø±ÙŠ": "0538118080",
      "Ø¯Ø§Ù†Ø© Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ": "0555952003",
      "Ø±Ù‡Ù Ø§Ù„Ø¹ØªÙŠØ¨ÙŠ": "0543339829",
      "ÙƒØ§Ø¯ÙŠ Ø§Ù„Ø¹ØªÙŠØ¨ÙŠ": "0532340737",
      "Ø±Ù‡Ù Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ": "0562580555",
      "Ø±ÙŠÙ… Ø¢Ù„ Ù…Ø´Ø±Ù": "054565589",
      "Ø¯ÙŠÙ… Ø§Ù„Ø­Ù…Ø§Ø¯ÙŠ": "0501222335",
      "Ø±ÙˆØ¯ÙŠÙ†Ø§ Ø§Ù„ØºØ±ÙŠØ¨": "0506925919",
      "Ø±Ø§ÙƒØ§Ù† Ù…Ø¨Ø§Ø±ÙƒÙŠ": "0559591061",
      "Ø³Ù„Ù…Ø§Ù† Ø§Ù„Ø¬ÙˆÙ‡Ø±": "053827904",
      "Ø·Ù„Ø§Ù„ Ø§Ù„Ø±Ø­ÙŠÙ„ÙŠ": "0598801283",
      "Ù…Ø­Ù…Ø¯ Ø¨ÙˆØµØ§Ù„Ø­": "0500125335",
      "Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹Ù†Ø²ÙŠ": "0533264929",
      "Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ±Ù…ÙŠ": "0563882235",
      "ÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø§Ù„ÙƒÙŠ": "0552582145",
      "Ù†Ø§ÙŠÙ Ø§Ù„Ø¹ØµÙŠÙ…ÙŠ": "0509799783",
      "Ø¹Ø¨Ø¯Ø§Ù„Ù…Ù„Ùƒ Ø§Ù„Ø¬Ù†Ø§Ø¹ÙŠ": "0568027600",
      "ÙÙŠØµÙ„ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ": "0507993660",
      "Ø±ÙŠØ§Ù† Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ": "0555078508",
      "Ø¹Ù…Ø± ØµÙˆØ§Ù": "0599831191",
      "Ø¯ÙŠÙ…Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠ": "0567509173",
      "Ù„Ø§Ø±ÙŠÙ† Ø§Ù„ØªÙ„": "0580662141",
      "Ù†Ø¬Ù„Ø§ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ": "0535952876",
      "Ø§ÙŠÙ…Ø§Ù† Ø¨Ø§ØºØ±ÙŠØ¨": "0542678280",
      "Ø¯ÙŠÙ… Ø§Ù„ØºØ§Ù…Ø¯ÙŠ": "0535912049",
      "Ù„ÙŠØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø±ÙÙŠ": "0568135644",
      "Ù…ÙŠØ³ Ø§Ù„Ø³Ù†Ø§Ù…Ø©": "0580443424",
      "Ø³Ø§Ø±Ø© Ø§Ù„ØºØ§Ù…Ø¯ÙŠ": "0542743881"
    };

    async function ensureSeed(){
      const c = await db.collection("classes").orderBy("order").get();
      if(c.empty){
        await db.collection("classes").add({name:"Ø§Ù„ØµÙ Ø³Ø§Ø¯Ø³ Ø¨Ù†ÙŠÙ†",order:1});
        await db.collection("classes").add({name:"Ø§Ù„ØµÙ Ø³Ø§Ø¯Ø³ Ø¨Ù†Ø§Øª",order:2});
        await db.collection("classes").add({name:"Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø·",order:3});
      }

      const c2 = await db.collection("classes").orderBy("order").get();
      const by = {};
      c2.forEach(d=>by[d.data().name]=d.id);

      const all = await db.collection("students").get();
      const existing = new Set();
      all.forEach(d=>{ const s=d.data(); if(s?.name) existing.add(String(s.name).trim()); });

      for(const clsName of Object.keys(DEFAULT_STUDENTS)){
        const classId = by[clsName] || by[("Ø§Ù„ØµÙ " + clsName)] || by[("Ø§Ù„ØµÙ " + clsName.replace("Ø£ÙˆÙ„","Ø§Ù„Ø£ÙˆÙ„"))];
        if(!classId) continue;

        for(const n0 of DEFAULT_STUDENTS[clsName]){
          const n = String(n0).trim();
          if(existing.has(n)) continue;
          const pin=String(Math.floor(1000+Math.random()*9000));
          await db.collection("students").add({
            name:n,classId,active:true,balance:0,pin,openedAt:null,
            guardianWhats:(PARENTS_PHONE[n]||"")
          });
          existing.add(n);
        }
      }
    }

    // ================== ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØµÙˆÙ„ ==================
    async function loadClasses(){
      const snap = await db.collection("classes").orderBy("order").get();
      classes=[]; snap.forEach(d=>classes.push({id:d.id,...d.data()}));
      if(!currentClassId) currentClassId = classes[0]?.id;
    }
    async function renderTabs(){
      await loadClasses();
      const tabs=$("classTabs"); if(!tabs) return;
      tabs.innerHTML="";
      classes.forEach(c=>{
        const t=document.createElement("div");
        t.className="tab"+(c.id===currentClassId?" active":"");
        t.textContent=c.name;
        t.onclick=()=>{ currentClassId=c.id; renderTabs(); };
        tabs.appendChild(t);
      });
    }

    // ================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØµÙˆÙ„ ==================
    async function addClass(){
      const n=$("newClassName").value.trim();
      if(!n) return warn("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙØµÙ„");
      const last=await db.collection("classes").orderBy("order","desc").limit(1).get();
      const max= last.empty?0:(last.docs[0].data().order||0);
      await db.collection("classes").add({name:n,order:max+1});
      $("newClassName").value="";
      await renderTabs();
    }
    async function renameClass(){
      const c=classes.find(x=>x.id===currentClassId); if(!c) return;
      const nn=prompt("Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„ÙØµÙ„:", c.name); if(!nn) return;
      await db.collection("classes").doc(currentClassId).update({name: nn.trim()});
      await renderTabs();
    }
    async function deleteClassMove(){
      if(classes.length<=1) return warn("Ù…Ø§ Ù†Ù‚Ø¯Ø± Ù†Ø­Ø°Ù Ø¢Ø®Ø± ÙØµÙ„");
      const others=classes.filter(c=>c.id!==currentClassId);
      const destName=prompt("Ù†Ù†Ù‚Ù„ Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„ Ù„Ø£ÙŠ ÙØµÙ„?\n"+others.map(c=>c.name).join(" / "), others[0].name);
      if(!destName) return;
      const dest=classes.find(c=>c.name===destName); if(!dest) return warn("Ø§Ø³Ù… Ø§Ù„ÙØµÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
      const studs=await db.collection("students").where("classId","==",currentClassId).get();
      const batch=db.batch();
      studs.forEach(d=>batch.update(db.collection("students").doc(d.id), {classId: dest.id}));
      batch.delete(db.collection("classes").doc(currentClassId));
      await batch.commit();
      currentClassId=null;
      await renderTabs();
    }
    async function syncStudentsToClasses(){
      await ensureSeed();
      openModal("ØªÙ… âœ…","ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø§Ù‚Øµ).");
      await renderTabs();
    }

    // ================== ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± + PIN ==================
    async function ensureGuardianPhone(studentId, studentName){
      const ref = db.collection("students").doc(studentId);
      const doc = await ref.get();
      if(!doc.exists) return "";
      const s = doc.data() || {};
      if(s.guardianWhats && String(s.guardianWhats).trim()) return String(s.guardianWhats).trim();
      const guess = PARENTS_PHONE[studentName] || "";
      if(guess){
        await ref.update({guardianWhats: guess});
        return guess;
      }
      return "";
    }

    async function editGuardianPhone(studentId, studentName){
      const ref = db.collection("students").doc(studentId);
      const doc = await ref.get();
      if(!doc.exists) return;
      const s = doc.data() || {};
      const current = (s.guardianWhats || PARENTS_PHONE[studentName] || "").toString();
      const nn = prompt("Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ù…Ø«Ø§Ù„: 05xxxxxxxx):", current);
      if(nn===null) return;
      await ref.update({guardianWhats: nn.trim()});
      openModal("ØªÙ… âœ…", "ØªÙ… Ø­ÙØ¸ Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±.");
      await renderStudents();
    }

    async function sendPinToParent(studentId){
      const ref = db.collection("students").doc(studentId);
      const doc = await ref.get();
      if(!doc.exists) return;
      const s = doc.data() || {};
      const parent = await ensureGuardianPhone(studentId, s.name||"");
      const wa = normalizePhoneToWA(parent);
      if(!wa){
        openModal("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø£Ù…Ø± Ù…Ø³Ø¬Ù„. Ø§Ø¶ØºØ·/ÙŠ (Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±) Ù„Ø¥Ø¶Ø§ÙØªÙ‡.");
        return;
      }
      const msg =
        "âš ï¸ Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©\n" +
        TEACHER_BANK_TITLE + "\n\n" +
        "Ø±Ù‚Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ (PIN) Ù„Ù„Ø·Ø§Ù„Ø¨/Ù€Ø©:\n" + (s.name||"") + "\n" +
        "PIN: " + (s.pin||"") + "\n\n" +
        "Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù…Ø©:\n" + contactLink() + "\n\n" +
        SIGNATURE;

      openWABusinessFast(wa, msg);
    }

    // ================== Ù†Ø³ÙŠØ§Ù† PIN ==================
    async function forgotStudentPin(){
      if(!isForgotEnabled()){
        openModal("ØªÙ†Ø¨ÙŠÙ‡","Ø®Ø¯Ù…Ø© Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ù…ÙˆÙ‚ÙˆÙØ© Ù…Ø¤Ù‚ØªÙ‹Ø§. Ø±Ø§Ø¬Ø¹/ÙŠ Ø§Ù„Ù…Ø¹Ù„Ù…Ø© ğŸŒ¿");
        return;
      }

      if(IS_STUDENT_ENTRY){
        const name = ($("stuName")?.value || "").trim();
        if(!name) return warn("Ø§ÙƒØªØ¨/ÙŠ Ø§Ù„Ø§Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹");
        const snap = await db.collection("students").where("name","==",name).limit(1).get();
        if(snap.empty) return warn("Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
        const doc = snap.docs[0];
        const s = doc.data() || {};
        const parent = await ensureGuardianPhone(doc.id, s.name||"");
        const wa = normalizePhoneToWA(parent);
        if(!wa) return openModal("ØªÙ†Ø¨ÙŠÙ‡","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø£Ù…Ø± Ù…Ø³Ø¬Ù„. ØªÙˆØ§ØµÙ„/ÙŠ Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù…Ø©.");
        const msg =
          "âš ï¸ Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©\n" + TEACHER_BANK_TITLE + "\n\n" +
          "Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ (PIN) Ù„Ù„Ø·Ø§Ù„Ø¨/Ù€Ø©:\n" + (s.name||"") + "\n" +
          "PIN: " + (s.pin||"") + "\n\n" +
          "Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù…Ø©:\n" + contactLink() + "\n\n" + SIGNATURE;
        openWABusinessFast(wa, msg);
        return;
      }

      if(!currentStudentId) return openModal("ØªÙ†Ø¨ÙŠÙ‡","Ø§Ø®ØªØ§Ø±ÙŠ/Ø§Ø®ØªØ§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹.");
      const doc = await db.collection("students").doc(currentStudentId).get();
      if(!doc.exists) return;
      const s = doc.data() || {};
      const parent = await ensureGuardianPhone(currentStudentId, s.name||"");
      const wa = normalizePhoneToWA(parent);
      if(!wa) return openModal("ØªÙ†Ø¨ÙŠÙ‡","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø£Ù…Ø± Ù…Ø³Ø¬Ù„.");
      const msg =
        "âš ï¸ Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©\n" + TEACHER_BANK_TITLE + "\n\n" +
        "Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ (PIN) Ù„Ù„Ø·Ø§Ù„Ø¨/Ù€Ø©:\n" + (s.name||"") + "\n" +
        "PIN: " + (s.pin||"") + "\n\n" +
        "Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù…Ø©:\n" + contactLink() + "\n\n" + SIGNATURE;
      openWABusinessFast(wa, msg);
    }

    // ================== âœ… ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© ==================
    function localDateKeyFromDate(d){
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function localTodayKey(){ return localDateKeyFromDate(new Date()); }

    async function logTxn(ref, type, reason, amount, balanceAfter, studentName, guardianWhats){
      const dateKey = localTodayKey();
      const createdAtClient = Date.now();

      await ref.collection("txns").add({
        type,
        reason: reason || "",
        amount,
        balanceAfter,
        studentName: studentName || "",
        guardianWhats: guardianWhats || "",
        dateKey,
        createdAtClient,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    // ================== Ø§Ù„Ø·Ù„Ø§Ø¨ (Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù…Ø©) ==================
    async function addStudent(){
      const n=$("newStudentName").value.trim();
      if(!n) return warn("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨");
      const pin=String(Math.floor(1000+Math.random()*9000));
      await db.collection("students").add({
        name:n,classId:currentClassId,active:true,balance:0,pin,openedAt:null,
        guardianWhats:(PARENTS_PHONE[n]||"")
      });
      $("newStudentName").value="";
      await renderStudents();
    }

    async function deleteStudent(studentId, studentName){
      if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨: " + studentName + " ØŸ")) return;
      try{
        const sref = db.collection("students").doc(studentId);
        const tx = await sref.collection("txns").limit(300).get();
        const batch = db.batch();
        tx.forEach(d=>batch.delete(d.ref));
        batch.delete(sref);
        await batch.commit();
      }catch(e){
        try{ await db.collection("students").doc(studentId).delete(); }catch(_){}
      }
      selectedIds.delete(studentId);
      updateSelCount();
      await renderStudents();
    }

    function updateSelCount(){
      const el = $("selCount");
      if(el) el.textContent = "Ø§Ù„Ù…Ø­Ø¯Ø¯: " + selectedIds.size;
    }

    function toggleSelectAll(){
      const all = $("selAll")?.checked;
      document.querySelectorAll('input[data-sel="stu"]').forEach(cb=>{
        cb.checked = !!all;
        const id = cb.getAttribute("data-id");
        if(all) selectedIds.add(id); else selectedIds.delete(id);
      });
      updateSelCount();
    }

    function calcTier(balance){
      const b = Number(balance||0);
      if(b >= 500) return "ğŸ’ Ø£Ù„Ù…Ø§Ø³ÙŠ";
      if(b >= 300) return "ğŸ”· Ù…Ø§Ø³ÙŠ";
      if(b >= 150) return "ğŸ¥‡ Ø°Ù‡Ø¨ÙŠ";
      if(b >= 70)  return "ğŸ¥ˆ ÙØ¶ÙŠ";
      return "ğŸ¥‰ Ø¨Ø±ÙˆÙ†Ø²ÙŠ";
    }

    async function renderStudents(){
      const snap = await db.collection("students").where("classId","==",currentClassId).get();
      const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
      arr.sort((a,b)=>(a.name||"").localeCompare(b.name||"","ar"));

      const pick = $("pickStudent");
      if(pick){
        pick.innerHTML="";
        arr.forEach(s=>{
          const o=document.createElement("option");
          o.value=s.id; o.textContent=s.name;
          pick.appendChild(o);
        });
      }

      const grid = $("studentsGrid");
      if(!grid) return;
      grid.innerHTML="";

      arr.forEach(s=>{
        const card = document.createElement("div");
        card.className="card";
        const isChecked = selectedIds.has(s.id);

        const tierText = (s.tier || calcTier(s.balance)) || "";

        card.innerHTML = `
          <div class="selRow" style="justify-content:space-between;margin:0 0 6px 0">
            <span class="selTag">
              <input type="checkbox" data-sel="stu" data-id="${s.id}" ${isChecked?'checked':''}>
              Ø§Ø®ØªÙŠØ§Ø±
            </span>
            <span class="badge ${s.active?'on':'off'}">${s.active?'ğŸŸ¢ Ù…ÙØ¹Ù„':'ğŸ”´ Ù…Ù‚ÙÙ„'}</span>
          </div>

          <strong>${s.name || ""}</strong>
          <div class="small">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨: <b>${tierText || "â€”"}</b></div>
          <div class="small">Ø§Ù„Ø±ØµÙŠØ¯: ${fmt(s.balance)} Ø±.Ø³</div>
          <div class="small">PIN: <b>${s.pin||""}</b></div>

          <div class="row" style="margin-top:8px">
            <button class="btn2 col js-open">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
            <button class="btn3 col js-toggle">${s.active?'Ø¥Ù‚ÙØ§Ù„':'ØªÙØ¹ÙŠÙ„'}</button>
            <button class="btn3 col js-edit">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…</button>
            <button class="btn3 col js-parent">Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</button>
            <button class="btn whatsapp-btn col js-sendpin">Ø¥Ø±Ø³Ø§Ù„ PIN</button>
            <button class="btn2 col js-pdf">ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ PDF</button>
            <button class="btnRed col js-del">Ø­Ø°Ù</button>
          </div>
        `;

        const cb = card.querySelector('input[data-sel="stu"]');
        cb.onchange = ()=>{
          if(cb.checked) selectedIds.add(s.id);
          else selectedIds.delete(s.id);
          updateSelCount();
        };

        card.querySelector(".js-open").onclick = ()=>{ currentStudentId=s.id; showStudentLogin(s); };
        card.querySelector(".js-toggle").onclick = async()=>{
          await db.collection("students").doc(s.id).update({active:!s.active});
          await renderStudents();
        };
        card.querySelector(".js-edit").onclick = async()=>{
          const nn = prompt("Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:", s.name);
          if(nn) await db.collection("students").doc(s.id).update({name:nn.trim()});
          await renderStudents();
        };
        card.querySelector(".js-parent").onclick = ()=> editGuardianPhone(s.id, s.name);
        card.querySelector(".js-sendpin").onclick = ()=> sendPinToParent(s.id);
        card.querySelector(".js-del").onclick = ()=> deleteStudent(s.id, s.name);

        const pdfBtn = card.querySelector(".js-pdf");
        if(pdfBtn){
          pdfBtn.onclick = ()=> downloadWeeklyStudentPDFForId(s.id);
        }

        grid.appendChild(card);
      });

      updateSelCount();
    }

    // ================== Ø¥Ø±Ø³Ø§Ù„ ÙÙˆØ±ÙŠ ==================
    async function smartAutoSendWhats({type, studentName, amount, reason, guardianWhats}){
      if(!isAutoWAEnabled()) return;

      const parent = normalizePhoneToWA(guardianWhats || "");
      if(!parent){
        openModal("ØªÙ†Ø¨ÙŠÙ‡","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø£Ù…Ø± Ù…Ø³Ø¬Ù„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.");
        return;
      }

      const msg = buildOfficialMessage(type, studentName, amount, reason);
      openWABusinessFast(parent, msg);

      if(isCopyEnabled()){
        setTimeout(()=>{
          openWABusinessFast(CONTACT_PRIMARY, "Ù†Ø³Ø®Ø© Ù„Ù„Ù…Ø¹Ù„Ù…Ø© âœ…\n\n" + msg);
        }, 1200);
      }
    }

    // ================== Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù…Ø© ==================
    async function depositAll(){
      const a=parseFloat($("bulkAmount").value);
      if(isNaN(a)||a<=0) return warn("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ù„Ù„ÙƒÙ„");
      const studs=await db.collection("students").where("classId","==",currentClassId).get();

      const batch=db.batch();
      for(const d of studs.docs){
        const s=d.data(); if(!s.active) continue;
        batch.update(db.collection("students").doc(d.id), {balance:Number(s.balance||0)+a});
      }
      await batch.commit();

      for(const d of studs.docs){
        const s=d.data(); if(!s.active) continue;
        const reason = getReason("reasonTeacher","reasonOtherTeacher");
        await logTxn(db.collection("students").doc(d.id),"Ø¥ÙŠØ¯Ø§Ø¹ (Ù…Ø¹Ù„Ù…Ø©)",reason,a,Number(s.balance||0)+a,s.name,s.guardianWhats||"");
        await smartAutoSendWhats({type:"Ø¥ÙŠØ¯Ø§Ø¹", studentName:s.name, amount:a, reason, guardianWhats:(s.guardianWhats||"")});
      }
      $("bulkAmount").value="";
      await renderStudents();
    }

    async function withdrawAll(){
      const a=parseFloat($("bulkWithdrawAmount").value);
      if(isNaN(a)||a<=0) return warn("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„ÙƒÙ„");
      const studs=await db.collection("students").where("classId","==",currentClassId).get();

      for(const d of studs.docs){
        const s=d.data(); if(!s.active) continue;
        if(Number(s.balance||0) < a) return warn("ÙÙŠ Ø·Ø§Ù„Ø¨ Ø±ØµÙŠØ¯Ù‡ Ù…Ø§ ÙŠÙƒÙÙŠâ€¦ Ù‚Ù„Ù„ Ø§Ù„Ù…Ø¨Ù„Øº");
      }

      const batch=db.batch();
      for(const d of studs.docs){
        const s=d.data(); if(!s.active) continue;
        batch.update(db.collection("students").doc(d.id), {balance:Number(s.balance||0)-a});
      }
      await batch.commit();

      for(const d of studs.docs){
        const s=d.data(); if(!s.active) continue;
        const reason = getReason("reasonTeacher","reasonOtherTeacher");
        await logTxn(db.collection("students").doc(d.id),"Ø³Ø­Ø¨ (Ù…Ø¹Ù„Ù…Ø©)",reason,a,Number(s.balance||0)-a,s.name,s.guardianWhats||"");
        await smartAutoSendWhats({type:"Ø³Ø­Ø¨", studentName:s.name, amount:a, reason, guardianWhats:(s.guardianWhats||"")});
      }
      $("bulkWithdrawAmount").value="";
      await renderStudents();
    }

    async function depositToStudent(){
      const sid = $("pickStudent").value;
      const a = parseFloat($("pickAmount").value);
      if(!sid) return warn("Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨");
      if(isNaN(a) || a<=0) return warn("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº");

      const ref = db.collection("students").doc(sid);
      const doc = await ref.get();
      const s = doc.data();
      if(!s.active) return warn("Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù‚ÙÙ„");

      const nb = Number(s.balance||0) + a;
      const reason = getReason("reasonTeacher","reasonOtherTeacher");
      await ref.update({balance: nb});
      await logTxn(ref,"Ø¥ÙŠØ¯Ø§Ø¹ (Ù…Ø¹Ù„Ù…Ø©)",reason,a,nb,s.name,s.guardianWhats||"");
      await smartAutoSendWhats({type:"Ø¥ÙŠØ¯Ø§Ø¹", studentName:s.name, amount:a, reason, guardianWhats:(s.guardianWhats||"")});

      $("pickAmount").value = "";
      await renderStudents();
    }

    async function withdrawFromStudent(){
      const sid = $("pickStudent").value;
      const a = parseFloat($("pickAmount").value);
      if(!sid) return warn("Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨");
      if(isNaN(a) || a<=0) return warn("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº");

      const ref = db.collection("students").doc(sid);
      const doc = await ref.get();
      const s = doc.data();
      if(!s.active) return warn("Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù‚ÙÙ„");
      if(Number(s.balance||0) < a) return warn("Ø±ØµÙŠØ¯Ù‡ Ù…Ø§ ÙŠÙƒÙÙŠ");

      const nb = Number(s.balance||0) - a;
      const reason = getReason("reasonTeacher","reasonOtherTeacher");
      await ref.update({balance: nb});
      await logTxn(ref,"Ø³Ø­Ø¨ (Ù…Ø¹Ù„Ù…Ø©)",reason,a,nb,s.name,s.guardianWhats||"");
      await smartAutoSendWhats({type:"Ø³Ø­Ø¨", studentName:s.name, amount:a, reason, guardianWhats:(s.guardianWhats||"")});

      $("pickAmount").value = "";
      await renderStudents();
    }

    async function depositSelected(){
      const a = parseFloat($("pickAmount").value);
      if(isNaN(a) || a<=0) return warn("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº (ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„Ù…Ø¨Ù„Øº) Ù„Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ù„Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†");
      if(selectedIds.size===0) return warn("Ù…Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø·Ù„Ø§Ø¨");

      const reason = getReason("reasonTeacher","reasonOtherTeacher");

      for(const sid of selectedIds){
        const ref = db.collection("students").doc(sid);
        const doc = await ref.get();
        if(!doc.exists) continue;
        const s = doc.data();
        if(!s.active) continue;
        const nb = Number(s.balance||0) + a;
        await ref.update({balance: nb});
        await logTxn(ref,"Ø¥ÙŠØ¯Ø§Ø¹ (Ù…Ø¹Ù„Ù…Ø©)",reason,a,nb,s.name,s.guardianWhats||"");
        await smartAutoSendWhats({type:"Ø¥ÙŠØ¯Ø§Ø¹", studentName:s.name, amount:a, reason, guardianWhats:(s.guardianWhats||"")});
      }
      await renderStudents();
    }

    async function withdrawSelected(){
      const a = parseFloat($("pickAmount").value);
      if(isNaN(a) || a<=0) return warn("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº (ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„Ù…Ø¨Ù„Øº) Ù„Ù„Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†");
      if(selectedIds.size===0) return warn("Ù…Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø·Ù„Ø§Ø¨");

      const reason = getReason("reasonTeacher","reasonOtherTeacher");

      for(const sid of selectedIds){
        const ref = db.collection("students").doc(sid);
        const doc = await ref.get();
        if(!doc.exists) continue;
        const s = doc.data();
        if(!s.active) continue;
        if(Number(s.balance||0) < a) continue;
        const nb = Number(s.balance||0) - a;
        await ref.update({balance: nb});
        await logTxn(ref,"Ø³Ø­Ø¨ (Ù…Ø¹Ù„Ù…Ø©)",reason,a,nb,s.name,s.guardianWhats||"");
        await smartAutoSendWhats({type:"Ø³Ø­Ø¨", studentName:s.name, amount:a, reason, guardianWhats:(s.guardianWhats||"")});
      }
      await renderStudents();
    }

    // ================== Ø§Ù„ØªÙ†Ù‚Ù„ ==================
    function backToClasses(){ go("classesPage"); renderTabs(); }
    function openClassPage(){
      go("classPage");
      selectedIds.clear();
      if($("selAll")) $("selAll").checked=false;
      renderStudents();
      initTeacherReasonAlways();
    }
    function backToClass(){
      if(IS_STUDENT_ENTRY){ go("studentLoginPage"); return; }
      go("classPage"); renderStudents();
    }

    // ================== Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„Ù…Ø© ==================
    function showStudentLogin(s){
      currentAccess = "teacher";
      go("studentLoginPage");
      $("stuLoginTitle").textContent="Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ â€“ " + (classes.find(c=>c.id===currentClassId)?.name || "");
      $("stuName").value=s.name;
      $("stuName").readOnly = true;
      $("stuPin").value="";
      $("stuLocked").classList.add("hidden");
      if(!s.active){
        $("stuLocked").textContent = "Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù‚ÙÙ„";
        $("stuLocked").classList.remove("hidden");
      }
    }

    // ================== ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ + ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ==================
    async function renderOpenedAt(){
      const doc=await db.collection("students").doc(currentStudentId).get();
      const s=doc.data();
      $("openedAt").textContent = (s.openedAt && s.openedAt.toDate) ? s.openedAt.toDate().toLocaleString("ar-SA") : "â€”";
    }
    async function buildTransferList(){
      const snap=await db.collection("students").get();
      const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
      arr.sort((a,b)=>(a.name||"").localeCompare(b.name||"","ar"));
      $("transferTo").innerHTML="";
      arr.forEach(s=>{ if(s.id===currentStudentId) return; const o=document.createElement("option"); o.value=s.id; o.textContent=s.name; $("transferTo").appendChild(o); });
    }

    // ================== ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ ==================
    async function studentLogin(){
      try{
        if(IS_STUDENT_ENTRY){
          currentAccess = "student";
          const name = ($("stuName")?.value || "").trim();
          const pin  = ($("stuPin")?.value || "").trim();
          if(!name || !pin) return warn("Ø§ÙƒØªØ¨/ÙŠ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ");

          const snap = await db.collection("students").where("name","==",name).limit(1).get();
          if(snap.empty) return warn("Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…");
          const doc = snap.docs[0];
          currentStudentId = doc.id;
          const s = doc.data() || {};

          if(!s.active) return warn("Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù‚ÙÙ„");
          if(String(pin) !== String(s.pin||"")) return warn("Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ ØºÙ„Ø·");
          if(!s.openedAt) await db.collection("students").doc(currentStudentId)
            .update({openedAt: firebase.firestore.FieldValue.serverTimestamp()});

          await playWelcome();
          go("studentAccountPage");
          $("studentHeader").textContent=s.name;
          $("statusBadge").className="badge "+(s.active?"on":"off");
          $("statusBadge").textContent=s.active?"ğŸŸ¢ Ù†Ø´Ø·":"ğŸ”´ Ù…Ù‚ÙÙ„";
          $("studentBalance").textContent=fmt(s.balance);

          await renderOpenedAt();
          await buildTransferList();

          setupReasonUI($("op").value,'reasonStudent','reasonOtherStudent');
          await showStatement();
          return;
        }

        currentAccess = "teacher";
        const ref=db.collection("students").doc(currentStudentId);
        const doc=await ref.get();
        const s=doc.data();

        if(!s.active) return warn("Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù‚ÙÙ„");
        if($("stuPin").value.trim()!==String(s.pin||"")) return warn("Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ ØºÙ„Ø·");
        if(!s.openedAt) await ref.update({openedAt: firebase.firestore.FieldValue.serverTimestamp()});

        await playWelcome();

        go("studentAccountPage");
        $("studentHeader").textContent=s.name;
        $("statusBadge").className="badge "+(s.active?"on":"off");
        $("statusBadge").textContent=s.active?"ğŸŸ¢ Ù†Ø´Ø·":"ğŸ”´ Ù…Ù‚ÙÙ„";
        $("studentBalance").textContent=fmt(s.balance);

        await renderOpenedAt();
        await buildTransferList();

        setupReasonUI($("op").value,'reasonStudent','reasonOtherStudent');
        await showStatement();
      }catch(e){
        console.log(e);
        warn("ØµØ§Ø± Ø®Ø·Ø£â€¦ Ø¬Ø±Ù‘Ø¨ÙŠ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©");
      }
    }

    // ================== âœ… ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ==================
    async function showStatement(){
      const from=$("fromDate").value;
      const to=$("toDate").value;

      let q = db.collection("students").doc(currentStudentId).collection("txns")
        .orderBy("createdAtClient","desc").limit(80);

      if(from && to){
        const fromMs = new Date(from + "T00:00:00").getTime();
        const toMs   = new Date(to   + "T23:59:59").getTime();

        q = db.collection("students").doc(currentStudentId).collection("txns")
          .where("createdAtClient", ">=", fromMs)
          .where("createdAtClient", "<=", toMs)
          .orderBy("createdAtClient","desc")
          .limit(250);
      }

      const snap=await q.get();
      const rows=$("stmtRows"); rows.innerHTML="";
      if(snap.empty){
        rows.innerHTML='<tr><td colspan="5" class="small">Ù…Ø§ ÙÙŠÙ‡ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ù‡Ø§Ù„ÙØªØ±Ø©â€¦</td></tr>';
        return;
      }
      snap.forEach(d=>{
        const x=d.data();
        const t=x.createdAtClient ? new Date(x.createdAtClient).toLocaleString("ar-SA") : "";
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${t}</td><td>${x.type||""}</td><td>${x.reason||""}</td><td>${fmt(x.amount)}</td><td>${fmt(x.balanceAfter)}</td>`;
        rows.appendChild(tr);
      });
    }

    // ================== ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ© Ø¯Ø§Ø®Ù„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨ ==================
    async function executeOp(){
      const ref=db.collection("students").doc(currentStudentId);
      const doc=await ref.get();
      const s=doc.data();
      const op=$("op").value;
      const amt=parseFloat($("amt").value);

      if(isNaN(amt) || amt<=0) return warn("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");

      const reason = getReason("reasonStudent","reasonOtherStudent");

      if(op==="deposit"){
        const nb=Number(s.balance||0)+amt;
        await ref.update({balance:nb});
        await logTxn(ref, "Ø¥ÙŠØ¯Ø§Ø¹", reason, amt, nb, s.name, s.guardianWhats||"");
      }else if(op==="withdraw"){
        if(Number(s.balance||0) < amt) return warn("Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ø§ ÙŠÙƒÙÙŠ");
        const nb=Number(s.balance||0)-amt;
        await ref.update({balance:nb});
        await logTxn(ref, "Ø³Ø­Ø¨", reason, amt, nb, s.name, s.guardianWhats||"");
      }else if(op==="transfer"){
        if(Number(s.balance||0) < amt) return warn("Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ø§ ÙŠÙƒÙÙŠ Ù„Ù„ØªØ­ÙˆÙŠÙ„");
        const toId=$("transferTo").value;
        const toRef=db.collection("students").doc(toId);
        const toDoc=await toRef.get();
        if(!toDoc.exists) return warn("Ø§Ù„Ù…Ø³ØªÙ„Ù… Ù…Ùˆ Ù…ÙˆØ¬ÙˆØ¯");
        const to=toDoc.data();

        const batch=db.batch();
        batch.update(ref, {balance:Number(s.balance||0)-amt});
        batch.update(toRef, {balance:Number(to.balance||0)+amt});
        await batch.commit();

        await logTxn(ref, "ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ "+to.name, reason, amt, Number(s.balance||0)-amt, s.name, s.guardianWhats||"");
        await logTxn(toRef, "ØªØ­ÙˆÙŠÙ„ Ù…Ù† "+(s.name||"Ø·Ø§Ù„Ø¨"), reason, amt, Number(to.balance||0)+amt, to.name, to.guardianWhats||"");
      }

      $("amt").value="";
      const updated=await ref.get();
      $("studentBalance").textContent=fmt(updated.data().balance);

      setupReasonUI($("op").value,'reasonStudent','reasonOtherStudent');
      await showStatement();
    }

    // ================== âœ… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ==================
    let dailyOpsCache = [];
    let dailySelectedIndex = null;

    function setDailyPick(idx){
      dailySelectedIndex = Number(idx);

      document.querySelectorAll(".opCard").forEach(el=>{
        const i = Number(el.getAttribute("data-idx"));
        el.classList.toggle("selected", i === dailySelectedIndex);
      });

      const hint = $("dailyPickHint");
      if(hint){
        const op = dailyOpsCache[dailySelectedIndex];
        const name = op?.studentName ? `âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯: ${op.studentName}` : "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø¹Ù…Ù„ÙŠØ©";
        hint.textContent = " " + name;
      }
    }

    async function loadDailyOps(){
      const inp = document.getElementById("dailyDate");
      const chosenStr = inp.value ? inp.value : new Date().toISOString().slice(0,10);
      if(!inp.value) inp.value = chosenStr;

      try{
        dailyOpsCache = [];
        dailySelectedIndex = null;
        if($("dailyPickHint")) $("dailyPickHint").textContent = "";

        const studentsSnap = await db.collection("students").get();

        const promises = studentsSnap.docs.map(async (stuDoc) => {
          const s = stuDoc.data() || {};
          const txSnap = await db.collection("students")
            .doc(stuDoc.id)
            .collection("txns")
            .where("dateKey", "==", chosenStr)
            .limit(200)
            .get();

          txSnap.forEach(tx => {
            const x = tx.data() || {};
            if(!x.studentName) x.studentName = s.name || "";
            if(!x.guardianWhats) x.guardianWhats = s.guardianWhats || "";
            dailyOpsCache.push(x);
          });
        });

        await Promise.all(promises);
        dailyOpsCache.sort((a,b)=> (b.createdAtClient||0) - (a.createdAtClient||0));

        renderDailyOps();
      }catch(e){
        console.log(e);
        document.getElementById("dailyOpsList").innerHTML =
          '<div class="small" style="color:#b00020;font-weight:700">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª.</div>';
      }
    }

    function renderDailyOps(){
      const box = $("dailyOpsList");

      if(!dailyOpsCache.length){
        box.innerHTML = '<div class="small">Ù…Ø§ ÙÙŠÙ‡ Ø¹Ù…Ù„ÙŠØ§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®.</div>';
        return;
      }

      box.innerHTML = dailyOpsCache.map((x, idx)=>{
        const t = x.createdAtClient ? new Date(x.createdAtClient).toLocaleString("ar-SA") : "";
        const checked = (dailySelectedIndex === idx) ? "checked" : "";
        return `
          <div class="card opCard ${checked ? "selected":""}" data-idx="${idx}" style="margin:8px 0;cursor:pointer"
               onclick="setDailyPick(${idx}); const r=document.querySelector('input[name=dailyPick][value=\\'${idx}\\']'); if(r) r.checked=true;">
            <div class="dailyPickRow">
              <div class="dailyPickLeft">
                <input type="radio" name="dailyPick" value="${idx}" ${checked}
                  onchange="setDailyPick(${idx})">
                <b>${x.studentName || "â€”"}</b>
              </div>
              <div class="small">Ø§Ù„ÙˆÙ‚Øª: ${t}</div>
            </div>
            <div class="small">Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${x.type || "â€”"}</div>
            <div class="small">Ø§Ù„Ù…Ø¨Ù„Øº: ${x.amount ?? ""} Ø±.Ø³</div>
            <div class="small">Ø§Ù„Ø³Ø¨Ø¨: ${x.reason || "â€”"}</div>
          </div>
        `;
      }).join("");

      if(dailySelectedIndex === null && dailyOpsCache.length){
        dailySelectedIndex = 0;
        setDailyPick(0);
        const firstRadio = document.querySelector('input[name="dailyPick"][value="0"]');
        if(firstRadio) firstRadio.checked = true;
      }
    }

    function sendDailyOpsWhats(){
      if(!dailyOpsCache.length){
        openModal("ØªÙ†Ø¨ÙŠÙ‡","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ù„Ø¥Ø±Ø³Ø§Ù„. Ø§Ø¶ØºØ·ÙŠ (Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª) Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }

      if(dailySelectedIndex === null){
        openModal("ØªÙ†Ø¨ÙŠÙ‡","Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† (â—‹) Ø«Ù… Ø§Ø¶ØºØ·ÙŠ Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨.");
        return;
      }

      const op = dailyOpsCache[dailySelectedIndex];
      const phone = normalizePhoneToWA(op.guardianWhats || "");
      if(!phone){
        openModal("ØªÙ†Ø¨ÙŠÙ‡","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø£Ù…Ø± Ù…Ø³Ø¬Ù„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.");
        return;
      }

      const msg = buildOfficialMessage(op.type||"Ø¹Ù…Ù„ÙŠØ©", op.studentName||"â€”", op.amount, op.reason);
      openWABusinessFast(phone, msg);
    }

    // ================== PDF Ø£Ø³Ø¨ÙˆØ¹ÙŠ ==================
    function getWeekRange(endStr){
      const end = endStr ? new Date(endStr+"T23:59:59") : new Date();
      const day = end.getDay();
      const diffToSat = (day - 6 + 7) % 7;
      end.setDate(end.getDate() - diffToSat);

      const start = new Date(end);
      start.setDate(end.getDate() - 6);
      start.setHours(0,0,0,0);

      const end2 = new Date(end);
      end2.setHours(23,59,59,999);

      return { startMs: start.getTime(), endMs: end2.getTime(), start, end: end2 };
    }

    function sumWeekly(txns){
      let dep=0,wit=0,tr=0;
      txns.forEach(x=>{
        const a = Number(x.amount||0);
        const t = String(x.type||"");
        if(t.includes("Ø¥ÙŠØ¯Ø§Ø¹")) dep += a;
        else if(t.includes("Ø³Ø­Ø¨")) wit += a;
        else if(t.includes("ØªØ­ÙˆÙŠÙ„")) tr += a;
      });
      return { count: txns.length, dep, wit, tr, net: dep - wit };
    }

    async function elementToPDF(el, filename){
      const opt = {
        margin: 8,
        filename,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      };
      await new Promise(r=>setTimeout(r,80));
      await html2pdf().set(opt).from(el).save();
    }

    async function buildWeeklyStudentPaperFor(studentId, endStr){
      const {startMs, endMs, start, end} = getWeekRange(endStr);

      const studDoc = await db.collection("students").doc(studentId).get();
      if(!studDoc.exists) throw new Error("Student not found");
      const s = studDoc.data() || {};
      const tier = s.tier || calcTier(s.balance);
      const rangeText = `${start.toLocaleDateString("ar-SA")} â†’ ${end.toLocaleDateString("ar-SA")}`;

      const q = db.collection("students").doc(studentId).collection("txns")
        .where("createdAtClient", ">=", startMs)
        .where("createdAtClient", "<=", endMs)
        .orderBy("createdAtClient","desc")
        .limit(400);

      const snap = await q.get();
      const txns = [];
      snap.forEach(d=>txns.push(d.data()||{}));

      const S = sumWeekly(txns);

      const rowsHtml = txns.slice(0,120).map(x=>{
        const t=x.createdAtClient ? new Date(x.createdAtClient).toLocaleString("ar-SA") : "";
        return `<tr>
          <td>${t}</td>
          <td>${x.type||""}</td>
          <td>${x.reason||""}</td>
          <td>${fmt(x.amount)}</td>
          <td>${fmt(x.balanceAfter)}</td>
        </tr>`;
      }).join("");

      const temp = document.getElementById("pdfTemp");
      temp.classList.remove("hidden");
      temp.style.display = "block";
      temp.innerHTML = `
        <div id="weeklyStudentReportPaper" style="background:#fff;padding:12px;border-radius:14px">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <div>
              <div style="font-weight:900;color:#00205B">ğŸ“Œ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ù„Ù„Ø·Ø§Ù„Ø¨</div>
              <div style="font-size:12px;color:#666">Ø§Ù„Ø·Ø§Ù„Ø¨: <b>${s.name||"â€”"}</b></div>
              <div style="font-size:12px;color:#666">Ø§Ù„ÙØªØ±Ø©: ${rangeText}</div>
            </div>
            <div class="tierBadge">${tier}</div>
          </div>

          <hr style="border:0;border-top:1px solid #eee;margin:10px 0">

          <div class="reportGrid">
            <div class="reportKpi"><div class="k">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div><div class="v">${S.count}</div></div>
            <div class="reportKpi"><div class="k">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹</div><div class="v">${fmt(S.dep)}</div></div>
            <div class="reportKpi"><div class="k">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø­Ø¨</div><div class="v">${fmt(S.wit)}</div></div>
            <div class="reportKpi"><div class="k">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª</div><div class="v">${fmt(S.tr)}</div></div>
            <div class="reportKpi"><div class="k">Ø§Ù„ØµØ§ÙÙŠ</div><div class="v">${fmt(S.net)}</div></div>
            <div class="reportKpi"><div class="k">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</div><div class="v">${fmt(s.balance)}</div></div>
          </div>

          <hr style="border:0;border-top:1px solid #eee;margin:10px 0">

          <div class="tableWrap" style="margin-top:10px">
            <table>
              <thead><tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th><th>Ø§Ù„Ø³Ø¨Ø¨</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th></tr></thead>
              <tbody>
                ${rowsHtml || `<tr><td colspan="5" class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø®Ù„Ø§Ù„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹.</td></tr>`}
              </tbody>
            </table>
          </div>

          <div class="small" style="margin-top:8px">
            ${TEACHER_BANK_TITLE} â€” ${SIGNATURE}
          </div>
        </div>
      `;

      return document.getElementById("weeklyStudentReportPaper");
    }

    async function downloadWeeklyStudentPDFForId(studentId){
      try{
        const endStr = "";
        const paper = await buildWeeklyStudentPaperFor(studentId, endStr);
        const studDoc = await db.collection("students").doc(studentId).get();
        const s = studDoc.data() || {};
        const name = (s.name || "student").replace(/\s+/g,"_");
        await elementToPDF(paper, `Weekly_Report_${name}.pdf`);
      }catch(e){
        console.log(e);
        openModal("ØªÙ†Ø¨ÙŠÙ‡","ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ PDF Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¢Ù†.");
      }finally{
        const temp = document.getElementById("pdfTemp");
        if(temp){ temp.innerHTML=""; temp.classList.add("hidden"); }
      }
    }

    // ================== Onboarding Logic (ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ø¨Ø¯Ø£) ==================
    let onbIndex = 0;
    let onbAfterDone = null;
    let onbSwipeBound = false; // âœ… ÙƒØ§Ù† Ù†Ø§Ù‚Øµ

    function showOnboardingIfNeeded(afterDone){
      onbAfterDone = (typeof afterDone === "function") ? afterDone : null;

      onbIndex = 0;
      updateOnbUI();

      const ov = document.getElementById("onboardOverlay");
      if(ov){
        ov.style.display = "flex";
        ov.setAttribute("aria-hidden","false");
      }
      enableOnbSwipe();
    }

    function finishOnboarding(){
      const ov = document.getElementById("onboardOverlay");
      if(ov){
        ov.style.display = "none";
        ov.setAttribute("aria-hidden","true");
      }
      const cb = onbAfterDone;
      onbAfterDone = null;
      if(typeof cb === "function") cb();
    }

    function updateOnbUI(){
      const track = document.getElementById("onbTrack");
      const dotsWrap = document.getElementById("onbDots");

      if(track) track.style.transform = `translateX(-${onbIndex * 100}%)`;

      if(dotsWrap){
        const dots = dotsWrap.querySelectorAll(".onbDot");
        dots.forEach((d,i)=> d.classList.toggle("active", i===onbIndex));
      }
    }
    function onbNext(){
      if(onbIndex >= 2) return finishOnboarding();
      onbIndex++;
      updateOnbUI();
    }
    function onbPrev(){
      if(onbIndex <= 0) return;
      onbIndex--;
      updateOnbUI();
    }

    function enableOnbSwipe(){
      if(onbSwipeBound) return;
      const vp = document.getElementById("onbViewport");
      if(!vp) return;
      onbSwipeBound = true;

      let startX = 0, dx = 0, dragging=false;

      const onDown = (x)=>{ dragging=true; startX=x; dx=0; };
      const onMove = (x)=>{ if(!dragging) return; dx = x-startX; };
      const onUp = ()=>{
        if(!dragging) return;
        dragging=false;
        if(Math.abs(dx) > 45){
          // RTL UX: Ø³Ø­Ø¨ ÙŠÙ…ÙŠÙ† = Ø§Ù„Ø³Ø§Ø¨Ù‚ØŒ Ø³Ø­Ø¨ ÙŠØ³Ø§Ø± = Ø§Ù„ØªØ§Ù„ÙŠ
          if(dx > 0) onbPrev();
          else onbNext();
        }
        dx=0;
      };

      vp.onpointerdown = (e)=> onDown(e.clientX);
      vp.onpointermove = (e)=> onMove(e.clientX);
      vp.onpointerup = ()=> onUp();
      vp.onpointercancel = ()=> onUp();

      vp.ontouchstart = (e)=> onDown(e.touches[0].clientX);
      vp.ontouchmove  = (e)=> onMove(e.touches[0].clientX);
      vp.ontouchend   = ()=> onUp();
    }

    // ================== âœ… ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ + Splash Ø«Ù… startOverlay ==================
    document.addEventListener("DOMContentLoaded", async () => {
      const link = $("forgotPinLink");
      if(link) link.addEventListener("click", (e)=>{ e.preventDefault(); forgotStudentPin(); });

      const opSel = $("op");
      if(opSel){
        opSel.addEventListener("change", ()=> setupReasonUI(opSel.value, "reasonStudent", "reasonOtherStudent"));
      }

      await loadForgotSetting();

      if(IS_STUDENT_ENTRY){
        $("startP").innerHTML = "Ø¨ÙˆØ§Ø¨Ø© Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ ğŸ‘‡<br>Ø§Ø¶ØºØ· Ø²Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆÙ†Ù†Ø·Ù„Ù‚ ğŸš€";
      }

      try{
        await ensureSeed();
        await renderTabs();
        $("connPill").textContent="Ø¬Ø§Ù‡Ø² âœ…";
        $("connPill").style.background="#dff4e3";
        $("connPill").style.color="#2e7d32";
      }catch(e){
        $("connPill").textContent="Ø¬Ø§Ù‡Ø² âœ…";
      }

      initTeacherReasonAlways();

      setTimeout(()=>{
        const logo = document.getElementById("splashLogo");
        const text = document.getElementById("splashText");
        if(logo) logo.style.transform="translateX(0) scale(1)";
        if(text){
          text.style.transform="translateX(0)";
          text.style.opacity="1";
        }
      },200);

      setTimeout(()=>{
        const s=document.getElementById("splashScreen");
        if(s) s.style.display="none";
        const start=document.getElementById("startOverlay");
        if(start) start.style.display="flex";
      },2800);

      // âŒ ØªÙ… Ø­Ø°Ù showOnboardingIfNeeded Ù…Ù† Ù‡Ù†Ø§ (ØµØ§Ø± ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø²Ø± Ø§Ø¨Ø¯Ø£)
    });
  </script>

  <div id="pdfTemp" class="hidden"></div>
</body>
</html>
