<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª â€“ Ø§Ù„Ù…ØµØ±ÙÙŠ Ù„Ù„Ù…Ø¹Ù„Ù…Ø© Ø³Ø§Ø±Ø© Ø­Ù‚ÙˆÙŠ</title>

<style>
:root{
  --navy:#00205B;--rajhi:#0055A4;--sky:#EAF3FB;--sky2:#CFE6F7;--beige:#FAF9F7;
  --green:#2e7d32;--red:#b00020;--text:#1b1f23;
}
*{box-sizing:border-box;font-family:Tahoma,Arial,sans-serif}
body{margin:0;background:var(--beige);color:var(--text)}
.hidden{display:none}

.topbar{
  position:sticky;top:0;z-index:2000;
  background:linear-gradient(90deg,var(--navy),var(--rajhi));
  color:#fff;padding:12px 14px;display:flex;align-items:center;gap:12px;
}
.topbar .titles{flex:1;text-align:center;line-height:1.35}
.topbar .t1{font-weight:800;font-size:16px}
.topbar .t2{font-size:12px;opacity:.95}
.logo{height:56px;width:auto;background:rgba(255,255,255,.78);border-radius:12px;padding:6px}
.footer{text-align:center;padding:14px 12px;color:var(--navy);font-weight:700}

.container{max-width:980px;margin:14px auto;padding:0 12px}
.card{background:#fff;border-radius:14px;padding:14px;margin:10px 0;box-shadow:0 8px 18px rgba(0,0,0,.06)}
.card.soft{background:var(--sky)}
.row{display:flex;gap:10px;flex-wrap:wrap}
.col{flex:1;min-width:160px}
input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #ccc;font-size:14px}
textarea{min-height:90px;resize:vertical}
button{border:0;border-radius:10px;padding:10px 12px;cursor:pointer;font-size:14px}
.btn{background:var(--rajhi);color:#fff}
.btn2{background:var(--sky2);color:#003}
.btn3{background:#eef6fb;color:#003}
.btnRed{background:var(--red);color:#fff}

.tabs{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:10px 0}
.tab{background:#e9f4fb;color:#003;padding:8px 12px;border-radius:999px;cursor:pointer;font-size:14px}
.tab.active{background:var(--rajhi);color:#fff}

.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
@media(max-width:760px){.grid2{grid-template-columns:1fr}}

.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px}
.badge.on{background:#dff4e3;color:var(--green)}
.badge.off{background:#fde2e2;color:var(--red)}
.small{font-size:12px;color:#666}
hr{border:0;border-top:1px solid #eee;margin:10px 0}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:18px;z-index:9999}
.modalBox{background:#fff;border-radius:16px;max-width:760px;width:100%;padding:16px;text-align:center}
.modalBox h3{margin:0 0 8px 0;color:var(--navy)}
.modalBox p{margin:0 0 12px 0;font-size:15px;line-height:1.7;white-space:pre-line;text-align:right}
.modalActions{display:flex;gap:10px;flex-wrap:wrap}
.modalActions a,.modalActions button{flex:1;text-decoration:none}

/* Start overlay */
#startOverlay{
  position:fixed;inset:0;background:#0a2d66;display:flex;align-items:center;justify-content:center;padding:18px;z-index:9998
}
.startBox{max-width:560px;width:100%;background:#fff;border-radius:18px;padding:18px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.pill{display:inline-block;background:#e9f4fb;color:#003;padding:6px 10px;border-radius:999px;font-size:12px;margin-bottom:10px}

/* Statement */
.tableWrap{overflow:auto;border-radius:12px;background:#f7fbff;border:1px solid #e6eef7}
table{width:100%;border-collapse:collapse;min-width:740px}
th,td{padding:10px;border-bottom:1px solid #e6eef7;text-align:center;font-size:13px;white-space:nowrap}
th{background:#eef6ff;color:#0b2a66}
tr:last-child td{border-bottom:none}
</style>
</head>

<body>

<div class="topbar">
  <img class="logo" src="school-logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©" onerror="this.style.display='none'">
  <div class="titles">
    <div class="t1">Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª â€“ Ø§Ù„Ù…ØµØ±ÙÙŠ Ù„Ù„Ù…Ø¹Ù„Ù…Ø© Ø³Ø§Ø±Ø© Ø­Ù‚ÙˆÙŠ</div>
    <div class="t2">Ù…Ø¯Ø±Ø³Ø© Ø±ÙˆØ§Ø¯ Ø§Ù„Ø´Ø±Ù‚ Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</div>
  </div>
  <div style="width:56px"></div>
</div>

<audio id="welcomeMp3" preload="auto" src="welcome.mp3"></audio>
<audio id="welcomeM4a" preload="auto" src="welcome.m4a"></audio>

<!-- Ø´Ø§Ø´Ø© Ø§Ø¨Ø¯Ø£ ÙˆØ§Ø­Ø¯Ø© (ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø© ÙˆØ§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø·) -->
<div id="startOverlay">
  <div class="startBox">
    <div class="pill" id="connPill">Ø¬Ø§Ù‡Ø² âœ…</div>
    <h3>Ù‡Ù„Ø§ ÙˆØ§Ù„Ù„Ù‡! ğŸ‘‹</h3>
    <p id="startText">Ø¬Ø§Ù‡Ø²ÙŠÙ† Ù†Ø¨Ø¯Ø£ØŸ<br>Ø§Ø¶ØºØ· Ø²Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆÙ†Ù†Ø·Ù„Ù‚ ğŸš€</p>
    <button class="btn" id="startBtn">Ø§Ø¨Ø¯Ø£</button>
    <div class="small" id="connNote" style="margin-top:8px"></div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal">
  <div class="modalBox">
    <h3 id="mTitle"></h3>
    <p id="mBody"></p>
    <div class="modalActions" id="mActions">
      <button class="btn" onclick="closeModal()">Ù…ÙˆØ§ÙÙ‚</button>
    </div>
  </div>
</div>

<!-- Teacher Login -->
<div id="teacherLoginPage" class="hidden">
  <div class="container">
    <div class="card">
      <h3 style="margin:0 0 10px 0;color:var(--navy)">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…Ø©</h3>
      <input id="tu" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
      <input id="tp" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
      <div class="row">
        <button class="btn col" onclick="teacherLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <button class="btn3 col" onclick="forgotTeacher()">Ù†Ø³ÙŠØª Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ</button>
      </div>
      <div class="small">Ø§Ù„Ø¯Ø®ÙˆÙ„: teacher / 12345</div>
    </div>
  </div>
</div>

<!-- Student Login (Ø¹Ø§Ù…) -->
<div id="studentLoginPage" class="hidden">
  <div class="container">
    <div class="card">
      <h3 style="margin:0 0 10px 0;color:var(--navy)">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
      <input id="stuName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ ÙƒÙ…Ø§ Ù‡Ùˆ Ù…Ø³Ø¬Ù‘Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…">
      <input id="stuPin" type="password" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ (PIN)">
      <div class="small" style="margin:8px 0;">
        <a href="javascript:void(0)" onclick="forgotStudentPin()" style="color:#0055A4;font-weight:700">Ù†Ø³ÙŠØª Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠØŸ</a>
      </div>
      <button class="btn" onclick="studentLogin()">Ø¯Ø®ÙˆÙ„</button>
      <button class="btn3" onclick="backToStart()">Ø±Ø¬ÙˆØ¹</button>
    </div>
  </div>
</div>

<!-- Student Account -->
<div id="studentAccountPage" class="hidden">
  <div class="container">
    <div class="card soft">
      <h3 style="margin:0 0 10px 0;color:var(--navy)" id="studentHeader"></h3>
      <div class="row">
        <div class="col"><div class="small">Ø§Ù„Ø­Ø§Ù„Ø©</div><div id="statusBadge" class="badge"></div></div>
        <div class="col"><div class="small">Ø§Ù„Ø±ØµÙŠØ¯</div>
          <div style="font-size:26px;font-weight:800;color:var(--navy)">
            <span id="studentBalance">0</span> Ø±.Ø³
          </div>
        </div>
      </div>

      <hr>

      <div class="row">
        <div class="col">
          <div class="small">Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</div>
          <select id="op">
            <option value="deposit">Ø¥ÙŠØ¯Ø§Ø¹</option>
            <option value="withdraw">Ø³Ø­Ø¨</option>
            <option value="transfer">ØªØ­ÙˆÙŠÙ„</option>
          </select>
        </div>
        <div class="col"><div class="small">Ø§Ù„Ù…Ø¨Ù„Øº</div><input id="amt" type="number" step="0.01"></div>
        <div class="col"><div class="small">ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰</div><select id="transferTo"></select></div>
      </div>

      <div class="row">
        <button class="btn col" onclick="executeOp()">ØªÙ†ÙÙŠØ°</button>
        <button class="btn3 col" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>

      <hr>

      <div class="small">ÙƒØ´Ù Ø¢Ø®Ø± 30 Ø¹Ù…Ù„ÙŠØ©</div>
      <div class="tableWrap" style="margin-top:10px">
        <table>
          <thead><tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th></tr></thead>
          <tbody id="stmtRows"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Teacher Panel (Ù…Ø®ØªØµØ±) -->
<div id="classesPage" class="hidden">
  <div class="container">
    <div class="card soft">
      <div class="small">Ø§Ø®ØªØ± ÙØµÙ„ Ø«Ù… Ø§Ø¯Ø®Ù„ ØµÙØ­Ø© Ø§Ù„ÙØµÙ„</div>
      <div class="tabs" id="classTabs"></div>
      <div class="row">
        <button class="btn2 col" onclick="openClassPage()">Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙØµÙ„</button>
        <button class="btn3 col" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
    <div class="small">* Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„ÙØµÙˆÙ„ØŒ Ø§Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ù†Ø¯Ùƒ ÙÙŠ Ù†Ø³Ø®ØªÙƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù…Ù…ÙƒÙ† Ù†Ø±Ø¬Ø¹ Ù†Ø¯Ù…Ø¬Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§).</div>
  </div>
</div>

<div id="classPage" class="hidden">
  <div class="container">
    <div class="card soft">
      <h3 style="margin:0 0 10px 0;color:var(--navy)" id="classTitle">Ø§Ù„ÙØµÙ„</h3>
      <div id="studentsGrid" class="grid2"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn3 col" onclick="backToClasses()">Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙØµÙˆÙ„</button>
      </div>
    </div>
  </div>
</div>

<div class="footer">Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù„ØºØ© Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡ âœ¨</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

<script>
// ===== Firebase config =====
firebase.initializeApp({
  apiKey: "AIzaSyDP-pi0tbFQ9bNRihrLz_kUs-JBoa9Cw4Y",
  authDomain: "sara-haywire.firebaseapp.com",
  projectId: "sara-haywire"
});
const db = firebase.firestore();

// ===== Helpers =====
function $(id){ return document.getElementById(id); }
function openModal(title, bodyHtml, actionsHtml){
  $("mTitle").textContent=title;
  $("mBody").innerHTML=bodyHtml;
  $("mActions").innerHTML=actionsHtml||'<button class="btn" onclick="closeModal()">Ù…ÙˆØ§ÙÙ‚</button>';
  $("modal").style.display="flex";
}
function closeModal(){ $("modal").style.display="none"; }
function warn(msg){ openModal("ØªÙ†Ø¨ÙŠÙ‡", msg); }
function fmt(x){ return (Math.round((Number(x||0)+Number.EPSILON)*100)/100).toFixed(2); }
function go(page){
  ["teacherLoginPage","studentLoginPage","studentAccountPage","classesPage","classPage"].forEach(id=>$(id).classList.add("hidden"));
  $(page).classList.remove("hidden");
}
function logout(){ location.reload(); }

async function playWelcome(){
  // Ù†ØºÙ…Ø© Ù‚ØµÙŠØ±Ø© + Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª Ø¥Ù† ÙˆØ¬Ø¯Øª
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type="triangle"; o.frequency.value=740; g.gain.value=0.10;
    o.connect(g); g.connect(ctx.destination); o.start();
    setTimeout(()=>{o.stop(); ctx.close();}, 220);
  }catch(e){}

  try{
    const m4a = $("welcomeM4a");
    if(m4a && m4a.src){ m4a.currentTime=0; await m4a.play(); return; }
  }catch(e){}
  try{
    const mp3 = $("welcomeMp3");
    if(mp3 && mp3.src){ mp3.currentTime=0; await mp3.play(); return; }
  }catch(e){}
}

// ===== Mode =====
const params = new URLSearchParams(window.location.search);
const IS_STUDENT_MODE = (params.get("mode") === "student");

// ===== Start overlay behaviour =====
function backToStart(){
  go("teacherLoginPage"); // Ù…Ø¤Ù‚ØªÙ‹Ø§ Ù†Ø®ÙÙŠ Ø§Ù„ØµÙØ­Ø§Øª
  $("startOverlay").style.display="flex";
  // Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ¯ Ù†ØºÙŠØ± Ø§Ù„Ù†Øµ
  $("startText").innerHTML = IS_STUDENT_MODE
    ? "Ø¬Ø§Ù‡Ø²ÙŠÙ† Ù†Ø¨Ø¯Ø£ØŸ<br>Ø§Ø¶ØºØ· Ø²Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆÙ†Ù†Ø·Ù„Ù‚ ğŸš€"
    : "Ø¬Ø§Ù‡Ø²ÙŠÙ† Ù†Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙ†Ø§ ÙÙŠ Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§ØªØŸ<br>Ø§Ø¶ØºØ· Ø²Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆÙ†Ù†Ø·Ù„Ù‚ ğŸš€";
}

async function startApp(){
  try{ await playWelcome(); }catch(e){}
  $("startOverlay").style.display="none";

  if(IS_STUDENT_MODE){
    go("studentLoginPage");
    $("stuName").value="";
    $("stuPin").value="";
    return;
  }
  go("teacherLoginPage");
}

$("startBtn").addEventListener("click", startApp);

// ===== Teacher login =====
function forgotTeacher(){
  const subject=encodeURIComponent("Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø®ÙˆÙ„ Ù…ØµØ±Ù Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª");
  const body=encodeURIComponent("Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…ØŒ\nØ£Ø±ØºØ¨ Ø¨Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù…ØµØ±Ù Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª.\nØ´ÙƒØ±Ø§Ù‹.");
  window.location.href=`mailto:as-soso-as2011@hotmail.com?subject=${subject}&body=${body}`;
}

function teacherLogin(){
  if($("tu").value.trim()==="teacher" && $("tp").value.trim()==="12345"){
    loadClasses().then(()=>go("classesPage"));
  } else warn("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
}

// ===== Teacher classes/students (Ù…Ø®ØªØµØ±) =====
let classes=[], currentClassId=null, currentStudentId=null;

async function loadClasses(){
  const snap = await db.collection("classes").orderBy("order").get();
  classes=[]; snap.forEach(d=>classes.push({id:d.id,...d.data()}));
  if(!classes.length){
    // seed minimal
    await db.collection("classes").add({name:"Ø§Ù„ØµÙ Ø³Ø§Ø¯Ø³ Ø¨Ù†ÙŠÙ†",order:1});
    await db.collection("classes").add({name:"Ø§Ù„ØµÙ Ø³Ø§Ø¯Ø³ Ø¨Ù†Ø§Øª",order:2});
    await db.collection("classes").add({name:"Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø·",order:3});
    return loadClasses();
  }
  if(!currentClassId) currentClassId = classes[0].id;
  renderTabs();
}

function renderTabs(){
  const tabs=$("classTabs"); tabs.innerHTML="";
  classes.forEach(c=>{
    const t=document.createElement("div");
    t.className="tab"+(c.id===currentClassId?" active":"");
    t.textContent=c.name;
    t.onclick=()=>{ currentClassId=c.id; renderTabs(); };
    tabs.appendChild(t);
  });
}

async function openClassPage(){
  go("classPage");
  const cls = classes.find(x=>x.id===currentClassId);
  $("classTitle").textContent = cls ? cls.name : "Ø§Ù„ÙØµÙ„";
  await renderStudents();
}

function backToClasses(){ go("classesPage"); renderTabs(); }

async function renderStudents(){
  const snap = await db.collection("students").where("classId","==",currentClassId).get();
  const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
  arr.sort((a,b)=>(a.name||"").localeCompare(b.name||"","ar"));

  const grid=$("studentsGrid"); grid.innerHTML="";
  if(!arr.length){
    grid.innerHTML = `<div class="card">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„ Ø¨Ø¹Ø¯.</div>`;
    return;
  }

  arr.forEach(s=>{
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <strong>${s.name||""}</strong>
      <div class="small">Ø§Ù„Ø±ØµÙŠØ¯: ${fmt(s.balance)} Ø±.Ø³</div>
      <div class="small">PIN: <b>${s.pin||""}</b></div>
      <span class="badge ${s.active?'on':'off'}">${s.active?'ğŸŸ¢ Ù…ÙØ¹Ù„':'ğŸ”´ Ù…Ù‚ÙÙ„'}</span>
      <div class="row" style="margin-top:8px">
        <button class="btn2 col">ÙØªØ­ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
      </div>
    `;
    card.querySelector("button").onclick=()=>{
      currentStudentId = s.id;
      // Ø§Ù„Ù…Ø¹Ù„Ù…Ø© ØªÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© (Ù„Ø§ ØªØ­ØªØ§Ø¬ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…)
      go("studentLoginPage");
      $("stuName").value = s.name||"";
      $("stuName").readOnly = true;
      $("stuPin").value = "";
    };
    grid.appendChild(card);
  });
}

// ===== Student login (Ø¹Ø§Ù… + Ø£Ùˆ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„Ù…Ø©) =====
async function forgotStudentPin(){
  warn("Ù…ÙŠØ²Ø© Ø§Ø³ØªØ±Ø¬Ø§Ø¹ PIN Ø¹Ù†Ø¯ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù†Ø³Ø®ØªÙƒ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©. Ø¥Ø°Ø§ ØªØ¨ÙŠÙ† Ø£Ø¯Ù…Ø¬Ù‡Ø§ Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ù…Ø§ Ù†Ø«Ø¨Øª Ø§Ù„Ø¯Ø®ÙˆÙ„.");
}

async function studentLogin(){
  try{
    const pin = ($("stuPin").value||"").trim();

    // Ø­Ø§Ù„Ø© Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„Ù…Ø© (currentStudentId Ù…Ø¹Ø±ÙˆÙ + Ø§Ø³Ù… readonly)
    if(currentStudentId && $("stuName").readOnly){
      const ref=db.collection("students").doc(currentStudentId);
      const doc=await ref.get();
      const s=doc.data()||{};
      if(!s.active){ warn("Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù‚ÙÙ„ Ù…Ø¤Ù‚ØªÙ‹Ø§"); return; }
      if(String(s.pin||"")!==String(pin)){ warn("Ø±Ù‚Ù… Ø§Ù„Ù€ PIN ØºÙŠØ± ØµØ­ÙŠØ­"); return; }
      await openStudentAccount(currentStudentId, s);
      return;
    }

    // Ø­Ø§Ù„Ø© Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¹Ø§Ù… (Ø§Ø³Ù… + PIN)
    const name = ($("stuName").value||"").trim();
    if(!name || !pin){ warn("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù€ PIN"); return; }

    const snap = await db.collection("students").where("name","==",name).limit(1).get();
    if(snap.empty){ warn("Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø§ÙƒØªØ¨Ù‡ Ù…Ø«Ù„ Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…"); return; }

    const doc = snap.docs[0];
    const s = doc.data()||{};
    currentStudentId = doc.id;

    if(!s.active){ warn("Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù‚ÙÙ„ Ù…Ø¤Ù‚ØªÙ‹Ø§"); return; }
    if(String(s.pin||"")!==String(pin)){ warn("Ø±Ù‚Ù… Ø§Ù„Ù€ PIN ØºÙŠØ± ØµØ­ÙŠØ­"); return; }

    await openStudentAccount(currentStudentId, s);

  }catch(e){
    console.log(e);
    warn("ØµØ§Ø± Ø®Ø·Ø£â€¦ Ø­Ø¯Ù‘Ø« Ø§Ù„ØµÙØ­Ø© ÙˆØ¬Ø±Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©");
  }
}

// ===== Student account =====
async function openStudentAccount(id, s){
  try{ await playWelcome(); }catch(e){}
  go("studentAccountPage");

  $("studentHeader").textContent = s.name||"";
  $("statusBadge").className = "badge " + (s.active ? "on" : "off");
  $("statusBadge").textContent = s.active ? "ğŸŸ¢ Ù†Ø´Ø·" : "ğŸ”´ Ù…Ù‚ÙÙ„";
  $("studentBalance").textContent = fmt(s.balance);

  await buildTransferList(id);
  await showStatement(id);
}

async function buildTransferList(id){
  const snap=await db.collection("students").get();
  const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
  arr.sort((a,b)=>(a.name||"").localeCompare(b.name||"","ar"));
  $("transferTo").innerHTML="";
  arr.forEach(s=>{
    if(s.id===id) return;
    const o=document.createElement("option");
    o.value=s.id; o.textContent=s.name||"";
    $("transferTo").appendChild(o);
  });
}

async function showStatement(id){
  const rows=$("stmtRows"); rows.innerHTML="";
  const snap = await db.collection("students").doc(id).collection("txns")
    .orderBy("createdAtClient","desc").limit(30).get();

  if(snap.empty){
    rows.innerHTML = `<tr><td colspan="4" class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø¹Ø¯.</td></tr>`;
    return;
  }

  snap.forEach(d=>{
    const x=d.data()||{};
    const t = x.createdAtClient ? new Date(x.createdAtClient).toLocaleString("ar-SA") : "";
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${t}</td><td>${x.type||""}</td><td>${fmt(x.amount)}</td><td>${fmt(x.balanceAfter)}</td>`;
    rows.appendChild(tr);
  });
}

async function logTxn(ref, type, amount, balanceAfter){
  const dateKey = new Date().toISOString().slice(0,10);
  const createdAtClient = Date.now();
  await ref.collection("txns").add({
    type,
    amount,
    balanceAfter,
    dateKey,
    createdAtClient,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
}

async function executeOp(){
  try{
    const op = $("op").value;
    const amt = parseFloat($("amt").value);
    if(isNaN(amt) || amt<=0){ warn("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­"); return; }

    const ref = db.collection("students").doc(currentStudentId);
    const doc = await ref.get();
    const s = doc.data()||{};
    let bal = Number(s.balance||0);

    if(op==="deposit"){
      bal = bal + amt;
      await ref.update({balance:bal});
      await logTxn(ref,"Ø¥ÙŠØ¯Ø§Ø¹",amt,bal);
    }
    else if(op==="withdraw"){
      if(bal < amt){ warn("Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ø§ ÙŠÙƒÙÙŠ"); return; }
      bal = bal - amt;
      await ref.update({balance:bal});
      await logTxn(ref,"Ø³Ø­Ø¨",amt,bal);
    }
    else if(op==="transfer"){
      if(bal < amt){ warn("Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ø§ ÙŠÙƒÙÙŠ Ù„Ù„ØªØ­ÙˆÙŠÙ„"); return; }
      const toId = $("transferTo").value;
      if(!toId){ warn("Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨ Ù„Ù„ØªØ­ÙˆÙŠÙ„"); return; }

      const toRef = db.collection("students").doc(toId);
      const toDoc = await toRef.get();
      const to = toDoc.data()||{};
      const toBal = Number(to.balance||0);

      const batch = db.batch();
      batch.update(ref,{balance:bal-amt});
      batch.update(toRef,{balance:toBal+amt});
      await batch.commit();

      await logTxn(ref,"ØªØ­ÙˆÙŠÙ„",amt,bal-amt);
      await logTxn(toRef,"ØªØ­ÙˆÙŠÙ„ ÙˆØ§Ø±Ø¯",amt,toBal+amt);

      bal = bal-amt;
    }

    $("studentBalance").textContent = fmt(bal);
    $("amt").value="";
    await showStatement(currentStudentId);

  }catch(e){
    console.log(e);
    warn("ØµØ§Ø± Ø®Ø·Ø£â€¦ Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©");
  }
}

// ===== Initial UI text based on mode =====
document.addEventListener("DOMContentLoaded", ()=>{
  if(IS_STUDENT_MODE){
    $("startText").innerHTML = "Ù‡Ø°Ø§ Ø±Ø§Ø¨Ø· Ø§Ù„Ø·Ù„Ø§Ø¨ âœ…<br>Ø§Ø¶ØºØ· Ø²Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø«Ù… Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ùˆ PIN";
  }else{
    $("startText").innerHTML = "Ù‡Ø°Ø§ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¹Ù„Ù…Ø© âœ…<br>Ø§Ø¶ØºØ· Ø²Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø«Ù… Ø³Ø¬Ù‘Ù„ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„";
  }
});
</script>

</body>
</html>
