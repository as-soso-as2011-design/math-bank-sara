<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Math Bank - ุจูู ุงูุฑูุงุถูุงุช</title>
<style>
  :root{
    --navy:#041a3a;
    --navy2:#082a5a;
    --sky:#EAF3FB;
    --sky2:#CFE6F7;
    --card:#ffffff;
    --text:#132033;
    --muted:#6b7a90;
    --green:#2e7d32;
    --red:#b00020;
    --shadow:0 16px 40px rgba(0,0,0,.18);
    --r:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: Tahoma, Arial, sans-serif;
    color:var(--text);
    background:
      radial-gradient(900px 500px at 50% 20%, rgba(255,255,255,.12), transparent 60%),
      radial-gradient(700px 500px at 50% 40%, rgba(255,255,255,.10), transparent 60%),
      linear-gradient(180deg, var(--navy) 0%, #06102a 100%);
    min-height:100vh;
    overflow-x:hidden;
  }
  a{color:inherit}

  /* ---------- helpers ---------- */
  .hidden{display:none !important}
  .fadeOut{opacity:0; pointer-events:none; transform: translateY(-8px); transition:opacity .35s ease, transform .35s ease;}
  .btn{
    border:0;
    padding:12px 16px;
    border-radius:14px;
    font-weight:800;
    cursor:pointer;
    background:#0d4fd6;
    color:#fff;
    box-shadow:0 10px 18px rgba(0,0,0,.20);
  }
  .btn:active{transform:scale(.99)}
  .btn.secondary{background:rgba(255,255,255,.12); box-shadow:none}
  .btn.green{background:var(--green)}
  .btn.red{background:var(--red)}
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px;
    border-radius:999px;
    font-weight:800;
    background:rgba(255,255,255,.10);
    color:#fff;
    border:1px solid rgba(255,255,255,.14);
  }

  /* ---------- intro (splash) ---------- */
  #intro{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    padding:28px 18px;
    z-index:9999;
    background:
      radial-gradient(900px 500px at 50% 20%, rgba(255,255,255,.12), transparent 60%),
      linear-gradient(180deg, var(--navy) 0%, #06102a 100%);
  }
  .introWrap{
    width:min(920px, 100%);
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:18px;
    align-items:center;
  }
  .introLogoBox{
    display:flex; justify-content:flex-end;
  }
  .logoCard{
    width:min(320px, 70vw);
    aspect-ratio: 1/1;
    border-radius:26px;
    background:rgba(255,255,255,.10);
    border:1px solid rgba(255,255,255,.16);
    box-shadow: var(--shadow);
    display:flex; align-items:center; justify-content:center;
    overflow:hidden;
    transform: translateX(120%);
    animation: logoIn 1.1s ease forwards;
  }
  .logoCard img{width:86%; height:auto; display:block; filter: drop-shadow(0 12px 18px rgba(0,0,0,.25));}
  @keyframes logoIn{
    0%{transform:translateX(120%); opacity:0}
    100%{transform:translateX(0); opacity:1}
  }
  .introTextBox{
    color:#fff;
    text-align:right;
  }
  .titleRow{
    font-size: clamp(30px, 4.2vw, 52px);
    font-weight: 900;
    letter-spacing:.5px;
    transform: translateX(-120%);
    opacity:0;
    animation: textIn 1.1s ease .05s forwards;
  }
  .subRow{
    margin-top:10px;
    font-size: clamp(14px, 2.2vw, 20px);
    color:rgba(255,255,255,.82);
    transform: translateX(-120%);
    opacity:0;
    animation: textIn 1.1s ease .16s forwards;
  }
  .loadingRow{
    margin-top:14px;
    font-size:14px;
    color:rgba(255,255,255,.65);
    transform: translateX(-120%);
    opacity:0;
    animation: textIn 1.1s ease .26s forwards, pulse 1.1s ease-in-out .9s infinite;
  }
  @keyframes textIn{
    0%{transform:translateX(-120%); opacity:0}
    100%{transform:translateX(0); opacity:1}
  }
  @keyframes pulse{
    0%,100%{opacity:.55}
    50%{opacity:1}
  }
  @media (max-width: 740px){
    .introWrap{grid-template-columns:1fr; text-align:center}
    .introLogoBox{justify-content:center}
    .introTextBox{text-align:center}
  }

  /* ---------- app container ---------- */
  #app{
    min-height:100vh;
    padding:18px 14px 40px;
  }
  .topbar{
    width:min(1100px,100%);
    margin:0 auto 14px;
    background:linear-gradient(90deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    border:1px solid rgba(255,255,255,.12);
    border-radius:20px;
    padding:14px 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    color:#fff;
  }
  .brand{
    display:flex; align-items:center; gap:12px;
  }
  .brand img{
    width:46px; height:46px; border-radius:14px;
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.12);
    padding:6px;
  }
  .brand .t1{font-weight:900}
  .brand .t2{font-size:12px; color:rgba(255,255,255,.75); margin-top:2px}

  .container{
    width:min(1100px,100%);
    margin:0 auto;
  }
  .card{
    background:rgba(255,255,255,.94);
    border:1px solid rgba(255,255,255,.55);
    border-radius:22px;
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .cardPad{padding:18px}
  .hero{
    background: linear-gradient(180deg, rgba(12,70,170,.12), rgba(255,255,255,.00));
  }
  .hero h2{margin:0 0 8px; font-size:22px}
  .hero p{margin:0 0 16px; color:var(--muted); line-height:1.7}
  .grid2{
    display:grid; grid-template-columns: 1.1fr .9fr;
    gap:14px;
  }
  @media (max-width:900px){ .grid2{grid-template-columns:1fr} }

  .field label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
  .field input, .field select, .field textarea{
    width:100%;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid #d7e1ef;
    background:#fff;
    font-size:15px;
    outline:none;
  }
  .field textarea{min-height:92px; resize:vertical}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .row > *{flex:1}
  .sep{height:1px; background:#e7eef8; margin:14px 0}

  /* operations list */
  .opsList{display:flex; flex-direction:column; gap:10px}
  .opItem{
    border:1px solid #e0e8f6;
    border-radius:18px;
    padding:12px;
    background:#fff;
  }
  .opHead{
    display:flex; justify-content:space-between; align-items:center; gap:10px;
    flex-wrap:wrap;
  }
  .opTitle{font-weight:900}
  .opMeta{font-size:12px; color:var(--muted)}
  .opBody{margin-top:10px; color:#2b3b54; line-height:1.7}
  .opActions{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap}

  /* small note */
  .note{
    font-size:12px;
    color:rgba(255,255,255,.78);
    line-height:1.6;
    margin-top:8px;
  }
</style>
</head>
<body>

<!-- Intro -->
<section id="intro" aria-label="Intro">
  <div class="introWrap">
    <div class="introLogoBox">
      <div class="logoCard">
        <img id="introLogo" src="logo.png" alt="logo">
      </div>
    </div>
    <div class="introTextBox">
      <div class="titleRow">MATH BANK</div>
      <div class="subRow">ุงููุนููุฉ ุณุงุฑุฉ ุญููู</div>
      <div class="loadingRow">ุฌุงุฑู ุชุฌููุฒ ุงููุธุงูโฆ</div>
      <div class="note">ุฅุฐุง ุจููุช ูุฐู ุงูุดุงุดุฉ: ุชุฃูุฏู ุฃู ุงููููุงุช ูู ููุณ ุงููุฌูุฏ (logo.png) ุซู ุญุฏุซู ุงูุตูุญุฉ.</div>
    </div>
  </div>
</section>

<!-- App -->
<main id="app" class="hidden">
  <header class="topbar">
    <div class="brand">
      <img src="logo.png" alt="Math Bank">
      <div>
        <div class="t1">ุจูู ุงูุฑูุงุถูุงุช โ ุงููุตุฑูู ูููุนููุฉ ุณุงุฑุฉ ุญููู</div>
        <div class="t2">ูุฏุฑุณุฉ ุฑูุงุฏ ุงูุดุฑู ุงูุฃูููุฉ</div>
      </div>
    </div>
    <div class="row" style="gap:8px; justify-content:flex-end">
      <span class="pill" id="modePill">ูุถุน ุงูุทุงูุจ</span>
      <button class="btn secondary" id="switchModeBtn" type="button">ุชุจุฏูู ุงููุถุน</button>
    </div>
  </header>

  <div class="container">

    <!-- Start page -->
    <section id="startPage" class="card hero">
      <div class="cardPad">
        <h2 id="helloLine">ููุง ูุงููู ๐</h2>
        <p>ุฌุงูุฒูู ููุทูู ุฑุญูุชูุง ูุน ุจูู ุงูุฑูุงุถูุงุชุ</p>
        <div class="row" style="justify-content:flex-start">
          <button class="btn green" id="startBtn" type="button">ุงุจุฏุฃ</button>
          <button class="btn secondary" id="muteBtn" type="button">ูุชู ุงูุตูุช</button>
        </div>
      </div>
    </section>

    <div style="height:14px"></div>

    <!-- Login page -->
    <section id="loginPage" class="card hidden">
      <div class="cardPad">
        <h2 style="margin:0 0 8px">ุชุณุฌูู ุงูุฏุฎูู</h2>
        <p style="margin:0 0 14px; color:var(--muted)">ุงุฎุชุงุฑู ุงููุถุน ุซู ุฃุฏุฎูู ุงูุจูุงูุงุช.</p>

        <div class="grid2">
          <div>
            <div class="field">
              <label>ุงูุงุณู / ุงููุณุชุฎุฏู</label>
              <input id="username" placeholder="ูุซุงู: ุณุงูู ุขู ูุฎูุต" autocomplete="off">
            </div>
            <div class="sep"></div>
            <div class="field">
              <label>ุงูุฑูู ุงูุณุฑู</label>
              <input id="pin" inputmode="numeric" placeholder="****" autocomplete="off">
            </div>

            <div class="sep"></div>

            <div class="row">
              <button class="btn" id="loginBtn" type="button">ุฏุฎูู</button>
              <button class="btn secondary" id="backToStartBtn" type="button">ุฑุฌูุน</button>
            </div>

            <div style="margin-top:10px; color:var(--muted); font-size:12px">
              ููุงุญุธุฉ: ุงูุนูููุงุช ุงูููููุฉ ุชุธูุฑ ุฏุงุฎู <b>ููุญุฉ ุงููุนููุฉ ููุท</b>.
            </div>
          </div>

          <div class="card" style="background:#fff; border:1px solid #e7eef8">
            <div class="cardPad">
              <h3 style="margin:0 0 10px">ุชูููุญ ุณุฑูุน</h3>
              <ul style="margin:0; padding:0 18px; line-height:1.9; color:#2b3b54">
                <li>ุงูุทุงูุจ: ูุทููุน ุนูู ุตูุญุชู ููุท (ูููุฐุฌ ูุจุฏุฆู).</li>
                <li>ุงููุนููุฉ: ุชุณุฌูู ุนูููุงุช ููููุฉ ูุชุตุฏุฑ ุฑุณุงูุฉ ูุงุชุณุงุจ ุฌุงูุฒุฉ.</li>
                <li>ูู ุงูุจูุงูุงุช ุชุญูุธ ุฏุงุฎู ุงูุฌูุงุฒ (LocalStorage).</li>
              </ul>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- Student page (placeholder) -->
    <section id="studentPage" class="card hidden">
      <div class="cardPad">
        <h2 style="margin:0 0 8px">ุตูุญุฉ ุงูุทุงูุจ</h2>
        <p style="margin:0 0 14px; color:var(--muted)">ููุง ูุฑุจุท ูุงุญููุง ุตูุญุฉ ูู ุทุงูุจ (ุญุณุจ NFC / ุฑุงุจุท ุฎุงุต).</p>
        <div class="row">
          <button class="btn secondary" id="studentLogoutBtn" type="button">ุชุณุฌูู ุฎุฑูุฌ</button>
        </div>
      </div>
    </section>

    <!-- Teacher dashboard -->
    <section id="teacherPage" class="card hidden">
      <div class="cardPad">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
          <h2 style="margin:0">ููุญุฉ ุงููุนููุฉ</h2>
          <button class="btn secondary" id="teacherLogoutBtn" type="button">ุชุณุฌูู ุฎุฑูุฌ</button>
        </div>

        <div class="sep"></div>

        <div class="grid2">
          <!-- create operation -->
          <div class="card" style="background:#fff; border:1px solid #e7eef8">
            <div class="cardPad">
              <h3 style="margin:0 0 10px">ุฅุถุงูุฉ ุนูููุฉ ุฌุฏูุฏุฉ</h3>

              <div class="row">
                <div class="field">
                  <label>ุงูุชุงุฑูุฎ</label>
                  <input id="opDate" type="date">
                </div>
                <div class="field">
                  <label>ุงูููุช (ุชููุงุฆู)</label>
                  <input id="opTime" disabled>
                </div>
              </div>

              <div class="sep"></div>

              <div class="row">
                <div class="field">
                  <label>ุงุณู ุงูุทุงูุจ</label>
                  <input id="opStudent" placeholder="ุงุฎุชุงุฑู/ุงูุชุจู ุงุณู ุงูุทุงูุจ">
                </div>
                <div class="field">
                  <label>ููุน ุงูุนูููุฉ</label>
                  <select id="opType">
                    <option value="ุฅูุฏุงุน">ุฅูุฏุงุน</option>
                    <option value="ุณุญุจ">ุณุญุจ</option>
                    <option value="ุชุญููู">ุชุญููู</option>
                    <option value="ูุฎุงููุฉ (ุณุงูุฑ)">ูุฎุงููุฉ (ุณุงูุฑ)</option>
                  </select>
                </div>
              </div>

              <div class="sep"></div>

              <div class="row">
                <div class="field">
                  <label>ุงููุจูุบ (ุฑูุงู)</label>
                  <input id="opAmount" inputmode="numeric" placeholder="ูุซุงู: 200">
                </div>
                <div class="field">
                  <label>ุงูุณุจุจ</label>
                  <input id="opReason" placeholder="ูุซุงู: ุชูุงุนู ููุดุงุฑูุฉ ููุชุงุฒุฉ">
                </div>
              </div>

              <div class="sep"></div>

              <div class="field">
                <label>ููุงุญุธุฉ ุฅุถุงููุฉ (ุงุฎุชูุงุฑู)</label>
                <textarea id="opNote" placeholder="ุงูุชุจู ุฃู ุชูุงุตููโฆ"></textarea>
              </div>

              <div class="sep"></div>

              <div class="row">
                <button class="btn green" id="saveOpBtn" type="button">ุญูุธ ุงูุนูููุฉ</button>
                <button class="btn" id="saveAndWhatsBtn" type="button">ุญูุธ + ูุชุญ ูุงุชุณุงุจ</button>
              </div>

              <div style="margin-top:10px; font-size:12px; color:var(--muted)">
                * ุนูุฏ ุงูุญูุธ: ุชูุญูุธ ุงูุนูููุฉ ุชููุงุฆููุง ุชุญุช ุงูุชุงุฑูุฎ ุงููุญุฏุฏ ูุชุธูุฑ ูู "ุนุฑุถ ุงูุนูููุงุช".
              </div>
            </div>
          </div>

          <!-- view operations -->
          <div class="card" style="background:#fff; border:1px solid #e7eef8">
            <div class="cardPad">
              <h3 style="margin:0 0 10px">ุนุฑุถ ุงูุนูููุงุช ุจุชุงุฑูุฎ</h3>

              <div class="row">
                <div class="field" style="flex:1.2">
                  <label>ุงุฎุชุฑ ุงูุชุงุฑูุฎ</label>
                  <input id="viewDate" type="date">
                </div>
                <div style="display:flex; align-items:flex-end">
                  <button class="btn" id="loadOpsBtn" type="button">ุนุฑุถ ุงูุนูููุงุช</button>
                </div>
              </div>

              <div class="sep"></div>

              <div id="opsWrap" class="opsList">
                <div style="color:var(--muted); font-size:14px">ุงุฎุชุงุฑู ุชุงุฑูุฎ ุซู ุงุถุบุทู "ุนุฑุถ ุงูุนูููุงุช".</div>
              </div>

              <div class="sep"></div>

              <div class="row">
                <button class="btn secondary" id="exportTextBtn" type="button">ูุณุฎ ูุต ุงูุนูููุงุช</button>
              </div>

              <div style="margin-top:10px; font-size:12px; color:var(--muted)">
                ููุงุญุธุฉ: ูุงุชุณุงุจ ูุง ูุฑุณู ุชููุงุฆููุง 100%ุ ูุญู ูุฌูุฒ ุงูุฑุณุงูุฉ ูููุชุญ ูุงุชุณุงุจ ููุท.
              </div>
            </div>
          </div>

        </div>

      </div>
    </section>

  </div>
</main>

<!-- audio (ุถุนูู ุงููููุงุช ูู ุงููุณุชูุฏุน) -->
<audio id="clickSound" preload="auto">
  <source src="click.mp3" type="audio/mpeg">
</audio>
<audio id="startSound" preload="auto">
  <source src="start.mp3" type="audio/mpeg">
</audio>

<script>
/* =======================
   ุฅุนุฏุงุฏุงุช ุจุณูุทุฉ
======================= */
const TEACHER_USERNAME = "ุณุงุฑุฉ";
const TEACHER_PIN = "1234"; // ุนุฏูููุง
let isMuted = false;

const $ = (id)=>document.getElementById(id);
function todayISO(){
  const d=new Date();
  const mm=String(d.getMonth()+1).padStart(2,'0');
  const dd=String(d.getDate()).padStart(2,'0');
  return d.getFullYear()+"-"+mm+"-"+dd;
}
function timeNow(){
  const d=new Date();
  let h=d.getHours(); let m=d.getMinutes();
  return String(h).padStart(2,'0')+":"+String(m).padStart(2,'0');
}

/* =======================
   ุตูุช
======================= */
function safePlay(id){
  if(isMuted) return;
  const a=$(id);
  if(!a) return;
  try{
    a.currentTime=0;
    const p=a.play();
    if(p && typeof p.catch==="function") p.catch(()=>{});
  }catch(e){}
}
function enableClickSound(){
  document.addEventListener("click",(e)=>{
    const t=e.target;
    if(!(t instanceof HTMLElement)) return;
    if(t.closest("button,a,[role='button']")) safePlay("clickSound");
  }, {passive:true});
}

/* =======================
   ุชุฎุฒูู ุงูุนูููุงุช (ูุญูู)
======================= */
function keyForDate(dateISO){ return "MB_OPS_"+dateISO; }

function loadOps(dateISO){
  try{
    const raw=localStorage.getItem(keyForDate(dateISO));
    if(!raw) return [];
    const arr=JSON.parse(raw);
    return Array.isArray(arr)? arr : [];
  }catch(e){ return []; }
}
function saveOps(dateISO, ops){
  localStorage.setItem(keyForDate(dateISO), JSON.stringify(ops));
}
function addOp(dateISO, op){
  const ops=loadOps(dateISO);
  ops.unshift(op); // ุงูุฃุญุฏุซ ุฃูู
  saveOps(dateISO, ops);
  return ops;
}

/* =======================
   ูุงุชุณุงุจ
======================= */
function buildWhatsAppMessage(op){
  const lines = [];
  lines.push("ุจูู ุงูุฑูุงุถูุงุช โ ุฅุดุนุงุฑ ุนูููุฉ");
  lines.push("ุงูุทุงูุจ/ุฉ: " + op.student);
  lines.push("ุงูุนูููุฉ: " + op.type);
  if(op.amount) lines.push("ุงููุจูุบ: " + op.amount + " ุฑูุงู");
  if(op.reason) lines.push("ุงูุณุจุจ: " + op.reason);
  if(op.note) lines.push("ููุงุญุธุฉ: " + op.note);
  lines.push("ุงูุชุงุฑูุฎ: " + op.date + "  |  ุงูููุช: " + op.time);
  lines.push("โ");
  lines.push("ุงููุนููุฉ: ุณุงุฑุฉ ุญููู");
  return lines.join("\n");
}
function openWhatsApp(text){
  const url = "https://wa.me/?text=" + encodeURIComponent(text);
  window.open(url, "_blank");
}

/* =======================
   ุชูููู ุงูุตูุญุงุช
======================= */
function show(pageId){
  const pages=["startPage","loginPage","studentPage","teacherPage"];
  pages.forEach(id=>$(id).classList.toggle("hidden", id!==pageId));
}
function setMode(mode){ // "student" | "teacher"
  $("modePill").textContent = (mode==="teacher") ? "ูุถุน ุงููุนููุฉ" : "ูุถุน ุงูุทุงูุจ";
  $("switchModeBtn").textContent = (mode==="teacher") ? "ุงูุฐูุงุจ ููุถุน ุงูุทุงูุจ" : "ุงูุฐูุงุจ ููุถุน ุงููุนููุฉ";
  localStorage.setItem("MB_MODE", mode);
}
function getMode(){ return localStorage.getItem("MB_MODE") || "student"; }

/* =======================
   Intro -> Start
======================= */
function finishIntro(){
  const intro=$("intro");
  if(!intro) return;
  intro.classList.add("fadeOut");
  setTimeout(()=>{
    intro.remove();
    $("app").classList.remove("hidden");
    show("startPage");
  }, 420);
}
function runIntro(){
  // ุถูุงู ุงูุงูุชูุงู ุญุชู ูู ุชุนุทู ุดูุก
  setTimeout(finishIntro, 2200);
  setTimeout(finishIntro, 5000);
}

/* =======================
   Teacher UI
======================= */
function renderOps(dateISO){
  const wrap=$("opsWrap");
  const ops=loadOps(dateISO);
  wrap.innerHTML="";
  if(!ops.length){
    wrap.innerHTML = '<div style="color:var(--muted);font-size:14px">ูุง ุชูุฌุฏ ุนูููุงุช ููุฐุง ุงูุชุงุฑูุฎ.</div>';
    return;
  }
  ops.forEach((op, idx)=>{
    const div=document.createElement("div");
    div.className="opItem";
    div.innerHTML = `
      <div class="opHead">
        <div>
          <div class="opTitle">${op.student} โข ${op.type}</div>
          <div class="opMeta">${op.date} โ ${op.time}${op.amount? " โข "+op.amount+" ุฑูุงู":""}</div>
        </div>
        <div class="row" style="gap:8px; flex:0 0 auto">
          <button class="btn secondary" type="button" data-act="copy" data-i="${idx}">ูุณุฎ</button>
          <button class="btn" type="button" data-act="wa" data-i="${idx}">ูุงุชุณุงุจ</button>
          <button class="btn red" type="button" data-act="del" data-i="${idx}">ุญุฐู</button>
        </div>
      </div>
      <div class="opBody">
        ${op.reason? "<div><b>ุงูุณุจุจ:</b> "+escapeHtml(op.reason)+"</div>":""}
        ${op.note? "<div><b>ููุงุญุธุฉ:</b> "+escapeHtml(op.note)+"</div>":""}
      </div>
    `;
    wrap.appendChild(div);
  });

  wrap.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const i = Number(btn.getAttribute("data-i"));
      const act = btn.getAttribute("data-act");
      const opsNow = loadOps(dateISO);
      const op = opsNow[i];
      if(!op) return;

      if(act==="copy"){
        navigator.clipboard?.writeText(buildWhatsAppMessage(op)).catch(()=>{});
      }else if(act==="wa"){
        openWhatsApp(buildWhatsAppMessage(op));
      }else if(act==="del"){
        opsNow.splice(i,1);
        saveOps(dateISO, opsNow);
        renderOps(dateISO);
      }
    });
  });
}
function exportOpsText(dateISO){
  const ops=loadOps(dateISO);
  if(!ops.length) return "ูุง ุชูุฌุฏ ุนูููุงุช ูู ูุฐุง ุงูุชุงุฑูุฎ.";
  const lines=[];
  lines.push("ุนูููุงุช ุจูู ุงูุฑูุงุถูุงุช ุจุชุงุฑูุฎ: " + dateISO);
  lines.push("โ");
  ops.slice().reverse().forEach(op=>{
    lines.push(buildWhatsAppMessage(op));
    lines.push("โ");
  });
  return lines.join("\n");
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

/* =======================
   ุฃุญุฏุงุซ
======================= */
document.addEventListener("DOMContentLoaded", ()=>{
  enableClickSound();

  // intro
  runIntro();

  // default values
  $("opDate").value = todayISO();
  $("viewDate").value = todayISO();
  $("opTime").value = timeNow();
  setInterval(()=>{ $("opTime").value = timeNow(); }, 15*1000);

  // mode
  setMode(getMode());

  $("switchModeBtn").addEventListener("click", ()=>{
    const next = (getMode()==="teacher") ? "student" : "teacher";
    setMode(next);
    show("startPage");
  });

  // start
  $("muteBtn").addEventListener("click", ()=>{
    isMuted = !isMuted;
    $("muteBtn").textContent = isMuted ? "ุชุดุบูู ุงูุตูุช" : "ูุชู ุงูุตูุช";
  });

  $("startBtn").addEventListener("click", ()=>{
    safePlay("startSound");
    // ุงูุชููู ูุตูุญุฉ ุงูุฏุฎูู ูุจุงุดุฑุฉ
    show("loginPage");
  });

  $("backToStartBtn").addEventListener("click", ()=> show("startPage"));

  // login
  $("loginBtn").addEventListener("click", ()=>{
    const mode = getMode();
    const u = ($("username").value || "").trim();
    const p = ($("pin").value || "").trim();

    if(mode==="teacher"){
      if(u===TEACHER_USERNAME && p===TEACHER_PIN){
        show("teacherPage");
        renderOps($("viewDate").value);
      }else{
        alert("ุจูุงูุงุช ุงููุนููุฉ ุบูุฑ ุตุญูุญุฉ.");
      }
      return;
    }

    // student placeholder
    if(!u || !p){
      alert("ุฃุฏุฎูู ุงูุงุณู ูุงูุฑูู ุงูุณุฑู.");
      return;
    }
    show("studentPage");
  });

  $("studentLogoutBtn").addEventListener("click", ()=> show("startPage"));
  $("teacherLogoutBtn").addEventListener("click", ()=> show("startPage"));

  // teacher actions
  $("saveOpBtn").addEventListener("click", ()=>{
    const date = $("opDate").value || todayISO();
    const op = {
      date,
      time: timeNow(),
      student: ($("opStudent").value||"").trim() || "ุบูุฑ ูุญุฏุฏ",
      type: $("opType").value,
      amount: ($("opAmount").value||"").trim(),
      reason: ($("opReason").value||"").trim(),
      note: ($("opNote").value||"").trim()
    };
    addOp(date, op);
    $("viewDate").value = date;
    renderOps(date);
    alert("ุชู ุญูุธ ุงูุนูููุฉ โ");
  });

  $("saveAndWhatsBtn").addEventListener("click", ()=>{
    const date = $("opDate").value || todayISO();
    const op = {
      date,
      time: timeNow(),
      student: ($("opStudent").value||"").trim() || "ุบูุฑ ูุญุฏุฏ",
      type: $("opType").value,
      amount: ($("opAmount").value||"").trim(),
      reason: ($("opReason").value||"").trim(),
      note: ($("opNote").value||"").trim()
    };
    addOp(date, op);
    $("viewDate").value = date;
    renderOps(date);
    openWhatsApp(buildWhatsAppMessage(op));
  });

  $("loadOpsBtn").addEventListener("click", ()=> renderOps($("viewDate").value));

  $("exportTextBtn").addEventListener("click", ()=>{
    const date = $("viewDate").value || todayISO();
    const text = exportOpsText(date);
    navigator.clipboard?.writeText(text).then(()=>alert("ุชู ูุณุฎ ุงููุต โ")).catch(()=>alert(text));
  });

  // ููู: ุจุนุถ ุงูุฃุฌูุฒุฉ ุชููุน ุชุดุบูู ุงูุตูุช ุจุฏูู ุชูุงุนูุ ูุฐูู ุฒุฑ (ุงุจุฏุฃ) ูู ุงูุฐู ูุดุบู ุงูุตูุช.
});

// pageshow: ุฅุฐุง Safari ุฃุนุงุฏ ุชุญููู ูู ุงููุงุด
window.addEventListener("pageshow", ()=>{
  // ุถูุงู ูุชุญ ุงูุชุทุจูู ุญุชู ูู ุชุนุซุฑ
  setTimeout(()=>{ if(document.getElementById("intro")) finishIntro(); }, 800);
});
</script>
</body>
</html>
